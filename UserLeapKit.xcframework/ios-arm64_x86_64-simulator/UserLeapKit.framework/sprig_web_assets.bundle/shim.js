
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="b89b5d66-bd0d-5d8b-ad53-1fa2d92c08e3")}catch(e){}}();
(function(){"use strict";var Us=Object.defineProperty;var Es=(N,K,te)=>K in N?Us(N,K,{enumerable:!0,configurable:!0,writable:!0,value:te}):N[K]=te;var E=(N,K,te)=>(Es(N,typeof K!="symbol"?K+"":K,te),te);let N;const K=new Uint8Array(16);function te(){if(!N&&(N=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!N))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return N(K)}const k=[];for(let e=0;e<256;++e)k.push((e+256).toString(16).slice(1));function Gr(e,t=0){return k[e[t+0]]+k[e[t+1]]+k[e[t+2]]+k[e[t+3]]+"-"+k[e[t+4]]+k[e[t+5]]+"-"+k[e[t+6]]+k[e[t+7]]+"-"+k[e[t+8]]+k[e[t+9]]+"-"+k[e[t+10]]+k[e[t+11]]+k[e[t+12]]+k[e[t+13]]+k[e[t+14]]+k[e[t+15]]}const ht={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function oe(e,t,r){if(ht.randomUUID&&!t&&!e)return ht.randomUUID();e=e||{};const i=e.random||(e.rng||te)();return i[6]=i[6]&15|64,i[8]=i[8]&63|128,Gr(i)}const Yr='.ul-loading-spinner-container{font-size:1.8rem;flex-grow:1;width:100%;height:100%;display:flex;align-items:center;justify-content:center}.ul-loading-spinner{display:inline-block;position:relative;width:6rem;height:6rem}.ul-loading-spinner div{box-sizing:border-box;display:block;position:absolute;width:80%;height:80%;margin:5px;border:5px solid #152e3e;border-radius:50%;animation:lds-ring 1.2s cubic-bezier(.5,0,.5,1) infinite;border-color:#152e3e transparent transparent transparent}.ul-loading-spinner .first{animation-delay:-.45s}.ul-loading-spinner .second{animation-delay:-.3s}.ul-loading-spinner .third{animation-delay:-.15s}@keyframes lds-ring{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.fade-in-transition{animation:fadeIn .4s ease-in}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}#sprig-feedback-button{border-left:0;border-radius:0 8px 8px 0;display:grid;padding:8px;text-align:center;transition:all ease-in-out 1s;z-index:inherit}#sprig-feedback-button:hover{cursor:pointer}.sprig-feedback-button-label{writing-mode:vertical-lr;text-orientation:sideways}.sprig-feedback-button-right{transform:rotate(180deg)}.sprig-feedback-button-bottom{align-self:flex-end;margin-bottom:20px}.sprig-feedback-button-light{background:#efefee;color:#000;border:1px solid #e2e3e1}.sprig-feedback-button-dark{background:#000;color:#fff;border:1px solid #000000}#sprig-feedback-container{display:flex;align-items:center;position:fixed;transition:right .2s linear,left .2s linear;z-index:2147483646}.sprig-feedback-container-left{flex-flow:row-reverse}.sprig-feedback-container-center{top:50%;transform:translateY(-50%)}.sprig-feedback-container-bottom{bottom:0%;margin-bottom:15px}.sprig-feedback-loading-container{align-items:center;background-color:#fff;border:2px solid var(--feedback-border);display:flex;max-height:90vh;max-width:90vw;min-width:0px}.sprig-feedback-loading-container-left{border-left:none;border-radius:0 8px 8px 0}.sprig-feedback-loading-container-right{border-right:none;border-radius:8px 0 0 8px}#sprig-feedback-error-container{margin:auto;text-align:center;width:360px}.sprig-feedback-error-text{font-weight:400;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol}#sprig-feedback-loading-container .ul-container{position:relative;max-height:inherit}#sprig-feedback-loading-animation{position:absolute}.sprig-feedback-loading-container-previews iframe{max-height:inherit!important}',Jr="360px",Qr=500;var Y=(e=>(e.Closed="close.click",e.Complete="survey.completed",e.FeedbackClosed="feedback.closed",e.PageChange="page.change",e.API="api",e.Override="override",e))(Y||{}),w=(e=>(e.ReplayCapture="replay.capture",e.FeedbackButtonLoaded="feedback.button.loaded",e.SDKReady="sdk.ready",e.SurveyAppeared="survey.appeared",e.SurveyClosed="survey.closed",e.SurveyDimensions="survey.dimensions",e.SurveyFadingOut="survey.fadingOut",e.SurveyHeight="survey.height",e.SurveyPresented="survey.presented",e.SurveyLifeCycle="survey.lifeCycle",e.SurveyWidth="survey.width",e.SurveyWillClose="survey.willClose",e.SurveyWillPresent="survey.will.present",e.CloseSurveyOnOverlayClick="close.survey.overlayClick",e.VisitorIDUpdated="visitor.id.updated",e.QuestionAnswered="question.answered",e))(w||{});const ve={FEEDBACK_BUTTON_LOADED:"feedback.button.loaded",SDK_READY:"sdk.ready",SURVEY_APPEARED:"survey.appeared",SURVEY_CLOSED:"survey.closed",SURVEY_DIMENSIONS:"survey.dimensions",SURVEY_FADING_OUT:"survey.fadingOut",SURVEY_HEIGHT:"survey.height",SURVEY_WIDTH:"survey.width",SURVEY_PRESENTED:"survey.presented",SURVEY_LIFE_CYCLE:"survey.lifeCycle",SURVEY_WILL_CLOSE:"survey.willClose",SURVEY_WILL_PRESENT:"survey.will.present",QUESTION_ANSWERED:"question.answered",REPLAY_CAPTURE:"replay.capture",CLOSE_SURVEY_ON_OVERLAY_CLICK:"close.survey.overlayClick",VISITOR_ID_UPDATED:"visitor.id.updated",DATA:{DISMISS_REASONS:{API:"api",CLOSED:"close.click",COMPLETE:"survey.completed",PAGE_CHANGE:"page.change",OVERRIDE:"override"},SURVEY_ID:"survey.id"}},Xr=300;class Zr{constructor(){E(this,"breadcrumbs",[])}getTimeStamp(){return new Date().toISOString()}addBreadcrumb(t){this.breadcrumbs.push(t),this.breadcrumbs.length>Xr&&this.breadcrumbs.shift()}debug(t,r="debug"){this.addBreadcrumb({category:r,level:"info",message:t,timestamp:this.getTimeStamp(),type:"debug"})}error(t,r={}){this.addBreadcrumb({category:"error",data:r,level:"error",message:t,timestamp:this.getTimeStamp(),type:"error"})}http(t,r){this.addBreadcrumb({category:"xhr",data:r,message:t,timestamp:this.getTimeStamp(),type:"http"})}info(t,r={}){this.addBreadcrumb({category:"info",data:r,level:"info",message:t,timestamp:this.getTimeStamp(),type:"info"})}navigation(t,r){this.addBreadcrumb({category:"navigation",data:r,message:t,timestamp:this.getTimeStamp(),type:"navigation"})}}const f=new Zr,vt=()=>{try{return window.parent.Intercom}catch{return null}},bt=[Object.freeze(Object.defineProperty({__proto__:null,disable:()=>{const e=vt();e&&(e.ul_wasVisible=!!document.querySelector("iframe.intercom-launcher-frame"),e.ul_wasVisible&&e("update",{hide_default_launcher:!0}))},enable:()=>{const e=vt();e&&(e.ul_wasVisible&&e("update",{hide_default_launcher:!1}),delete e.ul_wasVisible)}},Symbol.toStringTag,{value:"Module"}))];class en{static disable(){bt.forEach(t=>t.disable())}static enable(){bt.forEach(t=>t.enable())}}var tn=class extends Error{constructor(e,t,r){super(`Possible EventEmitter memory leak detected. ${r} ${t.toString()} listeners added. Use emitter.setMaxListeners() to increase limit`),this.emitter=e,this.type=t,this.count=r,this.name="MaxListenersExceededWarning"}},Lt=class{static listenerCount(e,t){return e.listenerCount(t)}constructor(){this.events=new Map,this.maxListeners=Lt.defaultMaxListeners,this.hasWarnedAboutPotentialMemoryLeak=!1}_emitInternalEvent(e,t,r){this.emit(e,t,r)}_getListeners(e){return Array.prototype.concat.apply([],this.events.get(e))||[]}_removeListener(e,t){const r=e.indexOf(t);return r>-1&&e.splice(r,1),[]}_wrapOnceListener(e,t){const r=(...i)=>(this.removeListener(e,r),t.apply(this,i));return Object.defineProperty(r,"name",{value:t.name}),r}setMaxListeners(e){return this.maxListeners=e,this}getMaxListeners(){return this.maxListeners}eventNames(){return Array.from(this.events.keys())}emit(e,...t){const r=this._getListeners(e);return r.forEach(i=>{i.apply(this,t)}),r.length>0}addListener(e,t){this._emitInternalEvent("newListener",e,t);const r=this._getListeners(e).concat(t);if(this.events.set(e,r),this.maxListeners>0&&this.listenerCount(e)>this.maxListeners&&!this.hasWarnedAboutPotentialMemoryLeak){this.hasWarnedAboutPotentialMemoryLeak=!0;const i=new tn(this,e,this.listenerCount(e));console.warn(i)}return this}on(e,t){return this.addListener(e,t)}once(e,t){return this.addListener(e,this._wrapOnceListener(e,t))}prependListener(e,t){const r=this._getListeners(e);if(r.length>0){const i=[t].concat(r);this.events.set(e,i)}else this.events.set(e,r.concat(t));return this}prependOnceListener(e,t){return this.prependListener(e,this._wrapOnceListener(e,t))}removeListener(e,t){const r=this._getListeners(e);return r.length>0&&(this._removeListener(r,t),this.events.set(e,r),this._emitInternalEvent("removeListener",e,t)),this}off(e,t){return this.removeListener(e,t)}removeAllListeners(e){return e?this.events.delete(e):this.events.clear(),this}listeners(e){return Array.from(this._getListeners(e))}listenerCount(e){return this._getListeners(e).length}rawListeners(e){return this.listeners(e)}},St=Lt;St.defaultMaxListeners=10;const m=new St,be=async e=>{await new Promise(t=>{setTimeout(t,e)})},It=({"userleap-platform":e})=>{var t;return((t=window.UserLeap)==null?void 0:t.forceDirectEmbed)||e!=="web"};class Ut{constructor(t){E(this,"storage");E(this,"tempStorage",{});E(this,"isStorageAvailable");try{this.storage=window[t];const r="__storage_test__";this.storage.setItem(r,r),this.storage.removeItem(r),this.isStorageAvailable=!0}catch{this.isStorageAvailable=!1}}setItem(t,r){this.isStorageAvailable&&this.storage?this.storage.setItem(t,r):this.tempStorage[t]=r}setItemObject(t,r){try{this.setItem(t,JSON.stringify(r))}catch(i){i instanceof Error&&(i.stack=t+": "+r,window.UserLeap.reportError("Failed to save to local storage",i))}}getItem(t){return this.isStorageAvailable&&this.storage?this.storage.getItem(t):this.tempStorage[t]}getItemObject(t){const r=this.getItem(t);if(r)try{return JSON.parse(r)}catch(i){i instanceof Error&&(i.stack=t+": "+r,window.UserLeap.reportError("Failed to parse local storage",i))}return{}}removeItem(t){this.isStorageAvailable&&this.storage?this.storage.removeItem(t):delete this.tempStorage[t]}clear(){this.isStorageAvailable&&this.storage?this.storage.clear():this.tempStorage={}}}const D=new Ut("sessionStorage"),x=new Ut("localStorage");class rn{constructor(t){E(this,"payload");E(this,"promise");E(this,"reject",()=>{});E(this,"resolve",()=>{});this.payload=t,this.promise=new Promise((r,i)=>{this.reject=i,this.resolve=r})}resolveRequest(t){this.resolve(t)}}const S={replay:null},nn=e=>{S.replay=e},sn=()=>{const e=[];return S.replay&&e.push("replay"),e.join(",")},on={RATELIMIT_RESET_DEFAULT:10};let Et=!1,kt="",Le=!1,_t=!1,Se=[];const an=e=>e._config&&e._config.installationMethod?e._config.installationMethod:e._gtm?"web-gtm":e._segment?"web-segment":"web-snippet",Rt=e=>{var t;(t=e==null?void 0:e.blockedURI)!=null&&t.includes(window.UserLeap._API_URL)&&(_t=!0,console.warn(`[Sprig] ${e.blockedURI} is blocked by Content-Security-Policy`))},Fe=(e="")=>{Et=!0,kt=e};function F(e={}){const t={"Content-Type":"application/json","userleap-platform":"web","x-ul-sdk-version":"2.32.10","x-ul-installation-method":an(e),"sprig-modules":sn()};if(e.envId&&(t["x-ul-environment-id"]=e.envId),e.token&&(t.Authorization="Bearer "+e.token),e.userId&&(t["x-ul-user-id"]=e.userId),e.visitorId&&(t["x-ul-visitor-id"]=e.visitorId),e.partnerAnonymousId&&(t["x-ul-anonymous-id"]=e.partnerAnonymousId),e.mobileHeadersJSON){const r=JSON.parse(e.mobileHeadersJSON);Object.assign(t,r)}return e.locale&&(t["accept-language"]=e.locale),window.previewMode&&(t["x-ul-preview-mode"]="1"),t}const Dt=async({shouldDropOnRateLimit:e,...t})=>{if(e)return{status:429};{const r=new rn(t);return Se.push(r),r.promise}},re=async(e,t)=>{const{retries:r=0,shouldDropOnRateLimit:i=!1,shouldRetryRequest:n=!1,...s}=t,o={url:e,options:s,retries:r,shouldDropOnRateLimit:i};if(Le&&!n)return Dt(o);const a={ok:!1,reportError:!1};if(Et)return console.info(`UserLeap - ${kt}`),a;try{const d=await fetch(e,s);if(d.status===429)if(!Le&&!i||n){Le=!0;const c=d.headers.has("ratelimit-reset")?Number(d.headers.get("ratelimit-reset")):on.RATELIMIT_RESET_DEFAULT;return await be(c*1e3),re(e,{...s,shouldDropOnRateLimit:i,shouldRetryRequest:!0})}else return Dt(o);if(Le=!1,Se.length&&(Se.map(u=>{const c=u.payload;re(c.url,{...c.options,retries:c.retries,shouldDropOnRateLimit:c.shouldDropOnRateLimit}).then(l=>{u.resolveRequest(l)})}),Se=[]),d.ok){if(d.status===249)return Fe(),a;const u=await d.text();try{return u&&u!=="OK"&&(d.json=JSON.parse(u)),d}catch{return{ok:!1,reportError:!1,error:new Error(`failed parsing response json for ${e} - ${u}`)}}}return d}catch(d){const u=r+1;return u>5||_t?{ok:!1,reportError:!1,error:d}:(await be(Math.pow(2,r)*1e3),re(e,{...s,retries:u}))}},Ct="ul-view-sdk-script",dn=["ios","android"],J="visitors",Q="environments";async function H(e,t){var s,o,a;const{shouldDropOnRateLimit:r,...i}=t;i.headers=Object.assign(F(window.UserLeap),i.headers);const n=await re(e,{...i,shouldDropOnRateLimit:r});if(n.ok){const d=(s=n.headers)==null?void 0:s.get("Authorization"),u=d?d.split(" "):void 0,c=u&&u.length===2?u[1]:void 0,l=(o=n.headers)==null?void 0:o.get("x-ul-visitor-id");if(window.UserLeap.userId&&l===window.UserLeap.visitorId){const g=x.getItemObject("sprig.anon.env.vid.map");g&&g[window.UserLeap.envId]===l&&(delete g[window.UserLeap.envId],x.setItemObject("sprig.anon.env.vid.map",g))}c&&l&&(l!==window.UserLeap.visitorId||window.UserLeap.token!==c)&&(A("token",c),A("vid",l),m.emit(w.VisitorIDUpdated,{visitorId:l}),window.UserLeap.token=c,window.UserLeap.visitorId=l)}return(a=n.json)!=null&&a.logMessage&&console.warn(`[Sprig] ${n.json.logMessage}`),n}function A(e,t){const r=x.getItemObject("userleap.ids");let i=r[window.UserLeap.envId];i?i[e]=t:i={[e]:t},r[window.UserLeap.envId]=i,x.setItemObject("userleap.ids",r)}function He(){return window.previewMode?"0":window.UserLeap.visitorId??""}function B(e,t,r){const i=[window.UserLeap._API_URL,"sdk",e];return t&&t.forEach(n=>{i.push(n),n===Q?i.push(window.UserLeap.envId):n===J&&i.push(He())}),r&&i.push(r),i.join("/")}const cn=()=>{const e=F(window.UserLeap),t=le(e),r=window.UserLeap.forceDirectEmbed,i=e["userleap-platform"]==="web";return t||r&&i},ce=async(e,t)=>{var $r,qr,zr;const{context:r,delay:i,forceBrandedLogo:n,endCard:s,isFeedback:o=!1,heatmap:a,locale:d,previewMode:u,productConfig:c,questions:l,responseGroupUid:g,surveyId:p,uuid:y,vid:U,sessionReplay:P,studyType:_}=e,L=F(window.UserLeap),ee=le(L),se=Ie(L);if(P)if(ee)m.emit(w.ReplayCapture,{responseGroupUid:g,hasQuestions:!!(l!=null&&l.length),surveyId:p,uploadId:P.uploadId,replayType:P.replayDurationType??"before",seconds:P.replayDurationSeconds,generateVideoUploadUrlPayload:{mediaRecordingUid:oe(),mediaType:"screen",questionId:1,responseGroupUid:g,surveyId:p,updatedAt:new Date().toISOString(),visitorId:window.UserLeap.visitorId,isReplay:!0}});else{if(!S.replay)return window.UserLeap.reportError("displayQuestions",new Error("Replay module not registered")),{success:!1,message:"Replay module not registered",surveyState:"no survey"};S.replay.scheduleOrCaptureReplay({responseGroupId:g,surveyId:p,visitorId:U,replayParams:P,completeUploadHeaders:L,apiUrl:window.UserLeap._API_URL,triggerTimestamp:Date.now(),isStandalone:l.length===0})}if(a){if(!S.replay)return window.UserLeap.reportError("displayQuestions",new Error("Replay module not registered")),{success:!1,message:"Replay module not registered",surveyState:"no survey"};const{eventId:I,replayParams:yt,responseGroupUid:Ss,surveyId:Is}=a;await S.replay.initializeReplay({maxReplayDurationSeconds:300,maxInflightRequests:window.UserLeap.maxInflightReplayRequests,teardownAfter:!0}),S.replay.tryReplayAction(()=>{var Kr;return(Kr=S.replay)==null?void 0:Kr.scheduleCapture({apiUrl:window.UserLeap._API_URL,completeUploadHeaders:L,eventId:I,isHeatmap:!0,replayParams:yt,responseGroupId:Ss,surveyId:Is,triggerTimestamp:Date.now(),visitorId:U})},"Error in scheduling/capturing replay")}if(U==null||!(l!=null&&l.length))return f.info("CannotDisplaySurvey",{vid:U}),{success:!1,message:"[Sprig] no survey found",surveyState:"no survey"};if(window.UserLeap.container){f.info("AlreadyDisplayingSurvey");const I="[Sprig] (ERR-409) Found an existing Survey container, aborting rendering of this survey";return console.warn(I),{success:!1,message:I,surveyState:"no survey"}}if(U!==window.UserLeap.visitorId&&y!==window.UserLeap.visitorId&&!window.previewMode){const I="Attempted to display survey to a different visitor";return window.UserLeap.reportError("DisplaySurvey",new Error(I)),{success:!1,message:I,surveyState:"no survey"}}f.info("ShowingSurvey",{surveyId:p}),($r=S.replay)==null||$r.RecordSurveyShown({id:p,userAgent:window.navigator.userAgent}),en.disable(),m.emit(w.SurveyWillPresent,{name:w.SurveyWillPresent,"survey.id":p});let z,O=document.createElement("div"),R,M,Ne;const Hr=I=>{const{"view.version":yt}=I;yt!==L["x-ul-sdk-version"]&&At(),m.removeListener("verify.view.version",Hr)};m.on("verify.view.version",Hr),window.UserLeap.useMobileStyling=se,It(L)?(z="ul-direct-embeded-frame",R=document.head,M=window,Ne=!1,cn()&&(xt(p,o),O.id=z,window.UserLeap.container.appendChild(O),Tt(),m.emit(w.SurveyLifeCycle,{state:"presented"}),m.emit(w.SurveyPresented,{name:w.SurveyPresented,"survey.id":p}))):{frameId:z,contentWinDocHead:R,contentWindow:M,hasOverlay:Ne,iframe:O}=fn({productConfig:c,useMobileStyling:se,surveyId:p,isFeedback:o}),window.UserLeap.frameId=z;const vs=I=>{m.once(w.CloseSurveyOnOverlayClick,I)},de={apiURL:window.UserLeap._API_URL,cards:l,configureExitOnOverlayClick:vs,context:r,endCard:s,envId:window.UserLeap.envId,eventEmitFn:m.emit.bind(m),fontFamily:window.UserLeap.fontFamily,fontFamilyURL:window.UserLeap.fontFamilyURL,forceBrandedLogo:n,frame:O,headers:L,locale:d,mobileSDKVersion:window.UserLeap.mobileSDKVersion,previewKey:x.getItem("sprig.previewKey"),previewMode:u,productConfig:{framePosition:c==null?void 0:c.framePosition,desktopDisplay:c==null?void 0:c.desktopDisplay,placement:c==null?void 0:c.placement},responseGroupUid:g,startingQuestionIdx:(qr=window.UserLeap.config)==null?void 0:qr.startingQuestionIdx,studyType:_,styleNonce:window.UserLeap.styleNonce,surveyId:p,tabTitle:document.title,trackPageViewUrl:t,ulEvents:ve,upchunkLibraryURL:window.UserLeap.upchunkLibraryURL,useMobileStyling:se,userId:y,viewDocument:M==null?void 0:M.document,viewWindow:M,visitorAttributes:{externalUserId:window.UserLeap.userId,email:window.UserLeap.email},...window.UserLeap._config};(zr=window.UserLeap._config)!=null&&zr.startingQuestionIdx&&(window.UserLeap._config={...window.UserLeap._config,startingQuestionIdx:null});const bs=(o?window.UserLeap.feedbackCustomStyles:window.UserLeap.customStyles)??c.customStyles;de.customStyles=bs,M&&(M.__cfg=de);function Ls(){const I=document.createElement("script");return window.UserLeap.nonce&&I.setAttribute("nonce",window.UserLeap.nonce),I.id=Ct,I}const mt=window.UserLeap.viewSDKURL?window.UserLeap.viewSDKURL:de.path,Vr=document.getElementById(Ct);Vr&&Vr.remove();const gt=Ls(),Wr=()=>{window.UserLeap.container&&Object.assign(window.UserLeap.container.style,{display:"flex"})};if(de.installationMethod==="web-npm"||de.installationMethod==="web-npm-bundled"){const{default:I}=await import("../view/view.tsx");I.configure(de),Ne&&window.UserLeap.container&&Wr()}else mt&&(gt.src=mt,Ne&&gt.addEventListener("load",()=>{window.UserLeap.container&&Wr()}),M==null||M.addEventListener("error",I=>{I.target instanceof HTMLScriptElement&&I.target.src===mt&&window.UserLeap.reportError("loadFrameScript",new Error("Frame script failed to load"))},{capture:!0,once:!0}));R==null||R.appendChild(gt);const jr={success:!0,surveyState:"ready",surveyId:p,responseGroupUid:g};return window.UserLeap.isMobileSDK&&i&&(jr.delay=i),jr};function Ie(e){var r;if(window.UserLeap.useMobileStyling!==void 0)return window.UserLeap.useMobileStyling;const t=((r=window.UserLeap.windowDimensions)==null?void 0:r.width)??document.body.clientWidth;return le(e)||t>10&&t<Qr}function le(e){return dn.includes(e["userleap-platform"])}const Ve="ul-frame";window.UserLeap&&window.Sprig&&(window.Sprig._gtm?window.Sprig=window.UserLeap:window.UserLeap=window.Sprig),window.UserLeap||(window.UserLeap=window.Sprig),window.Sprig||(window.Sprig=window.UserLeap);const ln="rgba(255,255,255, 0.95)",un="rgba(0,0,0,0.9)",We="0px",xt=(e,t,r)=>{window.UserLeap.container=document.createElement("div"),window.UserLeap.container.className=`ul-container${t?" ul-container-feedback":""}`,e&&(window.UserLeap.container.dataset.studyId=e.toString());const i=Ht();r&&i&&!window.UserLeap.useMobileStyling?i.appendChild(window.UserLeap.container):document.body.appendChild(window.UserLeap.container)},At=(e,t)=>{var i;gn();const r=window.UserLeap.container;if(r)try{(i=r.parentNode)==null||i.removeChild(r),window.UserLeap.container=null,A("trackStartUrl",null),m.emit(w.SurveyLifeCycle,{state:"dismissed"}),m.emit(w.SurveyClosed,{name:w.SurveyClosed,initiator:e,"survey.id":parseInt(r.dataset.studyId),...t&&{studyType:t}})}catch(n){console.warn(`[Sprig] (ERR-412) Error removing UserLeap container by ${e} `+r),n instanceof Error&&window.UserLeap.reportError("dismissActiveSurvey",n)}},Tt=()=>{m.once(w.SurveyWillClose,({initiator:e,studyType:t})=>{m.removeAllListeners(w.CloseSurveyOnOverlayClick),At(e,t)})},pn=(e,t)=>{const i={...{position:"fixed",overflow:"auto",top:"0px",left:"0px",display:"none",height:"100%",width:"100%",transition:"background-color 0.3s ease-out",zIndex:2147483646}},n=t?e.overlayStyleMobile:e.overlayStyle;i["background-color"]=n==="light"?ln:un,t||(i.margin="auto"),window.UserLeap.container&&Object.assign(window.UserLeap.container.style,i)},wn=(e,t,r,i)=>{var c,l;const n={position:"fixed",bottom:"0px",right:We,border:0,backgroundColor:"rgba(0,0,0,0)",zIndex:2147483646,transition:"height 0.2s ease-in-out",maxWidth:"100%"},s=Object.assign({},t,window.UserLeap),{desktopDisplay:o}=t||{},a=o==="center-modal";a&&(s.framePosition="center");let d,u=!1;if(r)(c=window.UserLeap.windowDimensions)!=null&&c.width?n.width=`${window.UserLeap.windowDimensions.width}px`:n.width="100%",(l=window.UserLeap.windowDimensions)!=null&&l.height?n.maxHeight=`${window.UserLeap.windowDimensions.height-20}px`:window.UserLeap.maxHeight?n.maxHeight=window.UserLeap.maxHeight:n.maxHeight=`${document.body.clientHeight-20}px`,["light","dark"].includes(s.overlayStyleMobile)&&(u=!0);else{n.width=Jr,n.maxHeight=window.UserLeap.maxHeight||"66vh";const g=()=>{u=!0,d={margin:"auto",position:"static"}};if(i)a?g():d={position:"relative",height:"300px"};else switch(s.framePosition){case"bottomLeft":d={left:We};break;case"topLeft":d={left:We,top:0};break;case"topRight":d={top:0};break;case"center":g();break}}return u&&pn(s,r),Object.assign(e.style,n,d),u},fn=({productConfig:e,useMobileStyling:t,surveyId:r,isFeedback:i})=>{var g,p;const n=Ve,s=i&&e.desktopDisplay==="slider";xt(r,i,s),mn();const o=document.createElement("iframe");o.id=n,o.setAttribute("title","Sprig User Feedback Dialog");const a=wn(o,e,t,i);Tt();let d=!1;o.setHeight=y=>{(parseInt(o.style.height)!=y||!d)&&(d=!0,o.style.height=`${y}px`,m.emit(w.SurveyHeight,{name:w.SurveyHeight,contentFrameHeight:y,"survey.id":r}))};let u=!1;o.setWidth=y=>{(parseInt(o.style.width)!=y||!u)&&(u=!0,o.style.width=`${y}px`,m.emit(w.SurveyWidth,{name:w.SurveyWidth,contentFrameWidth:y,"survey.id":r}))},(g=window.UserLeap.container)==null||g.appendChild(o),e&&(t?e.exitOnOverlayClickMobile:e.exitOnOverlayClick)&&window.UserLeap.container&&(window.UserLeap.container.onclick=()=>{m.emit(w.CloseSurveyOnOverlayClick)}),m.emit(w.SurveyLifeCycle,{state:"presented"}),m.emit(w.SurveyPresented,{name:w.SurveyPresented,"survey.id":r});const c=(p=o.contentWindow)==null?void 0:p.document;if(c&&(c.open("text/html","replace"),c.write("<!doctype html><head></head><body></body></html>"),c.close(),!t)){const y=c.body;y.style.display="flex",y.style.alignItems="center"}const l=c==null?void 0:c.head;return{frameId:n,contentWinDocHead:l,contentWindow:o.contentWindow,hasOverlay:a,iframe:o}},Pt={[w.SurveyFadingOut]:()=>{window.UserLeap.container&&Object.assign(window.UserLeap.container.style,{"background-color":"rgba(0,0,0,0)"})}},mn=()=>{Object.entries(Pt).forEach(([e,t])=>{m.on(e,t)})},gn=()=>{Object.entries(Pt).forEach(([e,t])=>{m.off(e,t)})},Ot=Object.freeze({contains:(e,t)=>t.includes(e),notContains:(e,t)=>!t.includes(e),exactly:(e,t)=>t===e,notExactly:(e,t)=>t!==e,startsWith:(e,t)=>t.startsWith(e),endsWith:(e,t)=>t.endsWith(e),regex:(e,t)=>new RegExp(e).test(t),legacy:(e,t)=>new RegExp(e,"i").test(t)});function je(e,t){const{matchType:r,pattern:i}=e,n=r?Ot[r]:Ot.legacy;let s=!1;try{s=n(i,t)}catch(o){const a=`[Sprig] (ERR-445) Failed to check url match with pattern ${i}`;o instanceof Error&&(console.warn(a,o),o.stack=JSON.stringify(e),window.UserLeap.reportError(a,o))}return s}const Mt=e=>{const{pageUrlEvents:t}=window.UserLeap._config,r=t==null?void 0:t.find(i=>i.id===e);return r?je(r,window.location.href):!1},G=e=>e?e.nodeType===Node.ELEMENT_NODE:!1,yn=1,Bt=e=>e instanceof HTMLElement||e instanceof SVGElement,Ue=({document:e,elementId:t,styleString:r,nonce:i})=>{const n=e.getElementById(t);if(n){n.textContent=r;return}const s=e.createElement("style");i&&(s.nonce=i),s.textContent=r,s.id=t,e.head.appendChild(s)},hn=e=>{const t=e.querySelector(".sprig-question-body"),r=e.querySelector(".ul-card"),i=e.querySelector(".ul-card-main-content"),n=e.querySelector(".ul-footer"),s=e.querySelector(".sprig-container");let o=0;return G(r)&&(o+=r.scrollHeight-r.clientHeight),G(i)&&(o+=i.scrollHeight-i.clientHeight),G(t)&&(o+=t.scrollHeight-t.clientHeight),G(n)&&G(s)&&s.clientHeight===0&&(o+=n.clientHeight),o},Nt=100,vn=(e,t)=>{const r=t.querySelector(".sprig-question-body");if(!G(r))return e;const i=r.scrollHeight;return i<Nt?e:e-(i-Nt)},Ft=(e,t)=>{const r=t.querySelector(e);if(!G(r))return 0;const i=getComputedStyle(r),n=parseFloat(i.paddingLeft)+parseFloat(i.paddingRight),s=parseFloat(i.marginLeft)+parseFloat(i.marginRight),o=parseFloat(i.borderLeftWidth)+parseFloat(i.borderRightWidth);return n+s+o},bn=(e,t,r)=>{const i=e.querySelector(".ul-card__container"),n=e.querySelector(".ul-app");let s=600,o=360,a=0;if(G(i)&&G(n)){const u=i.querySelector(".ul-card--matrix_grid"),c=!u&&t&&r;try{c&&(n.style.width="360px"),s=i.clientHeight,s+=hn(e);const l=getComputedStyle(i);a=s;const g=parseFloat(l.marginTop)+parseFloat(l.marginBottom),p=parseFloat(l.borderTopWidth)+parseFloat(l.borderBottomWidth);s+=g+p,u&&(o=u.scrollWidth,o+=Ft(".ul-card__container",e),o+=Ft(".sprig-question-body",e))}finally{c&&n.style.removeProperty("width")}}return[s+yn,o,vn(a,e)]},Ht=()=>h,ae=()=>document.getElementById("sprig-feedback-container"),$e=()=>document.getElementById("sprig-feedback-loading-animation"),Ln=()=>{if($e())return;const e=document.createElement("div");return e.className="ul-loading-spinner-container",e.id="sprig-feedback-loading-animation",e.role="progressbar",e.setAttribute("aria-live","polite"),e.setAttribute("aria-busy","true"),e.setAttribute("aria-label","Processing..."),e.innerHTML=`
    <div class="ul-loading-spinner">
      <div class="first"></div>
      <div class="second"></div>
      <div class="third"></div>
      <div class="fourth"></div>
    </div>
  `,e},Vt=()=>!!document.getElementById(Ve);let Wt=!1,h=null,V=null,qe=!1,ue=null,ne=null;const Sn=["bottom-left","bottom-right","center-left","center-right"],In=e=>{if(ae()||!Sn.includes(e))return;const[t,r]=e.split("-"),i=document.createElement("div");i.id="sprig-feedback-container",i.classList.add(`sprig-feedback-container-${r}`,`sprig-feedback-container-${t}`),document.body.appendChild(i)},Ee=()=>{var t;const e=window.UserLeap.container;return((t=e==null?void 0:e.parentElement)==null?void 0:t.id)==="sprig-feedback-loading-container"},jt=()=>document.getElementById("sprig-feedback-error-container"),$t=()=>{if(!h)return 0;const e=h==null?void 0:h.clientWidth,t=window.getComputedStyle(h),r=parseInt(t.borderRightWidth||"0"),i=parseInt(t.borderLeftWidth||"0");return e+r+i},ke=e=>{const t=ae();t&&(ne!=null&&ne.endsWith("right")?t.style.right=`${e}px`:ne!=null&&ne.endsWith("left")&&(t.style.left=`${e}px`))},ze=()=>{if(h&&(Ee()||jt())){m.off(w.SurveyAppeared,pe),Ke();const e=$t();return ke(-e),!0}return!1},pe=()=>{if(!h||!V)return;const e=$e();e&&e.remove(),h.style.height="auto",h.style.width="auto",V.disabled=!1,qe=!1},Ke=()=>{if(!h)return;if(!$e()){const t=Ln();t&&(h.style.height="300px",h.style.width="360px",h.appendChild(t))}},qt=()=>{!h||!V||(ke(0),V.disabled=!0,qe=!0)},Un=async e=>{const t=await H(B("1",[J],"startFeedbackStudy"),{body:JSON.stringify({surveyUuid:e}),method:"POST"});return t.ok?t.json:null},zt=async(e,t,r)=>{const{buttonTheme:i,customStyles:n,eventId:s,placement:o,desktopDisplay:a,feedbackLabel:d,surveyUuid:u,surveyId:c}=e;window.UserLeap.feedbackCustomStyles=void 0;let l=ae();if(l){if(!t&&s===ue)return;l.remove(),m.off(ve.SURVEY_FADING_OUT,ze)}ue=s,Ue({document,elementId:"sprig-feedback-style",styleString:Yr,nonce:window.UserLeap.styleNonce}),Ue({document,elementId:"ul-custom-style",styleString:n??"",nonce:window.UserLeap.styleNonce}),Wt=a==="center-modal",ne=o;const[p,y]=o.split("-");In(o),l=ae(),V=document.createElement("button");const U=document.createElement("div");U.className="sprig-feedback-button-label",U.innerText=d,V.appendChild(U),V.id="sprig-feedback-button",V.classList.add(`sprig-feedback-button-${y}`,`sprig-feedback-button-${p}`,`sprig-feedback-button-${i}`,"fade-in-transition"),m.on(ve.SURVEY_FADING_OUT,ze),V.addEventListener("click",async()=>{const L=document.getElementById("sprig-feedback-error-container");if(Vt()||jt()){if(ze()){m.emit(w.SurveyWillClose,{name:w.SurveyWillClose,initiator:Y.FeedbackClosed,studyType:"feedbackButton","survey.id":c});const O=ae();L&&O&&(O.remove(),ue=null,h=null)}return}const ee=F(window.UserLeap);if(!Ie(ee)&&!qe&&qt(),t){h&&h.classList.add("sprig-feedback-loading-container-previews"),await ce(t),pe();return}const z=await Un(u);if(z)m.once(w.SurveyAppeared,pe),ce({...z,studyType:"feedbackButton"},r);else if(h){const O=kn();h.appendChild(O),pe(),h.style.height="300px",h.style.width="360px"}}),l==null||l.appendChild(V),m.emit(w.FeedbackButtonLoaded,{name:w.FeedbackButtonLoaded,"survey.id":c});const{useMobileStyling:P,_config:{border:_}}=window.UserLeap;if(!Wt&&!P){const L=document.createElement("div");L.id="sprig-feedback-loading-container",L.className=`sprig-feedback-loading-container sprig-feedback-loading-container-${y}`,L.style.setProperty("--feedback-border",_),h=L,Ke(),l==null||l.appendChild(L);const ee=$t();ke(-ee)}else ke(0);window.UserLeap._config.isOnQuestionsTab&&t&&!Ee()&&h&&(qt(),Ke(),h&&h.classList.add("sprig-feedback-loading-container-previews"),ce(t),pe())},En=()=>{if(Ee())return;const e=ae();if(!e)return;Mt(ue)||(e.remove(),ue=null,h=null)},kn=()=>{const e=document.createElement("div");e.id="sprig-feedback-error-container",e.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40" fill="none">
  <circle cx="20" cy="20" r="14.5" stroke="#B0B5B7" stroke-width="3"/>
  <path d="M20 12L20 21.6" stroke="#B0B5B7" stroke-width="3" stroke-linecap="round"/>
  <circle cx="19.9984" cy="27.6" r="1.6" fill="#B0B5B7"/>
  </svg>`;const t=document.createElement("h3");return t.className="sprig-feedback-error-text",t.innerText="There was an error while loading the survey",e.appendChild(t),e},_n="!launch_darkly_";class Rn{constructor(){E(this,"_ldData",{})}getAllLaunchDarklyVariations(){return this._ldData}setLDFlagsVariations(t){try{return!t||typeof t!="object"||Array.isArray(t)?!1:(Object.keys(this._ldData).forEach(r=>{delete this._ldData[r]}),Object.keys(t).forEach(r=>this._ldData[`${_n}${r}`]=(t[r]??0)+1),!0)}catch(r){return r instanceof Error&&window.UserLeap.reportError("setAllLDFlagsVariations",r),console.warn("[Sprig] An issue had occured when setting LaunchDarkly flags and variations."),!1}}}const Ge=new Rn;Object.freeze(Ge);const Dn="!optimizely_experiments_";class Cn{constructor(){E(this,"_optimizelyData",{})}setOptimizelyExperiment(t,r=!0){if(!t||typeof t!="object")return!1;const{experiments:i}=t;try{return r&&Object.keys(this._optimizelyData).map(n=>{delete this._optimizelyData[n]}),i&&i.map(n=>{const{id:s,variation:o}=n,a=this.transformExperimentId(s);o&&typeof o=="string"&&(this._optimizelyData[a]=o)}),!0}catch(n){return n instanceof Error&&window.UserLeap.reportError("setOptimizelyExperiment",n),!1}}getAllOptimizelyExperiments(){return this._optimizelyData}getOptimizelyVariationName(t){return this._optimizelyData[this.transformExperimentId(t)]}transformExperimentId(t){return Dn+t}getAndSetWebOptimizelyExperiments(){var t;try{if(window&&window.optimizely&&typeof window.optimizely.get=="function"){const r=(t=window.optimizely.get("state"))==null?void 0:t.getExperimentStates({isActive:!0});if(r){const i=Object.keys(r).map(n=>{var s,o;return(s=r[n].variation)!=null&&s.name?{id:n,variation:(o=r[n].variation)==null?void 0:o.name}:{id:n,variation:"Original"}});return this.setOptimizelyExperiment({experiments:i},!1),!0}return!1}return!1}catch(r){return r instanceof Error&&window.UserLeap.reportError("getAndSetWebOptimizely",r),!1}}}const _e=new Cn;Object.freeze(_e);class xn{constructor(t,r){E(this,"paused");E(this,"queue");E(this,"ul");this.ul=t,this.paused=!1,this.queue=[],this.flush(r)}flush(t){const r=t.length;if(r)for(let i=0;i<r;i++)this.push(t[i])}isPaused(){return this.paused}pause(){this.paused=!0}unpause(){this.paused=!1;const t=this.queue.slice();this.empty(),this.flush(t)}push(t){if(this.paused)this.queue.push(t);else if(t instanceof Function)t();else{const r=Array.prototype.slice.call(t,1),i=t[0],n=this.ul[i];n instanceof Function?n.apply(this.ul,r):i&&console.warn("[Sprig] (ERR-100) No valid UserLeap action called",i)}}perform(t){if(this.paused){let r=()=>{};const i=new Promise(function(n){r=function(){n(t())}});return this.queue.push(r),i}else return t()}empty(){this.queue.length=0}}let Kt=!0,Ye=!1;const An=()=>Kt=!1,Tn=()=>Ye=!0,Pn=["sdk_event_queue_latency_seconds","sdk_replay_add_event_batch_seconds","sdk_replay_cleanup_seconds","sdk_replay_compression_seconds","sdk_replay_get_events_between_seconds","sdk_replay_snapshot_seconds","sdk_mutations_nodes_added","sdk_mutations_nodes_removed","sdk_mutations_attributes_changed","sdk_mutations_character_data","sdk_dom_nodes_count","sdk_page_html_characters"];let we={},Je;class On{constructor(t){E(this,"_values",[]);E(this,"_isWebMetric");this.name=t,this._isWebMetric=Pn.includes(this.name)}report(t){if(Kt&&this._values.push({time:Date.now(),value:t}),Ye||!this._isWebMetric)return;const r=this.findExceededThreshold(t);r&&Je&&Je(t,r)}collect(){const t=this._values;return this._values=[],t}findExceededThreshold(t){const r=we[this.name];if(r)return r.find(i=>this.valueExceedsThreshold(t,i))}valueExceedsThreshold(t,r){return r.type==="max"?t>r.value:r.type==="min"?t<r.value:!1}}const Mn=(e,t)=>{we={},Ye=!1,e==null||e.forEach(r=>{var i;r.metric in we||(we[r.metric]=[]),(i=we[r.metric])==null||i.push(r)}),Je=t},fe={},W=e=>{const t=new On(e);return fe[e]=t,t},Gt=(e,t)=>{let r=fe[e];return r||(r=W(e)),r.report(t)},Bn=async e=>{const t=Object.values(fe).map(r=>({name:r.name,values:r.collect()}));if(t.some(r=>r.values.length))try{await e(JSON.stringify(t))}catch(r){r instanceof Error&&f.error("MetricsErr",{error:{message:r.message,name:r.name}})}},Nn=({reportingIntervalSeconds:e,postMetrics:t})=>{e?setInterval(()=>{Bn(t)},e*1e3):An()};let Yt,Jt;const Qe=e=>{let t=0,r=e.firstElementChild;for(;r;)t+=Qe(r),r.shadowRoot&&(t+=Qe(r.shadowRoot)),r=r.nextElementSibling,t++;return t},Fn=()=>document.documentElement.innerHTML.length,Qt=()=>{Yt.report(Qe(document.body)),Jt.report(Fn())},Hn=(e=10*1e3)=>{Yt=W("sdk_dom_nodes_count"),Jt=W("sdk_page_html_characters"),Qt(),setInterval(Qt,e)},Xe=(e,t)=>{const r=performance.now();document.hidden?setTimeout(()=>Xe(e,t),e):setTimeout(()=>{const i=performance.now()-r;t.report(i/1e3),setTimeout(()=>Xe(e,t),e)},0)},Vn=(e=1e3)=>{const t=W("sdk_event_queue_latency_seconds");Xe(e,t)};let Re,De,Ce,xe,ie={},Xt;const Ae=(e,t=1)=>{const{name:r}=e;ie[r]=(ie[r]||0)+t},Zt=e=>{let t=1;return e.childNodes.forEach(r=>{t+=Zt(r)}),t},er=e=>{let t=0;return e.forEach(r=>{t+=Zt(r)}),t},Wn=e=>{switch(e.type){case"childList":Ae(Re,er(e.addedNodes)),Ae(De,er(e.removedNodes));return;case"attributes":Ae(Ce);return;case"characterData":Ae(xe);return}},jn=e=>e.forEach(Wn),$n=()=>{Xt=new MutationObserver(jn),Xt.observe(document,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},qn=()=>{Re.report(ie[Re.name]||0),De.report(ie[De.name]||0),Ce.report(ie[Ce.name]||0),xe.report(ie[xe.name]||0),ie={}},zn=(e=1*1e3)=>{Re=W("sdk_mutations_nodes_added"),De=W("sdk_mutations_nodes_removed"),Ce=W("sdk_mutations_attributes_changed"),xe=W("sdk_mutations_character_data"),$n(),setInterval(qn,e)},Kn=({isWeb:e,reportingIntervalSeconds:t,thresholds:r,postMetrics:i})=>{Mn(r,(n,s)=>{var o,a;if((o=S.replay)!=null&&o.isReplayRecording()){const d=`Value: ${n} on ${s.metric} violated threshold of ${s.type} ${s.value}`;(a=S.replay)==null||a.disableRecording("Threshold violated",new Error(d),{reportError:!1}),window.UserLeap.reportError("Sdk Performance Metric threshold violated",new Error("Sdk Performance Metric threshold violated"),{metricName:s.metric,type:s.type,value:s.value},{metricName:s.metric}),Tn()}}),Nn({reportingIntervalSeconds:t,postMetrics:i}),e&&(Vn(),Hn(),zn())},Gn={test:"test"},Yn=["popState","pushState","replaceState"];let me;const Te={},ge="!email",tr="pageUrl";function Jn(e){if(!window.UserLeap._config.dismissOnPageChange)return!0;const t=new URL(e),r=new URL(me??window.location.href);return t.hostname===r.hostname&&t.pathname===r.pathname}let Ze=window.location.href;function ye(e){var d;const{pageUrlEvents:t,interactiveEvents:r,dismissOnPageChange:i,platform:n}=window.UserLeap._config;if(n&&n!=="web")return;Ze!==window.location.href&&f.navigation("LocationChange",{from:Ze,to:window.location.href}),Ze=window.location.href;const o=ir().trackStartUrl,a=o?String(o):null;t&&or(window.location.href),r&&(nr(),Qn()),Ht()&&En(),D.getItem("sprig.isCapturingHeatmap")&&((d=S.replay)==null||d.checkPendingHeatmapsUrl()),!Ee()&&i&&a&&a!==window.location.href&&e&&Yn.includes(e.type)&&window.UserLeap("dismissActiveSurvey",Y.PageChange)}const rr={capture:!0},Qn=()=>{const t=window.UserLeap._config.interactiveEvents.filter(i=>je(i,window.location.href)).map(i=>{const{name:n,properties:s}=i,{selector:o,innerText:a}=s;return o?d=>{if(Bt(d.target))try{d.target.closest(o)&&window.UserLeap("track",n)}catch{}return!1}:d=>(Bt(d.target)&&d.target.innerText===a&&window.UserLeap("track",n),!1)}),r=i=>t.forEach(n=>n(i));window.UserLeap._config.interactiveEventsHandler=r,window.addEventListener("click",r,rr)},nr=()=>{window.UserLeap._config.interactiveEventsHandler&&window.removeEventListener("click",window.UserLeap._config.interactiveEventsHandler,rr),delete window.UserLeap._config.interactiveEventsHandler};function Xn(){["hashchange","popstate"].forEach(e=>window.addEventListener(e,ye,!0))}function Zn(){["hashchange","popstate"].forEach(e=>window.removeEventListener(e,ye,!0)),window.UserLeap._config.interactiveEvents&&nr()}function ei(e){const t=new URL(B("1",[Q],"questions"));return Object.entries(e||{}).forEach(([r,i])=>{i&&t.searchParams.append(r,String(i))}),t.toString()}function ir(){const e=x.getItemObject("userleap.ids");return e&&e[window.UserLeap.envId]||{}}function sr(){if(window.previewMode)return;const e=x.getItemObject("sprig.anon.env.vid.map")||{},t=e[window.UserLeap.envId];window.UserLeap.visitorId=t||oe(),f.info("NewVid",{vid:window.UserLeap.visitorId}),A("vid",window.UserLeap.visitorId),t||(e[window.UserLeap.envId]=window.UserLeap.visitorId,x.setItemObject("sprig.anon.env.vid.map",e)),m.emit(w.VisitorIDUpdated,{visitorId:window.UserLeap.visitorId})}function or(e,t,r,i){var n,s;try{if(e.endsWith("mock_snippet.html"))return;f.info("PageView",{url:e});const o=window.UserLeap._config.pageUrlEvents;let a=!1;if(o&&o.length)for(let c=0;c<o.length&&(a=je(o[c],e),!a);c++);if(!a)return;window.UserLeap.debugMode&&console.info("[DEBUG] Sprig trackPageView",e);const d={url:e};i&&(d.trackPageView=!0),window.UserLeap._queue.push(["track",tr,t,d,r]);const u=(n=document==null?void 0:document.querySelector('meta[name="description"]'))==null?void 0:n.getAttribute("content");(s=S.replay)==null||s.RecordPageView({...u&&{description:u},url:e,referrer:document.referrer,pageTitle:document.title})}catch(o){o instanceof Error&&(o.stack=e,window.UserLeap.reportError("trackPageView",o)),console.warn("[Sprig] (ERR-428) Failed to track page view",o)}}function ti(){const e="Backbone"in window&&window.Backbone&&window.Backbone.history?window.Backbone.history:window.history;"pushState"in e&&(e.pushState=(t=>function(...i){const n=t.apply(this,i),s=new Event("pushState");return window.dispatchEvent(s),ye(s),n})(e.pushState)),"replaceState"in e&&(e.replaceState=(t=>function(...i){const n=t.apply(this,i),s=new Event("replaceState");return window.dispatchEvent(s),ye(s),n})(e.replaceState)),Xn()}async function et(e,t){const r=He();e&&!t&&(window.UserLeap._config.mode=Gn.test);const i=F(window.UserLeap),n=Ie(i),s=await H(ei({desktopDisplay:window.UserLeap._config.desktopDisplay,isMobile:n,previewLanguage:window.UserLeap._config.previewLanguage,surveyid:e==null?void 0:e.surveyId,surveytemplateid:e==null?void 0:e.surveyTemplateId,vid:r}),{shouldDropOnRateLimit:!0});if(!s.ok)return s.reportError&&s.error&&(console.warn("[Sprig] (ERR-414) Failed to request questions from the server",s.error),window.UserLeap.reportError("getQuestions",s.error)),{success:!1,surveyState:"no survey"};if(s.json.delay&&await be(s.json.delay),s.json.isFeedback){const{feedbackLabel:o,productConfig:a,surveyUuid:d,feedbackCustomStyles:u}=s.json,{buttonTheme:c,placement:l,desktopDisplay:g}=a,p={customStyles:u,buttonTheme:c,desktopDisplay:g,eventId:0,feedbackLabel:o,placement:l,surveyUuid:d,surveyId:e==null?void 0:e.surveyId};zt(p,s.json)}else return ce(s.json,me)}function ri(e){let t=e.length;for(;t;){const r=Math.floor(Math.random()*t);t-=1;const i=e[t];e[t]=e[r],e[r]=i}}function ni(e){if(!e)return;window.UserLeap._config=e,e.mute&&window.UserLeap._queue.pause();const{interactiveEvents:t,pageUrlEvents:r,dismissOnPageChange:i}=e;t&&ri(t),(t||r||i)&&(ti(),ye())}async function ii(e,t){var i,n;let r=!0;return t&&((i=e==null?void 0:e.json)!=null&&i.surveyId)&&(window.UserLeap.delayingSurvey=!0,r=await t(e.json.surveyId),window.UserLeap.delayingSurvey=!1,!r)?!1:((n=e==null?void 0:e.json)!=null&&n.delay&&!window.UserLeap.isMobileSDK&&(window.UserLeap.delayingSurvey=!0,await be(e.json.delay),window.UserLeap.delayingSurvey=!1),r)}const si=function(e){if(!window.UserLeap)return;const t=async(n={})=>{var L,ee,se,z,O;const{userId:s,anonymousId:o,metadata:a={},properties:d,showSurveyCallback:u}=n;let{eventName:c}=n;if(window.UserLeap.debugMode&&c!==tr&&console.info("[DEBUG] Sprig track",n),e.mode==="test")return;const l=x.getItem("sprig.previewKey")??void 0;if(e.requireUserIdForTracking&&!window.UserLeap.userId&&!s){const R="[Sprig] - Skipping tracking without userId";return console.warn(R),{success:!1,message:R,surveyState:"no survey"}}if(!c||c.trim().length===0){c=c?String(c):"";const R="[Sprig] - Invalid event name "+c;return console.warn(R),{success:!1,message:R,surveyState:"no survey"}}const g=me??window.location.href;if(a.url||(a.url=g),A("trackStartUrl",g),(ee=(L=window.UserLeap)==null?void 0:L._config)!=null&&ee.optimizelyEnabled){const R=F(window.UserLeap);le(R)||_e.getAndSetWebOptimizelyExperiments(),a.optimizelyExperiments=Object.assign({},_e.getAllOptimizelyExperiments())}(z=(se=window.UserLeap)==null?void 0:se._config)!=null&&z.launchDarklyEnabled&&(a.launchDarklyFlags=Ge.getAllLaunchDarklyVariations()),s&&(window.UserLeap.userId=s),o&&(window.UserLeap.partnerAnonymousId=o),d&&(a.eventProperties=d),(O=S.replay)==null||O.RecordEvent({name:c,url:a.url}),f.info("TrackEvent",{eventName:c});const p=window.UserLeap.delayingSurvey||Vt()?await H(B("1",[J],"events/batch"),{body:JSON.stringify({events:[{event:c,metadata:a}],previewKey:l}),method:"POST",shouldDropOnRateLimit:!0}):await H(B("1",[J],"events"),{body:JSON.stringify({event:c,metadata:a,previewKey:l}),method:"POST",shouldDropOnRateLimit:!0});if(!p.ok){const R="[Sprig] (ERR-421) Failed to track event";return p.reportError&&(console.warn(R,p.error),p.error&&window.UserLeap.reportError("track",p.error)),{success:!1,message:R,error:p.error,surveyState:"no survey"}}s&&A("uid",s),o&&A("aid",o);const y=p.json;y.invalidPreviewKey&&x.removeItem("sprig.previewKey");const U=a.trackPageView?a.url:void 0;return!!(y!=null&&y.feedbackButton)&&zt(y.feedbackButton,void 0,U),await ii(p,u)?Jn(g)?ce(y,U):{success:!1,message:"Study should not be displayed after page navigation",surveyState:"no survey"}:{success:!1,message:"[Sprig] Callback returned false, aborting rendering of survey",surveyState:"no survey"}},r=(n,s)=>{var a;const o=(a=n==null?void 0:n.querySelector(`[id="${Ve}"]`))==null?void 0:a.contentDocument;o&&Ue({document:o,elementId:"ul-custom-style",styleString:s})},i={async displaySurvey(n){return console.warn("[Sprig] displaySurvey should only be used to debug your studies; not intended for production usage."),window.UserLeap("dismissActiveSurvey",Y.Override),et({surveyId:n},!0)},_previewSurvey(n){window.UserLeap("dismissActiveSurvey",Y.Override),et({surveyTemplateId:n},!1)},_reviewSurvey(n){window.UserLeap("dismissActiveSurvey",Y.Override),et({surveyId:n},!1)},previewSurvey(n){i._previewSurvey(n)},reviewSurvey(n){i._reviewSurvey(n)},mute(){window.UserLeap._queue.pause()},unmute(){window.UserLeap._queue.unpause()},setVisitorToken(){console.warn("[Sprig] setVisitorToken is deprecated.")},dismissActiveSurvey(n=Y.API){window.UserLeap.container&&m.emit(w.SurveyWillClose,{name:w.SurveyWillClose,initiator:n,"survey.id":parseInt(window.UserLeap.container.dataset.studyId)})},async setAttribute(n,s){if(!n||!s&&s!==0&&s!==!1){const o="[Sprig] - Disregarding empty attribute / value provided";return console.warn(o),{success:!1,message:o}}return this.setAttributes({[n]:s})},async setAttributes(n){if(n==null||Object.keys(n).length===0){const s="[Sprig] - Disregarding empty attributes provided";return console.warn(s),{success:!1,message:s}}return this.identifyAndSetAttributes({attributes:n})},async identifyAndSetAttributes(n){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig identifyAndSetAttributes",n),e.mode==="test")return;if(n===null||typeof n!="object"||!(n.userId||n.anonymousId||n.attributes)){const c="[Sprig] - Disregarding empty payload provided";return console.warn(c),{success:!1,message:c}}const{userId:s,anonymousId:o,attributes:a}=n;if(e.requireUserIdForTracking&&!window.UserLeap.userId&&!s){const c="[Sprig] - Skipping tracking without userId";return console.warn(c),{success:!1,message:c}}if(a){a.email&&!a[ge]&&(a[ge]=a.email,delete a.email);const c=Object.keys(a);for(const l of c)a[l]===Te[l]&&delete a[l]}if((!a||Object.keys(a).length===0)&&(!s||window.UserLeap.userId===s)&&(!o||window.UserLeap.partnerAnonymousId===o))return{success:!0};const d={};s&&(d.userId=window.UserLeap.userId=s),o&&(d.partnerAnonymousId=window.UserLeap.partnerAnonymousId=o);let u;return a&&Object.keys(a).length>0?(u=await H(B("1",[Q,J],"attributes"),{body:JSON.stringify(a),method:"PUT"}),u.ok?Object.assign(Te,a):u.reportError&&(console.warn("[Sprig] (ERR-432) identifyAndSetAttributes failed",u.error),u.error&&window.UserLeap.reportError("identifyAndSetAttributes",u.error))):u=await H(B("1",[Q,J]),{body:JSON.stringify(d),method:"PUT"}),a&&a[ge]&&(window.UserLeap.email=a[ge]),u.ok&&(s&&A("uid",s),o&&A("aid",o)),{success:!!u.ok}},async removeAttributes(n){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig removeAttributes",n),e.mode==="test")return;if(n==null||n.length===0){const o="[Sprig] - Disregarding empty attributes provided";return console.warn(o),{success:!1,message:o}}if(e.requireUserIdForTracking&&!window.UserLeap.userId){const o="[Sprig] - Skipping tracking without userId";return console.warn(o),{success:!1,message:o}}const s=await H(B("1",[Q,J],"attributes"),{body:JSON.stringify({delete:n}),method:"DELETE"});return!s.ok&&s.reportError&&(console.warn("[Sprig] (ERR-433) Remove attributes failed",s.error),s.error&&window.UserLeap.reportError("removeAttributes",s.error)),{success:!!s.ok}},async addSurveyListener(n){m.on(w.SurveyLifeCycle,n)},async removeSurveyListener(n){m.removeListener(w.SurveyLifeCycle,n)},async addListener(n,s){m.on(n,s)},async removeListener(n,s){m.removeListener(n,s)},async removeAllListeners(){m.removeAllListeners()},setPreviewKey(n){!n||typeof n!="string"||x.isStorageAvailable&&n&&x.setItem("sprig.previewKey",n)},async setUserId(n){var a;if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig setUserId",n),n==null){const d=`[Sprig] - Invalid userId ${n}`;return console.warn(d),{success:!1,message:d}}if(e.mode==="test"||n===window.UserLeap.userId)return;window.UserLeap.userId=n;const s=window.UserLeap.visitorId,o=await H(B("1",[Q,J]),{body:JSON.stringify({userId:n}),method:"PUT"});if(!o.ok){o.reportError&&(console.warn("[Sprig] (ERR-420) Failed to set user id",o.error),o.error&&window.UserLeap.reportError("setUserId",o.error));return}s!==window.UserLeap.visitorId&&((a=S.replay)==null||a.clearUserReplayData()),A("uid",n)},async setPartnerAnonymousId(n){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig setPartnerAnonymousId",n),n==null){const s=`[Sprig] - Invalid partnerAnonymousId ${n}`;return console.warn(s),{success:!1,message:s}}return window.UserLeap.partnerAnonymousId=n,A("aid",n),{success:!0}},async track(n,s,o={},a=void 0){return t({eventName:n,properties:s,metadata:o,showSurveyCallback:a})},async identifyAndTrack(n){return await t(n)},trackPageView(n,s=void 0,o=void 0,a=!0){me=n,or(n,s,o,a)},applyFeedbackStyles({button:n="",view:s=""}){window.UserLeap.feedbackCustomStyles=s,document.getElementById("sprig-feedback-style")&&Ue({document,elementId:"ul-custom-style",styleString:n,nonce:window.UserLeap.styleNonce}),r(document.querySelector(".ul-container-feedback"),s)},applyStyles(n){window.UserLeap.customStyles=n,r(window.UserLeap.container,n)},setWindowDimensions(n,s){var g,p;const o=typeof n=="string"?parseInt(n,10):n,a=typeof s=="string"?parseInt(s,10):s;!isNaN(o)&&!isNaN(a)&&(window.UserLeap.windowDimensions={width:o,height:a});const d=F(window.UserLeap),u=Ie(d),c=d["userleap-platform"]==="web";if(!window.UserLeap.frameId)return;const l=document.getElementById(window.UserLeap.frameId);l&&(window.UserLeap.useMobileStyling&&((g=window.UserLeap.windowDimensions)!=null&&g.width&&(l.style.width=`${window.UserLeap.windowDimensions.width}px`),(p=window.UserLeap.windowDimensions)!=null&&p.height&&(l.style.maxHeight=`${window.UserLeap.windowDimensions.height-20}px`),l.contentDocument&&(l.style.height=String(bn(l.contentDocument,c&&!u,It(d))[0])+"px")),m.emit(w.SurveyDimensions,{name:w.SurveyDimensions,contentFrameWidth:l.clientWidth,contentFrameHeight:l.clientHeight,"survey.id":parseInt(window.UserLeap.container.dataset.studyId)}))},logoutUser(){var n;window.UserLeap.debugMode&&console.info("[DEBUG] Sprig logout"),f.info("LogOut",{vid:window.UserLeap.visitorId,userId:window.UserLeap.userId}),window.UserLeap.visitorId=null,window.UserLeap.userId=null,window.UserLeap.partnerAnonymousId=null,window.UserLeap.token=null,window.UserLeap.email=null,x.removeItem("userleap.ids"),window.UserLeap._queue.isPaused()&&window.UserLeap._queue.empty(),sr(),(n=S.replay)==null||n.clearUserReplayData(),window.UserLeap._queue.unpause()},teardown(){Zn(),window.UserLeap("dismissActiveSurvey",Y.API),delete window.UserLeap,delete window.Sprig,delete window._Sprig},integrateOptimizely(n,s=!0){var o,a;if(!((a=(o=window.UserLeap)==null?void 0:o._config)!=null&&a.optimizelyEnabled)){console.warn("[SPRIG] Optimizely integration is currently not enabled for your product.");return}try{const d=typeof n=="string"?JSON.parse(n):n;_e.setOptimizelyExperiment(d,s)}catch(d){console.warn("[Sprig] Error with integrating Optimizely data"),d instanceof Error&&window.UserLeap.reportError("integrateOptimizely",d)}},integrateOptimizelyClient(n){var o,a;if(!((a=(o=window.UserLeap)==null?void 0:o._config)!=null&&a.optimizelyEnabled)){console.warn("[SPRIG] Optimizely integration is currently not enabled for your product.");return}const s=({experiment:d,variation:u})=>{const c={experiments:[{id:d.id,variation:u.key}]};window.UserLeap("integrateOptimizely",c,!1)};n.notificationCenter.addNotificationListener("ACTIVATE:experiment, user_id,attributes, variation, event",s)},importLaunchDarklyData(n){var s,o;if(!((o=(s=window.UserLeap)==null?void 0:s._config)!=null&&o.launchDarklyEnabled)){console.warn("[SPRIG] LaunchDarkly integration is currently not enabled for your product.");return}Ge.setLDFlagsVariations(n)},setVisitorAttribute(n,s){return console.warn("[Sprig] setVisitorAttribute is deprecated. Please use setAttribute"),i.setAttribute(n,s)},async setEmail(n){return i.setAttribute(ge,n)},async setVisitorEmail(n){return console.warn("[Sprig] setVisitorEmail is deprecated. Please use setEmail"),i.setEmail(n)},async _generateVideoUploadUrl(n){return di(n)},_reportMetric(n,s){Gt(n,s)},async _completeSessionReplay({surveyId:n,responseGroupUuid:s,eventDigest:o}){var a;return S.replay?(a=S.replay)==null?void 0:a._completeSessionReplay({surveyId:n,responseGroupUuid:s,eventDigest:o,headers:F(window.UserLeap)}):(window.UserLeap.reportError("_completeSessionReplay",new Error("Replay module not registered")),!1)}};Object.assign(window.UserLeap,i)};async function oi(e){var s,o;const t=F(window.UserLeap);document.addEventListener("securitypolicyviolation",Rt);const r=await re(B("1",[Q],"config"),{headers:t});if(document.removeEventListener("securitypolicyviolation",Rt),!r.ok)return(s=window.SprigLoggerCallback)==null||s.call(window,"Sprig config fetch failed"),r.reportError&&(console.warn("[Sprig] (ERR-422) Failed to load configuration",r.error),r.error&&window.UserLeap.reportError("applyRemoteConfig",r.error)),Fe("Disabled: failed to fetch configuration"),e;const i=r.json;return i!=null&&i.disabled?((o=window.SprigLoggerCallback)==null||o.call(window,"Sprig config fetch disabled"),Fe(`Disabled: ${i.disabled}`),{disabled:i.disabled}):Object.assign({},i,e)}async function ai(e,t,r={},i={}){const n=window.__cfg&&window.__cfg.mode,s=He(),o=window.UserLeap.envId,a=window.document.documentElement,d={mode:n,screenWidth:window.screen.width,screenHeight:window.screen.height,clientWidth:a.clientWidth,clientHeight:a.clientHeight,location:me??window.location.href,language:window.navigator.language,...r},u={action:e,breadcrumbs:f.breadcrumbs,err:{message:`${t==null?void 0:t.name} - ${t==null?void 0:t.message}`,stack:t==null?void 0:t.stack},meta:d,vid:s,envId:o,...i};(await H(B("1",null,"errors"),{method:"POST",headers:{"x-ul-error":window.btoa(`userleap-${Date.now()}-error`)},body:JSON.stringify(u),shouldDropOnRateLimit:!0})).ok||console.warn("[Sprig] (ERR-444) Failed to report error to API",t)}async function di(e){var r;if(!e)return;const t=`${window.UserLeap._API_URL}/2/environments/integrations/upload`;try{const i=await fetch(t,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(i.ok){const n=await i.json();return(r=n==null?void 0:n.upload)==null?void 0:r.url}else return null}catch(i){console.warn("[Sprig] Error with generating video upload url"),i instanceof Error&&window.UserLeap.reportError("generateVideoUploadUrl",i)}}function ci(e={}){var i;(i=window.SprigLoggerCallback)==null||i.call(window,"Initializing Sprig");const t=new URLSearchParams(window.location.search).get("sprigPreviewKey")??"";window.UserLeap.UPDATES=ve,window.UserLeap("setPreviewKey",t);async function r(){var g,p,y,U,P;if(window.UserLeap.loaded)return;if((g=window.SprigLoggerCallback)==null||g.call(window,"Loading Sprig"),window.UserLeap.reportError=ai,window.UserLeap.loaded=!0,window.UserLeap._config=Object.assign({},e,window.UserLeap.config),window.UserLeap.delayingSurvey=!1,window.UserLeap._config&&typeof window.UserLeap._config=="object")for(const _ in window.UserLeap._config)window.UserLeap[_]=window.UserLeap._config[_];if(!window.UserLeap.envId)if(window.UserLeap.appId)window.UserLeap.envId=window.UserLeap.appId;else throw new Error("Missing Environment id");window.UserLeap.debugMode&&console.info("[DEBUG] Sprig debug mode enabled");const n=ir(),s=window.UserLeap.sampleRate;let o=n.sampled;if(s){if(o===null&&(o=Math.random()<s,A("sampled",o)),!o)return}else o!==null&&A("sampled",null);window.UserLeap._API_URL||(window.UserLeap._API_URL="https://api.sprig.com");const a=[...window.UserLeap._queue];window.UserLeap._queue=new xn(window.UserLeap,[]),window.UserLeap._queue.pause();for(let _=0;_<a.length;_++)window.UserLeap._queue.push(a[_]);const d=n.token;d?(window.UserLeap.token=d,window.UserLeap.visitorId=n.vid??null,window.UserLeap.userId=n.uid??null,window.UserLeap.partnerAnonymousId=n.aid??null):sr();const u=F(window.UserLeap),c=le(u);(p=window.SprigLoggerCallback)==null||p.call(window,"Sprig fetching config");const l=await oi(e);(y=window.SprigLoggerCallback)==null||y.call(window,"Sprig fetched config"),Kn({isWeb:!c,reportingIntervalSeconds:l.metricsReportingEnabled||l.mobileMetricsReportingEnabled?l.metricsReportingIntervalSeconds:0,thresholds:l.metricThresholds,postMetrics:async _=>{var L;await H(B("1",[Q],"metrics"),{body:_,method:"POST",headers:{"x-ul-replay-enabled":`${!!((L=S.replay)!=null&&L.isReplayRecording())}`},shouldDropOnRateLimit:!0})}}),await((U=S.replay)==null?void 0:U.initializeReplay({maxReplayDurationSeconds:l.maxReplayDurationSeconds,maxInflightRequests:window.UserLeap.maxInflightReplayRequests??2,replaySettings:l.replaySettings})),si(l),await ni(l),window.UserLeap._queue.unpause(),(P=window.SprigLoggerCallback)==null||P.call(window,"SdkReady"),m.emit(w.SDKReady,{mobileMetricsReportingEnabled:!!l.mobileMetricsReportingEnabled,metricsReportingInterval:l.metricsReportingIntervalSeconds||0,metricsThresholds:l.metricThresholds||[],maxMobileReplayDurationSeconds:l.maxMobileReplayDurationSeconds,mobileReplaySettings:l.mobileReplaySettings}),m.emit(w.VisitorIDUpdated,{visitorId:window.UserLeap.visitorId}),m.on(w.VisitorIDUpdated,()=>{for(const _ in Te)delete Te[_]})}document.readyState==="complete"?r():window.attachEvent?window.attachEvent("onload",r):window.addEventListener("load",()=>{r()},!1)}var he=(e=>(e[e.DomContentLoaded=0]="DomContentLoaded",e[e.Load=1]="Load",e[e.FullSnapshot=2]="FullSnapshot",e[e.IncrementalSnapshot=3]="IncrementalSnapshot",e[e.Meta=4]="Meta",e[e.Custom=5]="Custom",e[e.Plugin=6]="Plugin",e))(he||{});class li{constructor(t){E(this,"awaitingResolvers",[]);E(this,"activeCount",0);this.capacity=t}async acquire(){if(this.activeCount<this.capacity){this.activeCount++;return}return new Promise(t=>{this.awaitingResolvers.push(t)})}release(){const t=this.awaitingResolvers.shift();t&&this.activeCount<=this.capacity?t():this.activeCount--}async execute(t){try{return await this.acquire(),await t()}finally{this.release()}}setLimit(t){this.capacity=t}}const ar=new li(2),ui=e=>ar.setLimit(e),pi=async e=>ar.execute(async()=>{var i;f.info("UploadChunkStart",{chunkIndex:e.chunkIndex,surveyId:e.surveyId});const t=await re(e.uploadUrl,{body:e.data,method:"PUT"});f.http("UploadChunkEnd",{url:e.uploadUrl,method:"PUT",status_code:t.status,reason:t.statusText??"OK",chunkIndex:e.chunkIndex,surveyId:e.surveyId});const r=(i=t.headers)==null?void 0:i.get("ETag");if(!r)throw new Error(`Upload response did not include etag for upload ${e.uploadId}, part ${e.chunkIndex}`);return r}),dr=async({apiUrl:e,surveyId:t,uploadId:r,etags:i,headers:n,responseGroupUuid:s,replayDuration:o,eventDigest:a},d=!1)=>{var c;if(!d&&!r&&!i){f.error("UploadErr",{isMobile:d,uploadId:r,etags:i});return}f.info("MarkUploadComplete",{surveyId:t});const u=await re(`${e}/sdk/1/completeSessionReplay`,{method:"POST",body:JSON.stringify({etags:i,uploadId:r,responseGroupUuid:s,surveyId:t,replayDuration:o,eventDigest:a,userAgent:(c=window==null?void 0:window.navigator)==null?void 0:c.userAgent}),headers:n,shouldRetryRequest:!0});return f.info("MarkUploadDone",{surveyId:t}),u},tt=(e,t)=>t.some(r=>e instanceof r);let cr,lr;function wi(){return cr||(cr=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function fi(){return lr||(lr=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const rt=new WeakMap,nt=new WeakMap,Pe=new WeakMap;function mi(e){const t=new Promise((r,i)=>{const n=()=>{r(X(e.result))},s=()=>{i(e.error)};e.onsuccess=n,e.onerror=s});return Pe.set(t,e),t}function gi(e){if(rt.has(e))return;const t=new Promise((r,i)=>{const n=()=>{r()},s=()=>{i(e.error||new DOMException("AbortError","AbortError"))};e.oncomplete=n,e.onerror=s,e.onabort=s});rt.set(e,t)}let it={get(e,t,r){if(e instanceof IDBTransaction){if(t==="done")return rt.get(e);if(t==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return X(e[t])},set(e,t,r){return e[t]=r,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function ur(e){it=e(it)}function yi(e){return fi().includes(e)?function(...t){return e.apply(st(this),t),X(this.request)}:function(...t){return X(e.apply(st(this),t))}}function hi(e){return typeof e=="function"?yi(e):(e instanceof IDBTransaction&&gi(e),tt(e,wi())?new Proxy(e,it):e)}function X(e){if(e instanceof IDBRequest)return mi(e);if(nt.has(e))return nt.get(e);const t=hi(e);return t!==e&&(nt.set(e,t),Pe.set(t,e)),t}const st=e=>Pe.get(e);function vi(e,t,{blocked:r,upgrade:i,blocking:n,terminated:s}={}){const o=indexedDB.open(e,t),a=X(o);return i&&(o.onupgradeneeded=d=>{i(X(o.result),d.oldVersion,d.newVersion,X(o.transaction),d)}),r&&(o.onblocked=d=>r(d.oldVersion,d.newVersion,d)),a.then(d=>{s&&(d.onclose=()=>s()),n&&(d.onversionchange=u=>n(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}function ot(e,{blocked:t}={}){const r=indexedDB.deleteDatabase(e);return t&&(r.onblocked=i=>t(i.oldVersion,i)),X(r).then(()=>{})}const bi=["get","getKey","getAll","getAllKeys","count"],Li=["put","add","delete","clear"],at=new Map;function pr(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(at.get(t))return at.get(t);const r=t.replace(/FromIndex$/,""),i=t!==r,n=Li.includes(r);if(!(r in(i?IDBIndex:IDBObjectStore).prototype)||!(n||bi.includes(r)))return;const s=async function(o,...a){const d=this.transaction(o,n?"readwrite":"readonly");let u=d.store;return i&&(u=u.index(a.shift())),(await Promise.all([u[r](...a),n&&d.done]))[0]};return at.set(t,s),s}ur(e=>({...e,get:(t,r,i)=>pr(t,r)||e.get(t,r,i),has:(t,r)=>!!pr(t,r)||e.has(t,r)}));const Si=["continue","continuePrimaryKey","advance"],wr={},dt=new WeakMap,fr=new WeakMap,Ii={get(e,t){if(!Si.includes(t))return e[t];let r=wr[t];return r||(r=wr[t]=function(...i){dt.set(this,fr.get(this)[t](...i))}),r}};async function*Ui(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const r=new Proxy(t,Ii);for(fr.set(r,t),Pe.set(r,st(t));t;)yield r,t=await(dt.get(r)||t.continue()),dt.delete(r)}function mr(e,t){return t===Symbol.asyncIterator&&tt(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&tt(e,[IDBIndex,IDBObjectStore])}ur(e=>({...e,get(t,r,i){return mr(t,r)?Ui:e.get(t,r,i)},has(t,r){return mr(t,r)||e.has(t,r)}}));const Ei=e=>{if(e instanceof Attr)return null;let t=1;for(let r=e.previousSibling;r;r=r.previousSibling)r.nodeName===e.nodeName&&++t;return t},gr=e=>{if(e===null)return"";const t=[];if(e instanceof Document)return"/";for(let r=e;r&&!(r instanceof Document)&&r!==null;r=r instanceof Attr?r.ownerElement:r.parentElement){const i=t[t.length]={name:void 0,position:null};switch(r.nodeType){case Node.TEXT_NODE:i.name="text()";break;case Node.ATTRIBUTE_NODE:i.name="@"+r.nodeName;break;case Node.PROCESSING_INSTRUCTION_NODE:i.name="processing-instruction()";break;case Node.COMMENT_NODE:i.name="comment()";break;case Node.ELEMENT_NODE:i.name=r.nodeName;break}i.position=Ei(r)}return"/"+t.reverse().map(r=>r.position!==null?`/${r.name}[${r.position}]`:`/${r.name}`).join("")},j={capture:!0,passive:!0},ki=["a","button","input","option","li","link"],_i=["Escape","Enter","Backspace","F5","Tab"];let Oe=!1;const Ri=["label","type","role","title","placeholder","errormessage","valuetext","href"],yr="aria-",Di=e=>{if(!e.tagName)return"No tagName";const t=e.getAttribute("type");return t?`${t} ${e.tagName.toLowerCase()}`:e.tagName.toLowerCase()},hr=e=>{var i;if(((i=e.tagName)==null?void 0:i.toLowerCase())==="html")return{element:"html"};const t=e.textContent,r=t?{text:t}:{};r.element=Di(e);for(const n of e.attributes){let s=n.name;const o=n.value;s.startsWith(yr)&&(s=s.substring(yr.length)),Ri.includes(s)&&(r[s]=o)}return r},Ci=e=>{var n;if(!e)return{};const r={...hr(e)},i=e.parentElement;if(i&&ki.includes((n=i.tagName)==null?void 0:n.toLowerCase())){const s=hr(i);Object.assign(r,s)}return r},vr=(e,t)=>{var i;let r=t.target;t.target===((i=window.document)==null?void 0:i.body)&&window.Sprig.pointerDownTarget&&(r=window.Sprig.pointerDownTarget),Wi({x:t.x,y:t.y,type:e,elementAttributes:Ci(r),windowHeight:window.innerHeight,windowWidth:window.innerWidth,...r instanceof HTMLElement?{rect:r==null?void 0:r.getBoundingClientRect(),xPath:gr(r)}:{}})},xi=e=>t=>vr(e,t),br=e=>{_i.includes(e.key)&&Gi({key:e.key})},Ai=()=>{window.performance.getEntriesByType("navigation").map(t=>t.type).includes("reload")&&zi({url:window.location.href,currentPageTitle:document.title})},Ti=()=>{window.performance.getEntriesByType("navigation").map(t=>t.type).includes("back_forward")&&Ki({curUrl:window.location.href,fromUrl:document.referrer,currentPageTitle:document.title})},Lr=((e,t)=>{let r;return i=>{clearTimeout(r),r=window.setTimeout(()=>e(i),t)}})(e=>{if(!(e.target instanceof HTMLElement||e.target instanceof Document))return;let t=e.target;"scrollTop"in t||(t=t.documentElement),Yi({xPath:gr(t),x:t.scrollLeft,y:t.scrollTop,elementAttributes:{targetScrollWidth:t.scrollWidth,targetClientWidth:t.clientWidth,targetScrollHeight:t.scrollHeight,targetClientHeight:t.clientHeight}})},750),Sr=xi("left_click"),Ir=e=>{e.button===2&&vr("right_click",e)},Ur=e=>{window.Sprig&&(window.Sprig.pointerDownTarget=e.target)},Pi=()=>{Oe||(window.addEventListener("click",Sr,j),window.addEventListener("pointerdown",Ur,j),window.addEventListener("mousedown",Ir,j),window.addEventListener("keydown",br,j),window.addEventListener("scroll",Lr,j),Oe=!0,Ai(),Ti())},Oi=()=>{Oe&&(window.removeEventListener("click",Sr,j),window.removeEventListener("pointerdown",Ur,j),window.removeEventListener("mousedown",Ir,j),window.removeEventListener("keydown",br,j),window.removeEventListener("scroll",Lr,j),Oe=!1)},Mi=3e4,b={isRecording:!1,scrollEventUuids:{},stopRecording:()=>{}},Er=()=>window.indexedDB&&window.IDBKeyRange&&window.CompressionStream,Bi=.5,Ni=async()=>{var e;if(!Er())return!0;if((e=window.navigator.storage)!=null&&e.estimate)try{const{quota:t=0,usage:r=0}=await window.navigator.storage.estimate(),i=(t-r)/1024**3;return f.info("Storage",{availableGb:i}),i<Bi}catch{return!0}return!1},C=(()=>{const e=D.getItem("sprig.sessionId");if(e)return f.info("SessionIDFound",{savedSessionId:e}),D.removeItem("sprig.sessionId"),e;const t=oe();return f.info("GeneratedSessionID",{uuid:t}),t})(),ct=()=>{D.setItem("sprig.disableReplayRecording","disabled")},$=()=>!!D.getItem("sprig.disableReplayRecording");window.addEventListener("beforeunload",()=>{f.info("BeforeUnload",{sessionId:C}),D.setItem("sprig.sessionId",C)});const Fi=()=>$()?f.debug("ReplayDisabled-PendingHeatmaps"):T(async()=>{const t=(await v.getPendingCaptures({isHeatmap:!0})).map(r=>({eventId:r.captureParams.eventId,uuid:r.uuid})).filter(({eventId:r})=>!Mt(r)).map(({uuid:r})=>r);f.info("PendingHeatmapsToComplete",{count:t.length}),t.length&&(await v.markPendingHeatmapsReady(t),f.info("MarkedPendingHeatmapsReady"))},"Error marking pending heatmaps ready"),Hi=e=>{Date.now()-e>=Mi&&T(()=>v.markPendingHeatmapsReady(),"Error in heatmap inactivity")},lt=e=>e&&e.trim().substring(0,500).replace(/\s\s+/g," ").replace(/\r?\n|\r/g," ").substring(0,250),q=(e,t)=>{var r,i;if(!($()||!b.isRecording))try{(i=(r=window.rrwebRecord)==null?void 0:r.addCustomEvent)==null||i.call(r,e,t)}catch(n){Me("Error recording custom event",n)}},Vi=e=>{e.description&&(e.description=lt(e.description)),q("Sprig_PageView",e)},Wi=e=>{var t;(t=e==null?void 0:e.elementAttributes)!=null&&t.text&&(e.elementAttributes.text=lt(e.elementAttributes.text)),q("Sprig_Click",e)},ji=e=>{q("Sprig_TrackEvent",e)},$i=e=>{q("Sprig_ShowSurvey",e)},qi=e=>{q("Sprig_SubmitSurvey",e)},zi=e=>{q("Sprig_Refresh",e)},Ki=e=>{e.currentPageTitle&&(e.currentPageTitle=lt(e.currentPageTitle)),q("Sprig_BackForward",e)},Gi=e=>{q("Sprig_Keystroke",e)},Yi=async e=>{const{x:t,xPath:r,y:i}=e,n=b.scrollEventUuids[r];if(n)return T(async()=>{var a,d,u,c;const s=await v.openDB(),o=await s.get("events",n);if(o!=null&&o.event){const l=JSON.parse(o.event),g=t>((d=(a=l.data)==null?void 0:a.payload)==null?void 0:d.x),p=i>((c=(u=l.data)==null?void 0:u.payload)==null?void 0:c.y);if(!(g||p))return null;g&&(l.data.payload.x=t),p&&(l.data.payload.y=i),l.data.payload.elementAttributes=e.elementAttributes,o.event=JSON.stringify(l),await s.put("events",o)}else q("Sprig_Scroll",e)},"Error updating scroll event");q("Sprig_Scroll",e)},Ji=()=>b.isRecording,kr=()=>{b.stopRecording&&(b.stopRecording(),b.stopRecording=void 0),b.isRecording=!1,["cleanupInterval","inactivityInterval","pendingCheckInterval"].forEach(e=>{b[e]&&(clearInterval(b[e]),b[e]=void 0)}),Oi()},Qi=["did not allow mutations","called in an invalid security context"],Xi=e=>{if(!e)return!0;for(const t of Qi)if(e.toLowerCase().includes(t))return!1;return!0},Zi=(e,t,{reportError:r=!0,extraInfo:i={}})=>{if(!$()&&t instanceof Error){if(ct(),t.name==="VersionError")return f.error("VersionErr",{message:e}),v.deleteDB();Xi(t==null?void 0:t.message)&&(r&&window.UserLeap.reportError(e,t,i),v.clearAll())}},Me=(e,t,{reportError:r}={reportError:!0})=>{kr(),f.error("ReplayErr",{code:t.code,name:t.name}),Zi(e,t,{reportError:r})},T=async(e,t)=>{try{await e()}catch(r){Me(t,r)}},es=()=>{b.isRecording&&T(()=>{var e,t;return(t=(e=window.rrwebRecord)==null?void 0:e.takeFullSnapshot)==null?void 0:t.call(e,!0)},"Error recording full snapshot")},ts=async({surveyId:e,responseGroupUuid:t,eventDigest:r,headers:i})=>{if(!e||!t)return!1;const n=window.UserLeap._API_URL,s=await dr({surveyId:e,responseGroupUuid:t,eventDigest:r,apiUrl:n,headers:i},!0);return!(s!=null&&s.error)},_r=30,rs=1;(()=>{Er()&&(ot("replayStorage").catch(console.error),ot("sprig.replay").catch(console.error))})();class ns{openDB(){return vi("sprigReplay",rs,{upgrade:(t,r,i)=>{if(i===0&&D.setItem("sprig.pendingCount","0"),!t.objectStoreNames.contains("events")){const n=t.createObjectStore("events",{keyPath:"uuid"});n.createIndex("sessionId","sessionId"),n.createIndex("timestamp","timestamp"),n.createIndex("[sessionId+timestamp]",["sessionId","timestamp"])}if(!t.objectStoreNames.contains("chunkUploads")){const n=t.createObjectStore("chunkUploads",{keyPath:"uuid"});n.createIndex("sessionId","sessionId"),n.createIndex("timestamp","timestamp"),n.createIndex("[sessionId+status]",["sessionId","status"]),n.createIndex("[uploadId+status]",["uploadId","status"]),n.createIndex("[sessionId+status+uploadId]",["sessionId","status","uploadId"])}if(!t.objectStoreNames.contains("pendingCaptures")){const n=t.createObjectStore("pendingCaptures",{keyPath:"uuid"});n.createIndex("sessionId","sessionId"),n.createIndex("timestamp","timestamp"),n.createIndex("[sessionId+targetTimestamp]",["sessionId","targetTimestamp"])}}})}deleteDB(){return ot("sprigReplay").catch(console.error)}async bulkAdd(t,r){const i=(await this.openDB()).transaction(t,"readwrite");return Promise.all([...r.map(n=>i.store.add(n)),i.done])}async clearAll(){const t=(await this.openDB()).transaction(["events","chunkUploads","pendingCaptures"],"readwrite");return Promise.all([t.objectStore("events").clear(),t.objectStore("chunkUploads").clear(),t.objectStore("pendingCaptures").clear()])}async deleteBySessionId(t,r){const i=IDBKeyRange.only(r),n=(await this.openDB()).transaction(t,"readwrite"),s=n.store.index("sessionId");for await(const o of s.iterate(i))await o.delete();await n.done}async updatePartial(t,r,i){const s=(await this.openDB()).transaction(t,"readwrite"),o=await s.store.get(r);o&&await s.store.put({...o,...i}),await s.done}async deleteRowsBefore(t,r,i=()=>!0){const n=IDBKeyRange.upperBound(r,!0),s=(await this.openDB()).transaction(t,"readwrite"),o=s.store.index("timestamp");for await(const a of o.iterate(n))i(a.value)&&await a.delete();await s.done}async getEventsBetween(t,r=Date.now()){if(t>=r)return Promise.resolve([]);const i=IDBKeyRange.bound([C,t],[C,r],!1,!0);return(await this.openDB()).getAllFromIndex("events","[sessionId+timestamp]",i)}async updateEventsExpiredAt(t,r,i=_r){const n=new Date,s=n.setMinutes(n.getMinutes()+(i??_r)),o=(await this.openDB()).transaction("events","readwrite"),a=o.store.index("[sessionId+timestamp]"),d=IDBKeyRange.bound([C,t],[C,r],!1,!0);for await(const u of a.iterate(d))await u.update({...u.value,expiredAt:s});await o.done}async deleteChunkUploads(t,r){const i=IDBKeyRange.only([r,t]),n=(await this.openDB()).transaction("chunkUploads","readwrite");let o=await n.store.index("[uploadId+status]").openCursor(i);for(;o;)o.delete(),o=await o.continue();await n.done}async getChunkUploadsByStatus({sessionId:t,status:r,uploadId:i}){const s=(await this.openDB()).transaction("chunkUploads","readonly"),o=i?s.store.index("[uploadId+status]"):s.store.index("[sessionId+status]"),a=i?IDBKeyRange.only([i,r]):IDBKeyRange.only([t,r]);return o.getAll(a)}async getPendingCaptures(t={}){return(await(await this.openDB()).getAllFromIndex("pendingCaptures","sessionId",C)).filter(n=>!t.beforePresent||n.targetTimestamp<Date.now()).filter(n=>!t.isBeforeType||n.captureParams.replayParams.replayDurationType==="before").filter(n=>!t.isHeatmap||(n.captureParams.isHeatmap??!1))}async markPendingCaptureToCanUpload(t){const r=(await this.openDB()).transaction("pendingCaptures","readwrite"),i=r.store.index("sessionId");for await(const n of i.iterate(C)){const s=n.value;s.captureParams.responseGroupId===t&&await n.update({...s,canUpload:!0})}await r.done}async markPendingHeatmapsReady(t){if(parseInt(D.getItem("sprig.pendingCount")??"0")===0)return null;const i=Date.now(),n=(await this.openDB()).transaction("pendingCaptures","readwrite"),s=n.store.index("sessionId");for await(const o of s.iterate(C)){const a=o.value;a.captureParams.isHeatmap&&(!t||t.includes(a.uuid))&&await o.update({...a,targetTimestamp:i,captureParams:{...a.captureParams,triggerTimestamp:i,replayParams:{...a.captureParams.replayParams,replayDurationSeconds:Math.floor((i-a.timestamp)/1e3)}}})}await n.done}}const v=new ns,Rr=async(e,t)=>{const r=performance.now();let i;try{i=await e()}finally{const n=performance.now()-r;let s=fe[t];s||(s=W(t)),s.report(n/1e3)}return i},Dr=(e,t)=>{const r=performance.now();try{e()}finally{const i=performance.now()-r;let n=fe[t];n||(n=W(t)),n.report(i/1e3)}};let Cr=5e3,ut=6e4,pt=0;const is=5,xr=30,Be=xr+is;let Z,wt=!1,ft=[];const ss=async({maxReplayDurationSeconds:e,maxInflightRequests:t=2,replaySettings:r,teardownAfter:i=!1})=>{if(Z=D.getItem("sprig.pendingCount"),!b.isRecording){if(i&&D.setItem("sprig.teardownAfterCapture","true"),$())return f.debug("ReplayDisabled");if(await Ni())return f.debug("IDBNotSupported"),ct();try{const n=await v.openDB();f.info("DBVersion",{version:n.version})}catch(n){return f.error("ReplayOpenErr",{name:n.name}),n.name==="VersionError"&&v.deleteDB(),ct()}if(T(async()=>{await Ar(!0)},"Error uploading ready pending captures"),!e)return f.debug("MissingDuration");f.debug("ReplayInit"),await T(async()=>{if(r!=null&&r.minDuration&&(Cr=r.minDuration),r!=null&&r.batchDuration&&(ut=r.batchDuration),ui(t),ws(),cs(e+Be,30*60,e+Be),ls(),!window.rrwebRecord){const{record:a}=await import(window.UserLeap.replayLibraryURL??"https://cdn.sprig.com/dependencies/record-2.0.0-alpha.17.min.js");window.rrwebRecord=a}const n=window.rrwebRecord;if(!n)return f.error("RecordScriptFailed");let s=!0,o=0;b.stopRecording=n({checkoutEveryNms:xr*1e3,sampling:{input:"last",scroll:250,media:800},emit:(a,d)=>{if(a.type===he.Custom&&(pt=Date.now()),$())return;if(d&&a.type===he.Meta)o=performance.now();else if(d&&o&&a.type===he.FullSnapshot){const c=performance.now()-o;Gt("sdk_replay_snapshot_seconds",c/1e3)}const u=s||!!d&&a.type===he.Meta;s=!1,os({uuid:oe(),event:JSON.stringify(a),isValidStart:u,timestamp:Date.now()})},...r}),b.isRecording=!!b.stopRecording,b.isRecording&&(m.on("survey.complete",a=>{qi({id:a,userAgent:window.navigator.userAgent})}),Pi())},"Error initializing replay")}},os=e=>{var t,r,i,n;if((t=e.event)!=null&&t.includes("Sprig_Scroll")){const s=(n=(i=(r=JSON.parse(e.event))==null?void 0:r.data)==null?void 0:i.payload)==null?void 0:n.xPath;if(!s)return;b.scrollEventUuids[s]=e.uuid}ft.push(e),wt||ds()},as=async e=>{const t=e.map(r=>({...r,sessionId:r.sessionId??C}));if(t.length!==0)return T(()=>v.bulkAdd("events",t),"Error storing replay events")},ds=()=>{wt=!0,setTimeout(async()=>{if($())return;const e=ft;ft=[],wt=!1,Dr(async()=>{await as(e)},"sdk_replay_add_event_batch_seconds")},500)},cs=(e,t,r)=>{b.cleanupInterval=window.setInterval(()=>{const i=Date.now();Rr(()=>T(async()=>{$()||await Promise.all([v.deleteRowsBefore("events",i-e*1e3,n=>n.expiredAt===void 0||n.expiredAt<i-e*1e3),v.deleteRowsBefore("chunkUploads",i-t*1e3),v.deleteRowsBefore("pendingCaptures",i-r*1e3,n=>!n.canUpload)])},"Error deleting table rows"),"sdk_replay_cleanup_seconds"),f.debug("CleanupComplete")},3e4)},ls=()=>{b.pendingCheckInterval=window.setInterval(async()=>{T(async()=>{await Ar()},"Error initiating pending captures")},5e3)},Ar=async(e=!1)=>{const t=parseInt(Z??"0");if(t===0)return;const r=await v.getPendingCaptures({beforePresent:!0,isBeforeType:e}),i=await v.openDB();await Promise.all(r.map(async n=>(await i.delete("pendingCaptures",n.uuid),Mr(n.captureParams,n.canUpload)))),Z=(t-r.length).toString(),D.setItem("sprig.pendingCount",Z)},us=async(e,t,r,i,n)=>{const s=Math.min(e+n,r),o=await Rr(()=>v.getEventsBetween(e,s),"sdk_replay_get_events_between_seconds");if(!(o!=null&&o.length))return f.debug("NoEventsFound"),{validStartFound:i,events:[]};if(!i){f.debug("ValidStartSearch");let a=-1;return o==null||o.forEach((d,u)=>{if(!d.isValidStart)return;const c=d.timestamp<=t;(a<0||c)&&(a=u)}),a<0?(f.debug("ValidStartNotFound"),{validStartFound:i,events:[]}):{validStartFound:!0,events:o==null?void 0:o.slice(a)}}return{validStartFound:i,events:o}},ps=(e,t,r)=>{const i=e.length,n=t*1024*1024,s=Math.ceil(i/r),o=Math.max(n,s),a=[];let d=0;for(;d<i;)a.push(e.slice(d,d+o)),d+=o;return a},Tr=e=>Promise.all(e.map(async t=>{const r=await pi(t);return await v.updatePartial("chunkUploads",t.uuid,{data:null,etag:r,status:"UploadComplete"}),t.uploadId})),Pr=async e=>{const t=await v.getChunkUploadsByStatus({status:"UploadComplete",uploadId:e});if(!(t!=null&&t.length)){f.info("NoChunksForUpload",{uploadId:e});return}const r=t.reduce((s,o)=>(s.find(a=>a.chunkIndex===o.chunkIndex)||s.push(o),s),[]);r.sort((s,o)=>s.chunkIndex-o.chunkIndex);const i=r.map(s=>({ETag:s.etag,PartNumber:s.chunkIndex})).filter(s=>s.ETag!==null),n=r[0];await dr({apiUrl:n.apiUrl,surveyId:n.surveyId,uploadId:e,responseGroupUuid:n.responseGroupId,etags:i,headers:n.completeUploadHeaders,replayDuration:n.replayDuration}),await v.deleteChunkUploads("UploadComplete",e)},ws=()=>{T(async()=>{const e=await v.getChunkUploadsByStatus({sessionId:C,status:"ReadyForUpload"});if(!(e!=null&&e.length))return;const t=await Tr(e);t!=null&&t.length&&await Promise.all(t.map(r=>{if(r)return Pr(r)}))},"Error uploading unfinished chunks")},fs=async(e,t)=>{await Tr(t),await Promise.all(e.map(r=>Pr(r)))},ms=async(e,t)=>{const r=new TextEncoder;let i=null;const n=new CompressionStream("gzip"),s=n.writable.getWriter();let o=!1,a=!1,[d,u]=[0,0];const c=e-Be*1e3;let l=[];for(let p=c;p<t;p+=ut){if({validStartFound:a,events:l}=await us(p,e,t,a,ut),!(l!=null&&l.length)){f.debug("NoEventsFound");continue}d===0&&(d=l[0].timestamp),u=l[l.length-1].timestamp;const y=l.map(_=>_.event);y.push(`{"timestamp":${t}}`);const U=`${o?",":"["}${y}`,P=r.encode(U);Dr(()=>{s.write(P)},"sdk_replay_compression_seconds"),o=!0}if(u-d<Cr)return f.debug("ReplayTooShort"),null;const g=r.encode("]");return s.write(g),s.close(),i=new Uint8Array(await new Response(n.readable).arrayBuffer()),i},gs=async(e,t)=>{const r=t??Date.now(),i=r-e;return ms(i,r)},Or=async e=>{const{surveyId:t,responseGroupId:r,visitorId:i,apiUrl:n,completeUploadHeaders:s,replayParams:o,triggerTimestamp:a}=e,d=await gs(o.replayDurationSeconds*1e3,a);if(!(d!=null&&d.length)){f.info("FileDataEmpty",{surveyId:t});return}const u=ps(d,o.minimumChunkSizeMb,o.signedUrls.length),c=await Promise.all(u.map(async(l,g)=>{const p=oe(),y={apiUrl:n,chunkIndex:g+1,completeUploadHeaders:s,etag:null,responseGroupId:r,status:"ReadyForUpload",surveyId:t,timestamp:a,totalChunks:u.length,data:l,uploadId:o.uploadId,uploadUrl:o.signedUrls[g].url,uuid:p,visitorId:i};return await(await v.openDB()).add("chunkUploads",{...y,sessionId:y.sessionId??C}),y}));await fs([o.uploadId],c)},Mr=async(e,t)=>{if($())return f.debug("ReplayDisabled-ScheduleOrCapture");const{isHeatmap:r,isStandalone:i,replayParams:n,triggerTimestamp:s,responseGroupId:o}=e,a=async()=>{setTimeout(()=>m.removeListener(w.QuestionAnswered,a),0),T(async()=>{n.replayDurationType==="before"?await Or(e):await v.markPendingCaptureToCanUpload(o)},"Error in schedule/capture callback")};T(async()=>{if(n.replayDurationType==="after"||n.replayDurationType==="beforeAndAfter"){!i&&!r&&m.on(w.QuestionAnswered,a),await Nr(e);return}if(i||r||t)await Or(e),r&&ys();else{const u=Be+n.replayDurationSeconds,c=s-u*1e3,l=s;await v.updateEventsExpiredAt(c,l,n.expirationTimeLimitMinutes),m.on(w.QuestionAnswered,a)}},"Error in scheduling/capturing replay")},ys=async()=>{parseInt(Z??"0")||D.removeItem("sprig.isCapturingHeatmap"),D.getItem("sprig.teardownAfterCapture")&&(kr(),Br(),D.removeItem("sprig.teardownAfterCapture"))},Br=async()=>$()?f.debug("ReplayDisabled-ClearData"):Promise.all([v.deleteBySessionId("events",C),v.deleteBySessionId("pendingCaptures",C)]).catch(e=>{Me("Error clearing user replay data",e)}),Nr=async e=>{if($())return;const{isHeatmap:t,surveyId:r}=e,i=await v.getPendingCaptures(),n=i==null?void 0:i.filter(d=>d.captureParams.surveyId===r);if(n!=null&&n.length){f.info("PendingCaptureExists",{surveyId:r});return}t&&(es(),D.setItem("sprig.isCapturingHeatmap","true"),pt=Date.now(),b.inactivityInterval||(b.inactivityInterval=window.setInterval(()=>{Hi(pt)},1e3)));const s={...e,replayParams:{...e.replayParams}};e.replayParams.replayDurationType==="beforeAndAfter"&&(s.replayParams.replayDurationSeconds*=2),s.replayParams.replayDurationType="before";const o=e.triggerTimestamp+e.replayParams.replayDurationSeconds*1e3;s.triggerTimestamp=o,Z=(parseInt(Z??"0")+1).toString(),D.setItem("sprig.pendingCount",Z),await(await v.openDB()).add("pendingCaptures",{canUpload:!1,captureParams:s,sessionId:C,targetTimestamp:o,timestamp:Date.now(),uuid:oe()})};nn(Object.freeze(Object.defineProperty({__proto__:null,RecordEvent:ji,RecordPageView:Vi,RecordSurveyShown:$i,_completeSessionReplay:ts,checkPendingHeatmapsUrl:Fi,clearUserReplayData:Br,disableRecording:Me,initializeReplay:ss,isReplayRecording:Ji,scheduleCapture:Nr,scheduleOrCaptureReplay:Mr,tryReplayAction:T},Symbol.toStringTag,{value:"Module"})));const hs="sprig-web-view-sdk";let Fr;Fr={path:`https://cdn.sprig.com/${hs}-v2.32.10.js`},ci(Fr)})();

//# debugId=b89b5d66-bd0d-5d8b-ad53-1fa2d92c08e3
