(function(){"use strict";var Co=Object.defineProperty;var Ao=(V,G,ce)=>G in V?Co(V,G,{enumerable:!0,configurable:!0,writable:!0,value:ce}):V[G]=ce;var _=(V,G,ce)=>Ao(V,typeof G!="symbol"?G+"":G,ce);let V;const G=new Uint8Array(16);function ce(){if(!V&&(V=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!V))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return V(G)}const D=[];for(let e=0;e<256;++e)D.push((e+256).toString(16).slice(1));function Ar(e,t=0){return D[e[t+0]]+D[e[t+1]]+D[e[t+2]]+D[e[t+3]]+"-"+D[e[t+4]]+D[e[t+5]]+"-"+D[e[t+6]]+D[e[t+7]]+"-"+D[e[t+8]]+D[e[t+9]]+"-"+D[e[t+10]]+D[e[t+11]]+D[e[t+12]]+D[e[t+13]]+D[e[t+14]]+D[e[t+15]]}const Kt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function le(e,t,n){if(Kt.randomUUID&&!e)return Kt.randomUUID();e=e||{};const i=e.random||(e.rng||ce)();return i[6]=i[6]&15|64,i[8]=i[8]&63|128,Ar(i)}const Tr='.ul-loading-spinner-container{font-size:1.8rem;flex-grow:1;width:100%;height:100%;display:flex;align-items:center;justify-content:center}.ul-loading-spinner{display:inline-block;position:relative;width:6rem;height:6rem}.ul-loading-spinner div{box-sizing:border-box;display:block;position:absolute;width:80%;height:80%;margin:5px;border:5px solid #152e3e;border-radius:50%;animation:lds-ring 1.2s cubic-bezier(.5,0,.5,1) infinite;border-color:#152e3e transparent transparent transparent}.ul-loading-spinner .first{animation-delay:-.45s}.ul-loading-spinner .second{animation-delay:-.3s}.ul-loading-spinner .third{animation-delay:-.15s}@keyframes lds-ring{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.fade-in-transition{animation:fadeIn .4s ease-in}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}#sprig-feedback-button{border-left:0;border-radius:0 8px 8px 0;display:grid;padding:8px;text-align:center;transition:all ease-in-out 1s;z-index:inherit}#sprig-feedback-button:hover{cursor:pointer}.sprig-feedback-button-label{writing-mode:vertical-lr;text-orientation:sideways}.sprig-feedback-button-right{transform:rotate(180deg)}.sprig-feedback-button-bottom{align-self:flex-end;margin-bottom:20px}.sprig-feedback-button-light{background:#efefee;color:#000;border:1px solid #e2e3e1}.sprig-feedback-button-dark{background:#000;color:#fff;border:1px solid #000000}#sprig-feedback-container{display:flex;align-items:center;position:fixed;transition:right .2s linear,left .2s linear;z-index:2147483646}.sprig-feedback-container-left{flex-flow:row-reverse}.sprig-feedback-container-center{top:50%;transform:translateY(-50%)}.sprig-feedback-container-bottom{bottom:0%;margin-bottom:15px}.sprig-feedback-loading-container{align-items:center;background-color:#fff;border:2px solid var(--feedback-border);display:flex;max-height:90vh;max-width:90vw;min-width:0px}.sprig-feedback-loading-container-left{border-left:none;border-radius:0 8px 8px 0}.sprig-feedback-loading-container-right{border-right:none;border-radius:8px 0 0 8px}#sprig-feedback-error-container{margin:auto;text-align:center;width:360px}.sprig-feedback-error-text{font-weight:400;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol}#sprig-feedback-loading-container .ul-container{position:relative;max-height:inherit}#sprig-feedback-loading-animation{position:absolute}.sprig-feedback-loading-container-previews iframe{max-height:inherit!important}',xr="360px",Pr=500;var W=(e=>(e.Closed="close.click",e.Complete="survey.completed",e.FeedbackClosed="feedback.closed",e.PageChange="page.change",e.API="api",e.Override="override",e))(W||{}),f=(e=>(e.ReplayCapture="replay.capture",e.ReplayPaused="replay.paused",e.ReplayResumed="replay.resumed",e.FeedbackButtonLoaded="feedback.button.loaded",e.SDKReady="sdk.ready",e.SurveyAppeared="survey.appeared",e.SurveyCloseRequested="survey.closeRequested",e.SurveyClosed="survey.closed",e.SurveyDimensions="survey.dimensions",e.SurveyFadingOut="survey.fadingOut",e.SurveyHeight="survey.height",e.SurveyPresented="survey.presented",e.SurveyLifeCycle="survey.lifeCycle",e.SurveyWidth="survey.width",e.SurveyWillClose="survey.willClose",e.SurveyWillPresent="survey.will.present",e.CloseSurveyOnOverlayClick="close.survey.overlayClick",e.VisitorIDUpdated="visitor.id.updated",e.QuestionAnswered="question.answered",e))(f||{});const De={FEEDBACK_BUTTON_LOADED:"feedback.button.loaded",SDK_READY:"sdk.ready",SURVEY_APPEARED:"survey.appeared",SURVEY_CLOSED:"survey.closed",SURVEY_DIMENSIONS:"survey.dimensions",SURVEY_FADING_OUT:"survey.fadingOut",SURVEY_HEIGHT:"survey.height",SURVEY_WIDTH:"survey.width",SURVEY_PRESENTED:"survey.presented",SURVEY_LIFE_CYCLE:"survey.lifeCycle",SURVEY_WILL_CLOSE:"survey.willClose",SURVEY_WILL_PRESENT:"survey.will.present",QUESTION_ANSWERED:"question.answered",REPLAY_CAPTURE:"replay.capture",CLOSE_SURVEY_ON_OVERLAY_CLICK:"close.survey.overlayClick",VISITOR_ID_UPDATED:"visitor.id.updated",DATA:{DISMISS_REASONS:{API:"api",CLOSED:"close.click",COMPLETE:"survey.completed",PAGE_CHANGE:"page.change",OVERRIDE:"override"},SURVEY_ID:"survey.id"}},Or=300;class Mr{constructor(){_(this,"breadcrumbs",[])}getTimeStamp(){return new Date().toISOString()}addBreadcrumb(t){this.breadcrumbs.push(t),this.breadcrumbs.length>Or&&this.breadcrumbs.shift()}debug(t,n="debug"){this.addBreadcrumb({category:n,level:"info",message:t,timestamp:this.getTimeStamp(),type:"debug"})}error(t,n={}){this.addBreadcrumb({category:"error",data:n,level:"error",message:t,timestamp:this.getTimeStamp(),type:"error"})}http(t,n){this.addBreadcrumb({category:"xhr",data:n,message:t,timestamp:this.getTimeStamp(),type:"http"})}info(t,n={}){this.addBreadcrumb({category:"info",data:n,level:"info",message:t,timestamp:this.getTimeStamp(),type:"info"})}navigation(t,n){this.addBreadcrumb({category:"navigation",data:n,message:t,timestamp:this.getTimeStamp(),type:"navigation"})}}const w=new Mr,Gt=()=>{try{return window.parent.Intercom}catch{return null}},Yt=[Object.freeze(Object.defineProperty({__proto__:null,disable:()=>{const e=Gt();e&&(e.ul_wasVisible=!!document.querySelector("iframe.intercom-launcher-frame"),e.ul_wasVisible&&e("update",{hide_default_launcher:!0}))},enable:()=>{const e=Gt();e&&(e.ul_wasVisible&&e("update",{hide_default_launcher:!1}),delete e.ul_wasVisible)}},Symbol.toStringTag,{value:"Module"}))];class Br{static disable(){Yt.forEach(t=>t.disable())}static enable(){Yt.forEach(t=>t.enable())}}var Nr=class extends Error{constructor(e,t,n){super(`Possible EventEmitter memory leak detected. ${n} ${t.toString()} listeners added. Use emitter.setMaxListeners() to increase limit`),this.emitter=e,this.type=t,this.count=n,this.name="MaxListenersExceededWarning"}},Jt=class{static listenerCount(e,t){return e.listenerCount(t)}constructor(){this.events=new Map,this.maxListeners=Jt.defaultMaxListeners,this.hasWarnedAboutPotentialMemoryLeak=!1}_emitInternalEvent(e,t,n){this.emit(e,t,n)}_getListeners(e){return Array.prototype.concat.apply([],this.events.get(e))||[]}_removeListener(e,t){const n=e.indexOf(t);return n>-1&&e.splice(n,1),[]}_wrapOnceListener(e,t){const n=(...i)=>(this.removeListener(e,n),t.apply(this,i));return Object.defineProperty(n,"name",{value:t.name}),n}setMaxListeners(e){return this.maxListeners=e,this}getMaxListeners(){return this.maxListeners}eventNames(){return Array.from(this.events.keys())}emit(e,...t){const n=this._getListeners(e);return n.forEach(i=>{i.apply(this,t)}),n.length>0}addListener(e,t){this._emitInternalEvent("newListener",e,t);const n=this._getListeners(e).concat(t);if(this.events.set(e,n),this.maxListeners>0&&this.listenerCount(e)>this.maxListeners&&!this.hasWarnedAboutPotentialMemoryLeak){this.hasWarnedAboutPotentialMemoryLeak=!0;const i=new Nr(this,e,this.listenerCount(e));console.warn(i)}return this}on(e,t){return this.addListener(e,t)}once(e,t){return this.addListener(e,this._wrapOnceListener(e,t))}prependListener(e,t){const n=this._getListeners(e);if(n.length>0){const i=[t].concat(n);this.events.set(e,i)}else this.events.set(e,n.concat(t));return this}prependOnceListener(e,t){return this.prependListener(e,this._wrapOnceListener(e,t))}removeListener(e,t){const n=this._getListeners(e);return n.length>0&&(this._removeListener(n,t),this.events.set(e,n),this._emitInternalEvent("removeListener",e,t)),this}off(e,t){return this.removeListener(e,t)}removeAllListeners(e){return e?this.events.delete(e):this.events.clear(),this}listeners(e){return Array.from(this._getListeners(e))}listenerCount(e){return this._getListeners(e).length}rawListeners(e){return this.listeners(e)}},Qt=Jt;Qt.defaultMaxListeners=10;const g=new Qt,Ce=async e=>{await new Promise(t=>{setTimeout(t,e)})},Xt=({"userleap-platform":e})=>{var t;return((t=window.UserLeap)==null?void 0:t.forceDirectEmbed)||e!=="web"};class Zt{constructor(t){_(this,"storage");_(this,"tempStorage",{});_(this,"isStorageAvailable");try{this.storage=window[t];const n="__storage_test__";this.storage.setItem(n,n),this.storage.removeItem(n),this.isStorageAvailable=!0}catch{this.isStorageAvailable=!1}}setItem(t,n){this.isStorageAvailable&&this.storage?this.storage.setItem(t,n):this.tempStorage[t]=n}setItemObject(t,n){try{this.setItem(t,JSON.stringify(n))}catch(i){i instanceof Error&&(i.stack=t+": "+n,window.UserLeap.reportError("Failed to save to local storage",i))}}getItem(t){return this.isStorageAvailable&&this.storage?this.storage.getItem(t):this.tempStorage[t]}getItemObject(t){const n=this.getItem(t);if(n)try{return JSON.parse(n)}catch(i){i instanceof Error&&(i.stack=t+": "+n,window.UserLeap.reportError("Failed to parse local storage",i))}return{}}removeItem(t){this.isStorageAvailable&&this.storage?this.storage.removeItem(t):delete this.tempStorage[t]}clear(){this.isStorageAvailable&&this.storage?this.storage.clear():this.tempStorage={}}}const S=new Zt("sessionStorage"),T=new Zt("localStorage");class Fr{constructor(t){_(this,"payload");_(this,"promise");_(this,"reject",()=>{});_(this,"resolve",()=>{});this.payload=t,this.promise=new Promise((n,i)=>{this.reject=i,this.resolve=n})}resolveRequest(t){this.resolve(t)}}const L={replay:null},Hr=e=>{L.replay=e},Vr=()=>{const e=[];return L.replay&&e.push("replay"),e.join(",")},Wr={RATELIMIT_RESET_DEFAULT:10};let en=!1,tn="",Ae=!1,nn=!1,Te=[];const jr=e=>e._config&&e._config.installationMethod?e._config.installationMethod:e._gtm?"web-gtm":e._segment?"web-segment":"web-snippet",rn=e=>{var t;(t=e==null?void 0:e.blockedURI)!=null&&t.includes(window.UserLeap._API_URL)&&(nn=!0,console.warn(`[Sprig] ${e.blockedURI} is blocked by Content-Security-Policy`))},rt=(e="")=>{en=!0,tn=e};function N(e={}){const t={"Content-Type":"application/json","userleap-platform":"web","x-ul-sdk-version":"2.40.3","x-ul-installation-method":jr(e),"sprig-modules":Vr()};if(e.envId&&(t["x-ul-environment-id"]=e.envId),e.token&&(t.Authorization="Bearer "+e.token),e.userId&&(t["x-ul-user-id"]=e.userId),e.visitorId&&(t["x-ul-visitor-id"]=e.visitorId),e.partnerAnonymousId&&(t["x-ul-anonymous-id"]=e.partnerAnonymousId),e.mobileHeadersJSON){const n=JSON.parse(e.mobileHeadersJSON);Object.assign(t,n)}return e.locale&&(t["accept-language"]=e.locale),window.previewMode&&(t["x-ul-preview-mode"]="1"),t}const sn=async({shouldDropOnRateLimit:e,...t})=>{if(e)return{status:429};{const n=new Fr(t);return Te.push(n),n.promise}},Y=async(e,t)=>{const{retries:n=0,shouldDropOnRateLimit:i=!1,shouldRetryRequest:r=!1,...s}=t,o={url:e,options:s,retries:n,shouldDropOnRateLimit:i};if(Ae&&!r)return sn(o);const a={ok:!1,reportError:!1};if(en)return console.info(`UserLeap - ${tn}`),a;try{const d=await fetch(e,s);if(d.status===429)if(!Ae&&!i||r){Ae=!0;const u=d.headers.has("ratelimit-reset")?Number(d.headers.get("ratelimit-reset")):Wr.RATELIMIT_RESET_DEFAULT;return await Ce(u*1e3),Y(e,{...s,shouldDropOnRateLimit:i,shouldRetryRequest:!0})}else return sn(o);if(Ae=!1,Te.length&&(Te.map(l=>{const u=l.payload;Y(u.url,{...u.options,retries:u.retries,shouldDropOnRateLimit:u.shouldDropOnRateLimit}).then(c=>{l.resolveRequest(c)})}),Te=[]),d.ok){if(d.status===249)return rt(),a;const l=await d.text();try{return l&&l!=="OK"&&(d.json=JSON.parse(l)),d}catch{return{ok:!1,reportError:!1,error:new Error(`failed parsing response json for ${e} - ${l}`)}}}return d}catch(d){const l=n+1;return l>5||nn?{ok:!1,reportError:!1,error:d}:(await Ce(Math.pow(2,n)*1e3),Y(e,{...s,retries:l}))}},on="ul-view-sdk-script",qr="ios",$r="android",zr=new Set([qr,$r]),Z="visitors",ee="environments";async function j(e,t){var s,o,a;const{shouldDropOnRateLimit:n,...i}=t;i.headers=Object.assign(N(window.UserLeap),i.headers);const r=await Y(e,{...i,shouldDropOnRateLimit:n});if(r.ok){const d=(s=r.headers)==null?void 0:s.get("Authorization"),l=d?d.split(" "):void 0,u=l&&l.length===2?l[1]:void 0,c=(o=r.headers)==null?void 0:o.get("x-ul-visitor-id");if(window.UserLeap.userId&&c===window.UserLeap.visitorId){const m=T.getItemObject("sprig.anon.env.vid.map");m&&m[window.UserLeap.envId]===c&&(delete m[window.UserLeap.envId],T.setItemObject("sprig.anon.env.vid.map",m))}u&&c&&(c!==window.UserLeap.visitorId||window.UserLeap.token!==u)&&(x("token",u),x("vid",c),g.emit(f.VisitorIDUpdated,{visitorId:c}),window.UserLeap.token=u,window.UserLeap.visitorId=c)}return(a=r.json)!=null&&a.logMessage&&console.warn(`[Sprig] ${r.json.logMessage}`),r}function x(e,t){const n=T.getItemObject("userleap.ids");let i=n[window.UserLeap.envId];i?i[e]=t:i={[e]:t},n[window.UserLeap.envId]=i,T.setItemObject("userleap.ids",n)}function it(){return window.previewMode?"0":window.UserLeap.visitorId??""}function F(e,t,n){const i=[window.UserLeap._API_URL,"sdk",e];return t&&t.forEach(r=>{i.push(r),r===ee?i.push(window.UserLeap.envId):r===Z&&i.push(it())}),n&&i.push(n),i.join("/")}const Kr=()=>{const e=N(window.UserLeap),t=ye(e),n=window.UserLeap.forceDirectEmbed,i=e["userleap-platform"]==="web";return t||n&&i},me=async(e,t,n)=>{var kr,_r,Rr,Dr;const{context:i,delay:r,avatars:s,forceBrandedLogo:o,endCard:a,isFeedback:d=!1,heatmap:l,locale:u,layout:c,previewMode:m,productConfig:p,questions:y,responseGroupUid:h,surveyId:I,uuid:k,vid:R,sessionReplay:B,studyType:_e,surveyVisitorAttributes:de}=e,A=N(window.UserLeap),M=ye(A),Ze=xe(A);if(B)if(M)g.emit(f.ReplayCapture,{responseGroupUid:h,hasQuestions:!!(y!=null&&y.length),surveyId:I,uploadId:B.uploadId,replayType:B.replayDurationType??"before",seconds:B.replayDurationSeconds,generateVideoUploadUrlPayload:{mediaRecordingUid:le(),mediaType:"screen",questionId:1,responseGroupUid:h,surveyId:I,updatedAt:new Date().toISOString(),visitorId:window.UserLeap.visitorId,isReplay:!0}});else{if(!L.replay)return window.UserLeap.reportError("displayQuestions",new Error("Replay module not registered")),{success:!1,message:"Replay module not registered",surveyState:"no survey"};L.replay.scheduleOrCaptureReplay({responseGroupId:h,surveyId:I,visitorId:R,replayParams:B,completeUploadHeaders:A,apiUrl:window.UserLeap._API_URL,triggerTimestamp:Date.now(),isStandalone:y.length===0})}if(l){if(!L.replay)return window.UserLeap.reportError("displayQuestions",new Error("Replay module not registered")),{success:!1,message:"Replay module not registered",surveyState:"no survey"};const{eventId:E,replayParams:zt,responseGroupUid:Ro,surveyId:Do}=l;await L.replay.initializeReplay({maxReplayDurationSeconds:300,maxInflightRequests:window.UserLeap.maxInflightReplayRequests,teardownAfter:!0,apiUrl:window.UserLeap._API_URL,replaySettings:n}),L.replay.tryReplayAction(()=>{var Cr;return(Cr=L.replay)==null?void 0:Cr.scheduleCapture({apiUrl:window.UserLeap._API_URL,completeUploadHeaders:A,eventId:E,isHeatmap:!0,replayParams:zt,responseGroupId:Ro,surveyId:Do,triggerTimestamp:Date.now(),visitorId:R})},"Error in scheduling/capturing replay")}if(R==null||!(y!=null&&y.length))return w.info("CannotDisplaySurvey",{vid:R}),{success:!1,message:"[Sprig] no survey found",surveyState:"no survey"};if(window.UserLeap.container){w.info("AlreadyDisplayingSurvey");const E="[Sprig] (ERR-409) Found an existing Survey container, aborting rendering of this survey";return console.warn(E),{success:!1,message:E,surveyState:"no survey"}}if(R!==window.UserLeap.visitorId&&k!==window.UserLeap.visitorId&&!window.previewMode){const E="Attempted to display survey to a different visitor";return window.UserLeap.reportError("DisplaySurvey",new Error(E)),{success:!1,message:E,surveyState:"no survey"}}w.info("ShowingSurvey",{surveyId:I}),(kr=L.replay)==null||kr.RecordSurveyShown({id:I,userAgent:window.navigator.userAgent}),Br.disable(),g.emit(f.SurveyWillPresent,{name:f.SurveyWillPresent,"survey.id":I,layout:c});let et,tt=document.createElement("div"),Re,H,nt;const Sr=E=>{const{"view.version":zt}=E;zt!==A["x-ul-sdk-version"]&&cn(),g.removeListener("verify.view.version",Sr)};g.on("verify.view.version",Sr),window.UserLeap.useMobileStyling=Ze,Xt(A)?(et="ul-direct-embeded-frame",Re=document.head,H=window,nt=!1,Kr()&&(dn(I,d),tt.id=et,window.UserLeap.container.appendChild(tt),ln(),g.emit(f.SurveyLifeCycle,{state:"presented"}),g.emit(f.SurveyPresented,{name:f.SurveyPresented,"survey.id":I}))):{frameId:et,contentWinDocHead:Re,contentWindow:H,hasOverlay:nt,iframe:tt}=ti({productConfig:p,useMobileStyling:Ze,surveyId:I,isFeedback:d,enableCspTrustedTypes:(_r=window.UserLeap._config)==null?void 0:_r.enableCspTrustedTypes}),window.UserLeap.frameId=et;const Eo=E=>{g.once(f.CloseSurveyOnOverlayClick,E)},ge={apiURL:window.UserLeap._API_URL,avatars:s,cards:y,configureExitOnOverlayClick:Eo,context:i,endCard:a,envId:window.UserLeap.envId,eventEmitFn:g.emit.bind(g),fontFamily:window.UserLeap.fontFamily,fontFamilyURL:window.UserLeap.fontFamilyURL,forceBrandedLogo:o,frame:tt,headers:A,layout:c,locale:u,mobileSDKVersion:window.UserLeap.mobileSDKVersion,previewKey:T.getItem("sprig.previewKey"),previewMode:m,productConfig:{framePosition:p==null?void 0:p.framePosition,desktopDisplay:p==null?void 0:p.desktopDisplay,placement:p==null?void 0:p.placement},responseGroupUid:h,startingQuestionIdx:(Rr=window.UserLeap.config)==null?void 0:Rr.startingQuestionIdx,studyType:_e,styleNonce:window.UserLeap.styleNonce,surveyId:I,tabTitle:document.title,trackPageViewUrl:t,ulEvents:De,upchunkLibraryURL:window.UserLeap.upchunkLibraryURL,useMobileStyling:Ze,userId:k,viewDocument:H==null?void 0:H.document,viewWindow:H,visitorAttributes:{externalUserId:window.UserLeap.userId,email:window.UserLeap.email},surveyVisitorAttributes:de||{},...window.UserLeap._config};(Dr=window.UserLeap._config)!=null&&Dr.startingQuestionIdx&&(window.UserLeap._config={...window.UserLeap._config,startingQuestionIdx:null});const ko=(d?window.UserLeap.feedbackCustomStyles:window.UserLeap.customStyles)??p.customStyles;ge.customStyles=ko,H&&(H.__cfg=ge);function _o(){const E=document.createElement("script");return window.UserLeap.isMobileSDK||E.setAttribute("type","module"),window.UserLeap.nonce&&E.setAttribute("nonce",window.UserLeap.nonce),E.id=on,E}const qt=window.UserLeap.viewSDKURL?window.UserLeap.viewSDKURL:ge.path,Ur=document.getElementById(on);Ur&&Ur.remove();const $t=_o(),Ir=()=>{window.UserLeap.container&&Object.assign(window.UserLeap.container.style,{display:"flex"})};if(ge.installationMethod==="web-npm"||ge.installationMethod==="web-npm-bundled"){const{default:E}=await import("../view/view.tsx");E.configure(ge),nt&&window.UserLeap.container&&Ir()}else qt&&($t.src=`${qt}${window.UserLeap.isMobileSDK?"":`?t=${Date.now()}`}`,nt&&$t.addEventListener("load",()=>{window.UserLeap.container&&Ir()}),H==null||H.addEventListener("error",E=>{E.target instanceof HTMLScriptElement&&E.target.src===qt&&window.UserLeap.reportError("loadFrameScript",new Error("Frame script failed to load"))},{capture:!0,once:!0}));Re==null||Re.appendChild($t);const Er={success:!0,surveyState:"ready",surveyId:I,responseGroupUid:h};return window.UserLeap.isMobileSDK&&r&&(Er.delay=r),Er};function xe(e){var n;if(window.UserLeap.useMobileStyling!==void 0)return window.UserLeap.useMobileStyling;const t=((n=window.UserLeap.windowDimensions)==null?void 0:n.width)??document.body.clientWidth;return ye(e)||t>10&&t<Pr}function ye(e){return zr.has(e["userleap-platform"])}const an=new WeakMap,Gr="sprig-sdk",Yr=e=>{var i,r;const t=an.get(e);if(t)return t;if(!((i=e.trustedTypes)!=null&&i.createPolicy))throw new Error("Trusted types not supported");const n=(r=e.trustedTypes)==null?void 0:r.createPolicy(Gr,{createHTML(s){return s},createScript(s){return s},createScriptURL(s){return s}});return an.set(e,n),n},Jr=(e,t)=>{try{return Yr(t).createHTML(e)}catch(n){return console.warn("Could not create TrustedHTML object",n),e}},st=(e,t,n=window)=>{var i;return t&&((i=n.trustedTypes)!=null&&i.createPolicy)?Jr(e,n):e},ot="ul-frame";window.UserLeap&&window.Sprig&&(window.Sprig._gtm?window.Sprig=window.UserLeap:window.UserLeap=window.Sprig),window.UserLeap||(window.UserLeap=window.Sprig),window.Sprig||(window.Sprig=window.UserLeap);const Qr="rgba(255,255,255, 0.95)",Xr="rgba(0,0,0,0.9)",at="0px",dn=(e,t,n)=>{window.UserLeap.container=document.createElement("div"),window.UserLeap.container.className=`ul-container${t?" ul-container-feedback":""}`,e&&(window.UserLeap.container.dataset.studyId=e.toString());const i=mn();n&&i&&!window.UserLeap.useMobileStyling?i.appendChild(window.UserLeap.container):document.body.appendChild(window.UserLeap.container)},cn=(e,t)=>{var i;ri();const n=window.UserLeap.container;if(n)try{(i=n.parentNode)==null||i.removeChild(n),window.UserLeap.container=null,x("trackStartUrl",null),g.emit(f.SurveyLifeCycle,{state:"dismissed"}),g.emit(f.SurveyClosed,{name:f.SurveyClosed,initiator:e,"survey.id":parseInt(n.dataset.studyId),...t&&{studyType:t}})}catch(r){console.warn(`[Sprig] (ERR-412) Error removing UserLeap container by ${e} `+n),r instanceof Error&&window.UserLeap.reportError("dismissActiveSurvey",r)}},ln=()=>{g.once(f.SurveyWillClose,({initiator:e,studyType:t})=>{g.removeAllListeners(f.CloseSurveyOnOverlayClick),cn(e,t)})},Zr=(e,t)=>{const i={...{position:"fixed",overflow:"auto",top:"0px",left:"0px",display:"none",height:"100%",width:"100%",transition:"background-color 0.3s ease-out",zIndex:2147483646}},r=t?e.overlayStyleMobile:e.overlayStyle;i["background-color"]=r==="light"?Qr:Xr,t||(i.margin="auto"),window.UserLeap.container&&Object.assign(window.UserLeap.container.style,i)},ei=(e,t,n,i)=>{var u,c;const r={position:"fixed",bottom:"0px",right:at,border:0,backgroundColor:"rgba(0,0,0,0)",zIndex:2147483646,transition:"width 0.2s ease-in-out, height 0.2s ease-in-out",maxWidth:"100%"},s=Object.assign({},t,window.UserLeap),{desktopDisplay:o}=t||{},a=o==="center-modal";a&&(s.framePosition="center");let d,l=!1;if(n)(u=window.UserLeap.windowDimensions)!=null&&u.width?r.width=`${window.UserLeap.windowDimensions.width}px`:r.width="100%",(c=window.UserLeap.windowDimensions)!=null&&c.height?r.maxHeight=`${window.UserLeap.windowDimensions.height-20}px`:window.UserLeap.maxHeight?r.maxHeight=window.UserLeap.maxHeight:r.maxHeight=`${document.body.clientHeight-20}px`,["light","dark"].includes(s.overlayStyleMobile)&&(l=!0);else{r.width=xr,r.maxHeight=window.UserLeap.maxHeight||"66vh";const m=()=>{l=!0,d={margin:"auto",position:"static"}};if(i)a?m():d={position:"relative",height:"300px"};else switch(s.framePosition){case"bottomLeft":d={left:at};break;case"topLeft":d={left:at,top:0};break;case"topRight":d={top:0};break;case"center":m();break}}return l&&Zr(s,n),Object.assign(e.style,r,d),l},ti=({productConfig:e,useMobileStyling:t,surveyId:n,isFeedback:i,enableCspTrustedTypes:r})=>{var p,y;const s=ot,o=i&&e.desktopDisplay==="slider";dn(n,i,o),ni();const a=document.createElement("iframe");a.id=s,a.setAttribute("title","Sprig User Feedback Dialog");const d=ei(a,e,t,i);ln();let l=!1;a.setHeight=h=>{(parseInt(a.style.height)!=h||!l)&&(l=!0,a.style.height=`${h}px`,g.emit(f.SurveyHeight,{name:f.SurveyHeight,contentFrameHeight:h,"survey.id":n}))};let u=!1;a.setWidth=h=>{(parseInt(a.style.width)!=h||!u)&&(u=!0,a.style.width=`${h}px`,g.emit(f.SurveyWidth,{name:f.SurveyWidth,contentFrameWidth:h,"survey.id":n}))},(p=window.UserLeap.container)==null||p.appendChild(a),e&&(t?e.exitOnOverlayClickMobile:e.exitOnOverlayClick)&&window.UserLeap.container&&(window.UserLeap.container.onclick=()=>{g.emit(f.CloseSurveyOnOverlayClick)}),g.emit(f.SurveyLifeCycle,{state:"presented"}),g.emit(f.SurveyPresented,{name:f.SurveyPresented,"survey.id":n});const c=(y=a.contentWindow)==null?void 0:y.document;if(c&&(c.open("text/html","replace"),c.write(st("<!doctype html><head></head><body></body></html>",r,a.contentWindow)),c.close(),!t)){const h=c.body;h.style.display="flex",h.style.alignItems="center"}const m=c==null?void 0:c.head;return{frameId:s,contentWinDocHead:m,contentWindow:a.contentWindow,hasOverlay:d,iframe:a}},un={[f.SurveyFadingOut]:()=>{window.UserLeap.container&&Object.assign(window.UserLeap.container.style,{"background-color":"rgba(0,0,0,0)"})}},ni=()=>{Object.entries(un).forEach(([e,t])=>{g.on(e,t)})},ri=()=>{Object.entries(un).forEach(([e,t])=>{g.off(e,t)})},pn=Object.freeze({contains:(e,t)=>t.includes(e),notContains:(e,t)=>!t.includes(e),exactly:(e,t)=>t===e,notExactly:(e,t)=>t!==e,startsWith:(e,t)=>t.startsWith(e),endsWith:(e,t)=>t.endsWith(e),regex:(e,t)=>new RegExp(e).test(t),legacy:(e,t)=>new RegExp(e,"i").test(t)});function dt(e,t){const{matchType:n,pattern:i}=e,r=n?pn[n]:pn.legacy;let s=!1;try{s=r(i,t)}catch(o){const a=`[Sprig] (ERR-445) Failed to check url match with pattern ${i}`;o instanceof Error&&(console.warn(a,o),o.stack=JSON.stringify(e),window.UserLeap.reportError(a,o))}return s}const wn=e=>{const{pageUrlEvents:t}=window.UserLeap._config,n=t==null?void 0:t.find(i=>i.id===e);return n?dt(n,window.location.href):!1},te=e=>e?e.nodeType===Node.ELEMENT_NODE:!1,ii=2,fn=e=>e instanceof HTMLElement||e instanceof SVGElement,Pe=({document:e,elementId:t,styleString:n,nonce:i})=>{const r=e.getElementById(t);if(r){r.textContent=n;return}const s=e.createElement("style");i&&(s.nonce=i),s.textContent=n,s.id=t,e.head.appendChild(s)},si=e=>{const t=e.querySelector(".sprig-question-body"),n=e.querySelector(".ul-card"),i=e.querySelector(".ul-card-main-content"),r=e.querySelector(".ul-footer"),s=e.querySelector(".sprig-container");let o=0;return te(n)&&(o+=n.scrollHeight-n.clientHeight),te(i)&&(o+=i.scrollHeight-i.clientHeight),te(t)&&(o+=t.scrollHeight-t.clientHeight),te(r)&&te(s)&&s.clientHeight===0&&(o+=r.clientHeight),o},gn=(e,t)=>{const n=t.querySelector(e);if(!te(n))return 0;const i=getComputedStyle(n),r=parseFloat(i.paddingLeft)+parseFloat(i.paddingRight),s=parseFloat(i.marginLeft)+parseFloat(i.marginRight),o=parseFloat(i.borderLeftWidth)+parseFloat(i.borderRightWidth);return r+s+o},oi=(e,t,n)=>{const i=e.querySelector(".ul-card__container"),r=e.querySelector(".ul-app");let s=600,o=360;if(te(i)&&te(r)){const d=i.querySelector(".ul-card--matrix_grid"),l=!d&&t&&n;try{l&&(r.style.width="360px"),s=i.scrollHeight,s+=si(e);const u=getComputedStyle(i),c=parseFloat(u.marginTop)+parseFloat(u.marginBottom),m=parseFloat(u.borderTopWidth)+parseFloat(u.borderBottomWidth);s+=c+m,d&&(o=d.scrollWidth,o+=gn(".ul-card__container",e),o+=gn(".sprig-question-body",e))}finally{l&&r.style.removeProperty("width")}}return[s+ii,o]},mn=()=>v,ue=()=>document.getElementById("sprig-feedback-container"),ct=()=>document.getElementById("sprig-feedback-loading-animation"),ai=()=>{var t;if(ct())return;const e=document.createElement("div");return e.className="ul-loading-spinner-container",e.id="sprig-feedback-loading-animation",e.role="progressbar",e.setAttribute("aria-live","polite"),e.setAttribute("aria-busy","true"),e.setAttribute("aria-label","Processing..."),e.innerHTML=st(`
      <div class="ul-loading-spinner">
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
        <div class="fourth"></div>
      </div>
    `,(t=window.UserLeap._config)==null?void 0:t.enableCspTrustedTypes),e},yn=()=>!!document.getElementById(ot);let hn=!1,v=null,q=null,lt=!1,he=null,se=null;const di=["bottom-left","bottom-right","center-left","center-right"],ci=e=>{if(ue()||!di.includes(e))return;const[t,n]=e.split("-"),i=document.createElement("div");i.id="sprig-feedback-container",i.classList.add(`sprig-feedback-container-${n}`,`sprig-feedback-container-${t}`),document.body.appendChild(i)},Oe=()=>{var t;const e=window.UserLeap.container;return((t=e==null?void 0:e.parentElement)==null?void 0:t.id)==="sprig-feedback-loading-container"},vn=()=>document.getElementById("sprig-feedback-error-container"),bn=()=>{if(!v)return 0;const e=v==null?void 0:v.clientWidth,t=window.getComputedStyle(v),n=parseInt(t.borderRightWidth||"0"),i=parseInt(t.borderLeftWidth||"0");return e+n+i},Me=e=>{const t=ue();t&&(se!=null&&se.endsWith("right")?t.style.right=`${e}px`:se!=null&&se.endsWith("left")&&(t.style.left=`${e}px`))},ut=()=>{if(v&&(Oe()||vn())){g.off(f.SurveyAppeared,ve),pt();const e=bn();return Me(-e),!0}return!1},ve=()=>{if(!v||!q)return;const e=ct();e&&e.remove(),v.style.height="auto",v.style.width="auto",q.disabled=!1,lt=!1},pt=()=>{if(!v)return;if(!ct()){const t=ai();t&&(v.style.height="300px",v.style.width="360px",v.appendChild(t))}},Ln=()=>{!v||!q||(Me(0),q.disabled=!0,lt=!0)},li=async e=>{const t=await j(F("1",[Z],"startFeedbackStudy"),{body:JSON.stringify({surveyUuid:e}),method:"POST"});return t.ok?t.json:null},Sn=async(e,t,n)=>{const{buttonTheme:i,customStyles:r,eventId:s,placement:o,desktopDisplay:a,feedbackLabel:d,surveyUuid:l,surveyId:u}=e;window.UserLeap.feedbackCustomStyles=void 0;let c=ue();if(c){if(!t&&s===he)return;c.remove(),g.off(De.SURVEY_FADING_OUT,ut)}he=s,Pe({document,elementId:"sprig-feedback-style",styleString:Tr,nonce:window.UserLeap.styleNonce}),Pe({document,elementId:"ul-custom-style",styleString:r??"",nonce:window.UserLeap.styleNonce}),hn=a==="center-modal",se=o;const[p,y]=o.split("-");ci(o),c=ue(),q=document.createElement("button");const h=document.createElement("div");h.className="sprig-feedback-button-label",h.innerText=d,q.appendChild(h),q.id="sprig-feedback-button",q.classList.add(`sprig-feedback-button-${y}`,`sprig-feedback-button-${p}`,`sprig-feedback-button-${i}`,"fade-in-transition"),g.on(De.SURVEY_FADING_OUT,ut),q.addEventListener("click",async()=>{const R=document.getElementById("sprig-feedback-error-container");if(yn()||vn()){if(ut()){g.emit(f.SurveyCloseRequested,{name:f.SurveyCloseRequested,initiator:W.FeedbackClosed,studyType:"feedbackButton","survey.id":u}),g.emit(f.SurveyWillClose,{name:f.SurveyWillClose,initiator:W.FeedbackClosed,studyType:"feedbackButton","survey.id":u});const A=ue();R&&A&&(A.remove(),he=null,v=null)}return}const B=N(window.UserLeap);if(!xe(B)&&!lt&&Ln(),t){v&&v.classList.add("sprig-feedback-loading-container-previews"),await me(t),ve();return}const de=await li(l);if(de)g.once(f.SurveyAppeared,ve),me({...de,studyType:"feedbackButton"},n);else if(v){const A=pi();v.appendChild(A),ve(),v.style.height="300px",v.style.width="360px"}}),c==null||c.appendChild(q),g.emit(f.FeedbackButtonLoaded,{name:f.FeedbackButtonLoaded,"survey.id":u});const{useMobileStyling:I,_config:{border:k}}=window.UserLeap;if(!hn&&!I){const R=document.createElement("div");R.id="sprig-feedback-loading-container",R.className=`sprig-feedback-loading-container sprig-feedback-loading-container-${y}`,R.style.setProperty("--feedback-border",k),v=R,pt(),c==null||c.appendChild(R);const B=bn();Me(-B)}else Me(0);window.UserLeap._config.isOnQuestionsTab&&t&&!Oe()&&v&&(Ln(),pt(),v&&v.classList.add("sprig-feedback-loading-container-previews"),me(t),ve())},ui=()=>{if(Oe())return;const e=ue();if(!e)return;wn(he)||(e.remove(),he=null,v=null)},pi=()=>{var n;const e=document.createElement("div");e.id="sprig-feedback-error-container",e.innerHTML=st(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40" fill="none">
    <circle cx="20" cy="20" r="14.5" stroke="#B0B5B7" stroke-width="3"/>
    <path d="M20 12L20 21.6" stroke="#B0B5B7" stroke-width="3" stroke-linecap="round"/>
    <circle cx="19.9984" cy="27.6" r="1.6" fill="#B0B5B7"/>
    </svg>`,(n=window.UserLeap._config)==null?void 0:n.enableCspTrustedTypes);const t=document.createElement("h3");return t.className="sprig-feedback-error-text",t.innerText="There was an error while loading the survey",e.appendChild(t),e},wi="!launch_darkly_";class fi{constructor(){_(this,"_ldData",{})}getAllLaunchDarklyVariations(){return this._ldData}setLDFlagsVariations(t){try{return!t||typeof t!="object"||Array.isArray(t)?!1:(Object.keys(this._ldData).forEach(n=>{delete this._ldData[n]}),Object.keys(t).forEach(n=>this._ldData[`${wi}${n}`]=(t[n]??0)+1),!0)}catch(n){return n instanceof Error&&window.UserLeap.reportError("setAllLDFlagsVariations",n),console.warn("[Sprig] An issue had occured when setting LaunchDarkly flags and variations."),!1}}}const wt=new fi;Object.freeze(wt);const gi="!optimizely_experiments_";class mi{constructor(){_(this,"_optimizelyData",{})}setOptimizelyExperiment(t,n=!0){if(!t||typeof t!="object")return!1;const{experiments:i}=t;try{return n&&Object.keys(this._optimizelyData).map(r=>{delete this._optimizelyData[r]}),i&&i.map(r=>{const{id:s,variation:o}=r,a=this.transformExperimentId(s);o&&typeof o=="string"&&(this._optimizelyData[a]=o)}),!0}catch(r){return r instanceof Error&&window.UserLeap.reportError("setOptimizelyExperiment",r),!1}}getAllOptimizelyExperiments(){return this._optimizelyData}getOptimizelyVariationName(t){return this._optimizelyData[this.transformExperimentId(t)]}transformExperimentId(t){return gi+t}getAndSetWebOptimizelyExperiments(){var t;try{if(window&&window.optimizely&&typeof window.optimizely.get=="function"){const n=(t=window.optimizely.get("state"))==null?void 0:t.getExperimentStates({isActive:!0});if(n){const i=Object.keys(n).map(r=>{var s,o;return(s=n[r].variation)!=null&&s.name?{id:r,variation:(o=n[r].variation)==null?void 0:o.name}:{id:r,variation:"Original"}});return this.setOptimizelyExperiment({experiments:i},!1),!0}return!1}return!1}catch(n){return n instanceof Error&&window.UserLeap.reportError("getAndSetWebOptimizely",n),!1}}}const Be=new mi;Object.freeze(Be);class yi{constructor(t,n){_(this,"paused");_(this,"queue");_(this,"ul");this.ul=t,this.paused=!1,this.queue=[],this.flush(n)}flush(t){const n=t.length;if(n)for(let i=0;i<n;i++)this.push(t[i])}isPaused(){return this.paused}pause(){this.paused=!0}unpause(){this.paused=!1;const t=this.queue.slice();this.empty(),this.flush(t)}push(t){if(this.paused)this.queue.push(t);else if(t instanceof Function)t();else{const n=Array.prototype.slice.call(t,1),i=t[0],r=this.ul[i];r instanceof Function?r.apply(this.ul,n):i&&console.warn("[Sprig] (ERR-100) No valid UserLeap action called",i)}}perform(t){if(this.paused){let n=()=>{};const i=new Promise(function(r){n=function(){r(t())}});return this.queue.push(n),i}else return t()}empty(){this.queue.length=0}}let Un=!0,ft=!1;const hi=()=>Un=!1,vi=()=>ft=!0,bi=["sdk_event_queue_latency_seconds","sdk_replay_add_event_batch_seconds","sdk_replay_cleanup_seconds","sdk_replay_compression_seconds","sdk_replay_get_events_between_seconds","sdk_replay_snapshot_seconds","sdk_mutations_nodes_added","sdk_mutations_nodes_removed","sdk_mutations_attributes_changed","sdk_mutations_character_data","sdk_dom_nodes_count","sdk_page_html_characters"];let be={},gt;class Li{constructor(t){_(this,"_values",[]);_(this,"_isWebMetric");this.name=t,this._isWebMetric=bi.includes(this.name)}report(t){if(Un&&this._values.push({time:Date.now(),value:t}),ft||!this._isWebMetric)return;const n=this.findExceededThreshold(t);n&&gt&&gt(t,n)}collect(){const t=this._values;return this._values=[],t}findExceededThreshold(t){const n=be[this.name];if(n)return n.find(i=>this.valueExceedsThreshold(t,i))}valueExceedsThreshold(t,n){return n.type==="max"?t>n.value:n.type==="min"?t<n.value:!1}}const Si=(e,t)=>{be={},ft=!1,e==null||e.forEach(n=>{var i;n.metric in be||(be[n.metric]=[]),(i=be[n.metric])==null||i.push(n)}),gt=t},Le={},$=e=>{const t=new Li(e);return Le[e]=t,t},In=(e,t)=>{let n=Le[e];return n||(n=$(e)),n.report(t)},Ui=async e=>{const t=Object.values(Le).map(n=>({name:n.name,values:n.collect()}));if(t.some(n=>n.values.length))try{await e(JSON.stringify(t))}catch(n){n instanceof Error&&w.error("MetricsErr",{error:{message:n.message,name:n.name}})}},Ii=({reportingIntervalSeconds:e,postMetrics:t})=>{e?setInterval(()=>{Ui(t)},e*1e3):hi()};let En,kn;const mt=e=>{let t=0,n=e.firstElementChild;for(;n;)t+=mt(n),n.shadowRoot&&(t+=mt(n.shadowRoot)),n=n.nextElementSibling,t++;return t},Ei=()=>document.documentElement.innerHTML.toString().length,_n=()=>{En.report(mt(document.body)),kn.report(Ei())},ki=(e=10*1e3)=>{En=$("sdk_dom_nodes_count"),kn=$("sdk_page_html_characters"),_n(),setInterval(_n,e)},yt=(e,t)=>{const n=performance.now();document.hidden?setTimeout(()=>yt(e,t),e):setTimeout(()=>{const i=performance.now()-n;t.report(i/1e3),setTimeout(()=>yt(e,t),e)},0)},_i=(e=1e3)=>{const t=$("sdk_event_queue_latency_seconds");yt(e,t)};let Ne,Fe,He,Ve,oe={},Rn;const We=(e,t=1)=>{const{name:n}=e;oe[n]=(oe[n]||0)+t},Dn=e=>{let t=1;return e.childNodes.forEach(n=>{t+=Dn(n)}),t},Cn=e=>{let t=0;return e.forEach(n=>{t+=Dn(n)}),t},Ri=e=>{switch(e.type){case"childList":We(Ne,Cn(e.addedNodes)),We(Fe,Cn(e.removedNodes));return;case"attributes":We(He);return;case"characterData":We(Ve);return}},Di=e=>e.forEach(Ri),Ci=()=>{Rn=new MutationObserver(Di),Rn.observe(document,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},Ai=()=>{Ne.report(oe[Ne.name]||0),Fe.report(oe[Fe.name]||0),He.report(oe[He.name]||0),Ve.report(oe[Ve.name]||0),oe={}},Ti=(e=1*1e3)=>{Ne=$("sdk_mutations_nodes_added"),Fe=$("sdk_mutations_nodes_removed"),He=$("sdk_mutations_attributes_changed"),Ve=$("sdk_mutations_character_data"),Ci(),setInterval(Ai,e)},xi=({isWeb:e,reportingIntervalSeconds:t,thresholds:n,postMetrics:i})=>{Si(n,(r,s)=>{var o,a;if((o=L.replay)!=null&&o.isReplayRecording()){const d=`Value: ${r} on ${s.metric} violated threshold of ${s.type} ${s.value}`;(a=L.replay)==null||a.disableRecording("Threshold violated",new Error(d),{reportError:!1}),window.UserLeap.reportError("Sdk Performance Metric threshold violated",new Error("Sdk Performance Metric threshold violated"),{metricName:s.metric,type:s.type,value:s.value},{metricName:s.metric}),vi()}}),Ii({reportingIntervalSeconds:t,postMetrics:i}),e&&(_i(),ki(),Ti())},Pi={test:"test"},Oi=["popState","pushState","replaceState"];let ht,Se;const je={},Ue="!email",An="pageUrl";function Mi(e){if(!window.UserLeap._config.dismissOnPageChange)return!0;const t=new URL(e),n=new URL(Se??window.location.href);return t.hostname===n.hostname&&t.pathname===n.pathname}let vt=window.location.href;function Ie(e){var d,l;const{pageUrlEvents:t,interactiveEvents:n,dismissOnPageChange:i,platform:r}=window.UserLeap._config;if(r&&r!=="web")return;vt!==window.location.href&&w.navigation("LocationChange",{from:vt,to:window.location.href}),vt=window.location.href;const o=Pn().trackStartUrl,a=o?String(o):null;t&&Mn(window.location.href),n&&(xn(),Bi()),mn()&&ui(),S.getItem("sprig.isCapturingHeatmap")&&((l=(d=L.replay)==null?void 0:d.checkPendingHeatmapsUrl())==null||l.then(u=>{var c;u&&((c=L.replay)==null||c.uploadReadyPendingCaptures(!0))})),!Oe()&&i&&a&&a!==window.location.href&&e&&Oi.includes(e.type)&&window.UserLeap("dismissActiveSurvey",W.PageChange)}const Tn={capture:!0},Bi=()=>{const t=window.UserLeap._config.interactiveEvents.filter(i=>dt(i,window.location.href)).map(i=>{const{name:r,properties:s}=i,{selector:o,innerText:a}=s;return o?d=>{if(fn(d.target))try{d.target.closest(o)&&window.UserLeap("track",r)}catch{}return!1}:d=>(fn(d.target)&&d.target.innerText===a&&window.UserLeap("track",r),!1)}),n=i=>t.forEach(r=>r(i));window.UserLeap._config.interactiveEventsHandler=n,window.addEventListener("click",n,Tn)},xn=()=>{window.UserLeap._config.interactiveEventsHandler&&window.removeEventListener("click",window.UserLeap._config.interactiveEventsHandler,Tn),delete window.UserLeap._config.interactiveEventsHandler};function Ni(){["hashchange","popstate"].forEach(e=>window.addEventListener(e,Ie,!0))}function Fi(){["hashchange","popstate"].forEach(e=>window.removeEventListener(e,Ie,!0)),window.UserLeap._config.interactiveEvents&&xn()}function Hi(e){const t=new URL(F("1",[ee],"questions"));return Object.entries(e||{}).forEach(([n,i])=>{i&&t.searchParams.append(n,String(i))}),t.toString()}function Pn(){const e=T.getItemObject("userleap.ids");return e&&e[window.UserLeap.envId]||{}}function On(){if(window.previewMode)return;const e=T.getItemObject("sprig.anon.env.vid.map")||{},t=e[window.UserLeap.envId];window.UserLeap.visitorId=t||le(),w.info("NewVid",{vid:window.UserLeap.visitorId}),x("vid",window.UserLeap.visitorId),t||(e[window.UserLeap.envId]=window.UserLeap.visitorId,T.setItemObject("sprig.anon.env.vid.map",e)),g.emit(f.VisitorIDUpdated,{visitorId:window.UserLeap.visitorId})}function Mn(e,t,n,i){var r,s;try{if(e.endsWith("mock_snippet.html"))return;w.info("PageView",{url:e});const o=(r=document==null?void 0:document.querySelector('meta[name="description"]'))==null?void 0:r.getAttribute("content");(s=L.replay)==null||s.RecordPageView({...o&&{description:o},url:e,referrer:document.referrer,pageTitle:document.title});const a=window.UserLeap._config.pageUrlEvents;let d=!1;if(a&&a.length)for(let u=0;u<a.length&&(d=dt(a[u],e),!d);u++);if(!d)return;window.UserLeap.debugMode&&console.info("[DEBUG] Sprig trackPageView",e);const l={url:e};i&&(l.trackPageView=!0),window.UserLeap._queue.push(["track",An,t,l,n])}catch(o){o instanceof Error&&(o.stack=e,window.UserLeap.reportError("trackPageView",o)),console.warn("[Sprig] (ERR-428) Failed to track page view",o)}}function Vi(){const e="Backbone"in window&&window.Backbone&&window.Backbone.history?window.Backbone.history:window.history;"pushState"in e&&(e.pushState=(t=>function(...i){const r=t.apply(this,i),s=new Event("pushState");return window.dispatchEvent(s),Ie(s),r})(e.pushState)),"replaceState"in e&&(e.replaceState=(t=>function(...i){const r=t.apply(this,i),s=new Event("replaceState");return window.dispatchEvent(s),Ie(s),r})(e.replaceState)),Ni()}async function bt(e,t){const n=it();e&&!t&&(window.UserLeap._config.mode=Pi.test);const i=N(window.UserLeap),r=xe(i),s=await j(Hi({desktopDisplay:window.UserLeap._config.desktopDisplay,isMobile:r,previewLanguage:window.UserLeap._config.previewLanguage,surveyid:e==null?void 0:e.surveyId,surveytemplateid:e==null?void 0:e.surveyTemplateId,vid:n}),{shouldDropOnRateLimit:!0});if(!s.ok)return s.reportError&&s.error&&(console.warn("[Sprig] (ERR-414) Failed to request questions from the server",s.error),window.UserLeap.reportError("getQuestions",s.error)),{success:!1,surveyState:"no survey"};if(s.json.delay&&await Ce(s.json.delay),s.json.isFeedback){const{feedbackLabel:o,productConfig:a,surveyUuid:d,feedbackCustomStyles:l}=s.json,{buttonTheme:u,placement:c,desktopDisplay:m}=a,p={customStyles:l,buttonTheme:u,desktopDisplay:m,eventId:0,feedbackLabel:o,placement:c,surveyUuid:d,surveyId:e==null?void 0:e.surveyId};Sn(p,s.json)}else return me(s.json,Se,ht)}function Wi(e){let t=e.length;for(;t;){const n=Math.floor(Math.random()*t);t-=1;const i=e[t];e[t]=e[n],e[n]=i}}function ji(e){if(!e)return;window.UserLeap._config=e,e.mute&&window.UserLeap._queue.pause();const{interactiveEvents:t,pageUrlEvents:n,dismissOnPageChange:i}=e;t&&Wi(t),(t||n||i)&&(Vi(),Ie())}async function qi(e,t){var i,r;let n=!0;return t&&((i=e==null?void 0:e.json)!=null&&i.surveyId)&&(window.UserLeap.delayingSurvey=!0,n=await t(e.json.surveyId),window.UserLeap.delayingSurvey=!1,!n)?!1:((r=e==null?void 0:e.json)!=null&&r.delay&&!window.UserLeap.isMobileSDK&&(window.UserLeap.delayingSurvey=!0,await Ce(e.json.delay),window.UserLeap.delayingSurvey=!1),n)}const $i=function(e){if(!window.UserLeap)return;const t=async(r={})=>{var R,B,_e,de,A;const{userId:s,anonymousId:o,metadata:a={},properties:d,showSurveyCallback:l}=r;let{eventName:u}=r;if(window.UserLeap.debugMode&&u!==An&&console.info("[DEBUG] Sprig track",r),e.mode==="test")return;const c=T.getItem("sprig.previewKey")??void 0;if(e.requireUserIdForTracking&&!window.UserLeap.userId&&!s){const M="[Sprig] - Skipping tracking without userId";return console.warn(M),{success:!1,message:M,surveyState:"no survey"}}if(!u||u.trim().length===0){u=u?String(u):"";const M="[Sprig] - Invalid event name "+u;return console.warn(M),{success:!1,message:M,surveyState:"no survey"}}const m=Se??window.location.href;if(a.url||(a.url=m),x("trackStartUrl",m),(B=(R=window.UserLeap)==null?void 0:R._config)!=null&&B.optimizelyEnabled){const M=N(window.UserLeap);ye(M)||Be.getAndSetWebOptimizelyExperiments(),a.optimizelyExperiments=Object.assign({},Be.getAllOptimizelyExperiments())}(de=(_e=window.UserLeap)==null?void 0:_e._config)!=null&&de.launchDarklyEnabled&&(a.launchDarklyFlags=wt.getAllLaunchDarklyVariations()),s&&(window.UserLeap.userId=s),o&&(window.UserLeap.partnerAnonymousId=o),d&&(a.eventProperties=d),(A=L.replay)==null||A.RecordEvent({name:u,url:a.url}),w.info("TrackEvent",{eventName:u});const p=window.UserLeap.delayingSurvey||yn()?await j(F("1",[Z],"events/batch"),{body:JSON.stringify({events:[{event:u,metadata:a}],previewKey:c}),method:"POST",shouldDropOnRateLimit:!0}):await j(F("1",[Z],"events"),{body:JSON.stringify({event:u,metadata:a,previewKey:c}),method:"POST",shouldDropOnRateLimit:!0});if(!p.ok){const M="[Sprig] (ERR-421) Failed to track event";return p.reportError&&(console.warn(M,p.error),p.error&&window.UserLeap.reportError("track",p.error)),{success:!1,message:M,error:p.error,surveyState:"no survey"}}s&&x("uid",s),o&&x("aid",o);const y=p.json;y.invalidPreviewKey&&T.removeItem("sprig.previewKey");const h=a.trackPageView?a.url:void 0;return!!(y!=null&&y.feedbackButton)&&Sn(y.feedbackButton,void 0,h),await qi(p,l)?Mi(m)?me(y,h,ht):{success:!1,message:"Study should not be displayed after page navigation",surveyState:"no survey"}:{success:!1,message:"[Sprig] Callback returned false, aborting rendering of survey",surveyState:"no survey"}},n=(r,s)=>{var a;const o=(a=r==null?void 0:r.querySelector(`[id="${ot}"]`))==null?void 0:a.contentDocument;o&&Pe({document:o,elementId:"ul-custom-style",styleString:s})},i={async displaySurvey(r){return console.warn("[Sprig] displaySurvey should only be used to debug your studies; not intended for production usage."),window.UserLeap("dismissActiveSurvey",W.Override),bt({surveyId:r},!0)},_previewSurvey(r){window.UserLeap("dismissActiveSurvey",W.Override),bt({surveyTemplateId:r},!1)},_reviewSurvey(r){window.UserLeap("dismissActiveSurvey",W.Override),bt({surveyId:r},!1)},previewSurvey(r){i._previewSurvey(r)},reviewSurvey(r){i._reviewSurvey(r)},mute(){window.UserLeap._queue.pause()},unmute(){window.UserLeap._queue.unpause()},setVisitorToken(){console.warn("[Sprig] setVisitorToken is deprecated.")},dismissActiveSurvey(r=W.API){window.UserLeap.container&&(r===W.Closed&&window.Sprig.trackHistory&&window.Sprig.trackHistory({event:"closed"}),g.emit(f.SurveyCloseRequested,{name:f.SurveyCloseRequested,initiator:r,"survey.id":parseInt(window.UserLeap.container.dataset.studyId)}),g.emit(f.SurveyWillClose,{name:f.SurveyWillClose,initiator:r,"survey.id":parseInt(window.UserLeap.container.dataset.studyId)}))},async setAttribute(r,s){if(!r||!s&&s!==0&&s!==!1){const o="[Sprig] - Disregarding empty attribute / value provided";return console.warn(o),{success:!1,message:o}}return this.setAttributes({[r]:s})},async setAttributes(r){if(r==null||Object.keys(r).length===0){const s="[Sprig] - Disregarding empty attributes provided";return console.warn(s),{success:!1,message:s}}return this.identifyAndSetAttributes({attributes:r})},async identifyAndSetAttributes(r){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig identifyAndSetAttributes",r),e.mode==="test")return;if(r===null||typeof r!="object"||!(r.userId||r.anonymousId||r.attributes)){const u="[Sprig] - Disregarding empty payload provided";return console.warn(u),{success:!1,message:u}}const{userId:s,anonymousId:o,attributes:a}=r;if(e.requireUserIdForTracking&&!window.UserLeap.userId&&!s){const u="[Sprig] - Skipping tracking without userId";return console.warn(u),{success:!1,message:u}}if(a){a.email&&!a[Ue]&&(a[Ue]=a.email,delete a.email);const u=Object.keys(a);for(const c of u)a[c]===je[c]&&delete a[c]}if((!a||Object.keys(a).length===0)&&(!s||window.UserLeap.userId===s)&&(!o||window.UserLeap.partnerAnonymousId===o))return{success:!0};const d={};s&&(d.userId=window.UserLeap.userId=s),o&&(d.partnerAnonymousId=window.UserLeap.partnerAnonymousId=o);let l;return a&&Object.keys(a).length>0?(l=await j(F("1",[ee,Z],"attributes"),{body:JSON.stringify(a),method:"PUT"}),l.ok?Object.assign(je,a):l.reportError&&(console.warn("[Sprig] (ERR-432) identifyAndSetAttributes failed",l.error),l.error&&window.UserLeap.reportError("identifyAndSetAttributes",l.error))):l=await j(F("1",[ee,Z]),{body:JSON.stringify(d),method:"PUT"}),a&&a[Ue]&&(window.UserLeap.email=a[Ue]),l.ok&&(s&&x("uid",s),o&&x("aid",o)),{success:!!l.ok}},async removeAttributes(r){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig removeAttributes",r),e.mode==="test")return;if(r==null||r.length===0){const o="[Sprig] - Disregarding empty attributes provided";return console.warn(o),{success:!1,message:o}}if(e.requireUserIdForTracking&&!window.UserLeap.userId){const o="[Sprig] - Skipping tracking without userId";return console.warn(o),{success:!1,message:o}}const s=await j(F("1",[ee,Z],"attributes"),{body:JSON.stringify({delete:r}),method:"DELETE"});return!s.ok&&s.reportError&&(console.warn("[Sprig] (ERR-433) Remove attributes failed",s.error),s.error&&window.UserLeap.reportError("removeAttributes",s.error)),{success:!!s.ok}},async addSurveyListener(r){g.on(f.SurveyLifeCycle,r)},async removeSurveyListener(r){g.removeListener(f.SurveyLifeCycle,r)},async addListener(r,s){g.on(r,s)},async removeListener(r,s){g.removeListener(r,s)},async removeAllListeners(){g.removeAllListeners()},setPreviewKey(r){!r||typeof r!="string"||T.isStorageAvailable&&r&&T.setItem("sprig.previewKey",r)},async setUserId(r){var a;if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig setUserId",r),r==null){const d=`[Sprig] - Invalid userId ${r}`;return console.warn(d),{success:!1,message:d}}if(e.mode==="test"||r===window.UserLeap.userId)return;window.UserLeap.userId=r;const s=window.UserLeap.visitorId,o=await j(F("1",[ee,Z]),{body:JSON.stringify({userId:r}),method:"PUT"});if(!o.ok){o.reportError&&(console.warn("[Sprig] (ERR-420) Failed to set user id",o.error),o.error&&window.UserLeap.reportError("setUserId",o.error));return}s!==window.UserLeap.visitorId&&((a=L.replay)==null||a.clearUserReplayData()),x("uid",r)},async setPartnerAnonymousId(r){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig setPartnerAnonymousId",r),r==null){const s=`[Sprig] - Invalid partnerAnonymousId ${r}`;return console.warn(s),{success:!1,message:s}}return window.UserLeap.partnerAnonymousId=r,x("aid",r),{success:!0}},async track(r,s,o={},a=void 0){return t({eventName:r,properties:s,metadata:o,showSurveyCallback:a})},async identifyAndTrack(r){return await t(r)},trackPageView(r,s=void 0,o=void 0,a=!0){Se=r,Mn(r,s,o,a)},applyFeedbackStyles({button:r="",view:s=""}){window.UserLeap.feedbackCustomStyles=s,document.getElementById("sprig-feedback-style")&&Pe({document,elementId:"ul-custom-style",styleString:r,nonce:window.UserLeap.styleNonce}),n(document.querySelector(".ul-container-feedback"),s)},applyStyles(r){window.UserLeap.customStyles=r,n(window.UserLeap.container,r)},setWindowDimensions(r,s){var m,p;const o=typeof r=="string"?parseInt(r,10):r,a=typeof s=="string"?parseInt(s,10):s;!isNaN(o)&&!isNaN(a)&&(window.UserLeap.windowDimensions={width:o,height:a});const d=N(window.UserLeap),l=xe(d),u=d["userleap-platform"]==="web";if(!window.UserLeap.frameId)return;const c=document.getElementById(window.UserLeap.frameId);c&&(window.UserLeap.useMobileStyling&&((m=window.UserLeap.windowDimensions)!=null&&m.width&&(c.style.width=`${window.UserLeap.windowDimensions.width}px`),(p=window.UserLeap.windowDimensions)!=null&&p.height&&(c.style.maxHeight=`${window.UserLeap.windowDimensions.height-20}px`),c.contentDocument&&(c.style.height=String(oi(c.contentDocument,u&&!l,Xt(d))[0])+"px")),g.emit(f.SurveyDimensions,{name:f.SurveyDimensions,contentFrameWidth:c.clientWidth,contentFrameHeight:c.clientHeight,"survey.id":parseInt(window.UserLeap.container.dataset.studyId)}))},logoutUser(){var r;window.UserLeap.debugMode&&console.info("[DEBUG] Sprig logout"),w.info("LogOut",{vid:window.UserLeap.visitorId,userId:window.UserLeap.userId}),window.UserLeap.visitorId=null,window.UserLeap.userId=null,window.UserLeap.partnerAnonymousId=null,window.UserLeap.token=null,window.UserLeap.email=null,T.removeItem("userleap.ids"),window.UserLeap._queue.isPaused()&&window.UserLeap._queue.empty(),On(),(r=L.replay)==null||r.clearUserReplayData(),window.UserLeap._queue.unpause()},teardown(){Fi(),window.UserLeap("dismissActiveSurvey",W.API),delete window.UserLeap,delete window.Sprig,delete window._Sprig},integrateOptimizely(r,s=!0){var o,a;if(!((a=(o=window.UserLeap)==null?void 0:o._config)!=null&&a.optimizelyEnabled)){console.warn("[SPRIG] Optimizely integration is currently not enabled for your product.");return}try{const d=typeof r=="string"?JSON.parse(r):r;Be.setOptimizelyExperiment(d,s)}catch(d){console.warn("[Sprig] Error with integrating Optimizely data"),d instanceof Error&&window.UserLeap.reportError("integrateOptimizely",d)}},integrateOptimizelyClient(r){var o,a;if(!((a=(o=window.UserLeap)==null?void 0:o._config)!=null&&a.optimizelyEnabled)){console.warn("[SPRIG] Optimizely integration is currently not enabled for your product.");return}const s=({experiment:d,variation:l})=>{const u={experiments:[{id:d.id,variation:l.key}]};window.UserLeap("integrateOptimizely",u,!1)};r.notificationCenter.addNotificationListener("ACTIVATE:experiment, user_id,attributes, variation, event",s)},importLaunchDarklyData(r){var s,o;if(!((o=(s=window.UserLeap)==null?void 0:s._config)!=null&&o.launchDarklyEnabled)){console.warn("[SPRIG] LaunchDarkly integration is currently not enabled for your product.");return}wt.setLDFlagsVariations(r)},setVisitorAttribute(r,s){return console.warn("[Sprig] setVisitorAttribute is deprecated. Please use setAttribute"),i.setAttribute(r,s)},async setEmail(r){return i.setAttribute(Ue,r)},async setVisitorEmail(r){return console.warn("[Sprig] setVisitorEmail is deprecated. Please use setEmail"),i.setEmail(r)},async _generateVideoUploadUrl(r){return Gi(r)},_reportMetric(r,s){In(r,s)},async _completeSessionReplay({surveyId:r,responseGroupUuid:s,eventDigest:o}){var a;return L.replay?(a=L.replay)==null?void 0:a._completeSessionReplay({surveyId:r,responseGroupUuid:s,eventDigest:o,headers:N(window.UserLeap)}):(window.UserLeap.reportError("_completeSessionReplay",new Error("Replay module not registered")),!1)},pauseReplayRecording(){var r,s,o,a;(s=(r=L.replay)==null?void 0:r.isReplayPaused)!=null&&s.call(r)||(a=(o=L.replay)==null?void 0:o.recordReplayPaused)==null||a.call(o)},resumeReplayRecording(){var r,s,o,a,d,l;(s=(r=L.replay)==null?void 0:r.isReplayPaused)!=null&&s.call(r)&&((a=(o=L.replay)==null?void 0:o.recordReplayResumed)==null||a.call(o),(l=(d=L.replay)==null?void 0:d.recordFullSnapshot)==null||l.call(d))}};Object.assign(window.UserLeap,i)};async function zi(e){var s,o;const t=N(window.UserLeap);document.addEventListener("securitypolicyviolation",rn);const n=await Y(F("1",[ee],"config"),{headers:t});if(document.removeEventListener("securitypolicyviolation",rn),!n.ok)return(s=window.SprigLoggerCallback)==null||s.call(window,"Sprig config fetch failed"),n.reportError&&(console.warn("[Sprig] (ERR-422) Failed to load configuration",n.error),n.error&&window.UserLeap.reportError("applyRemoteConfig",n.error)),rt("Disabled: failed to fetch configuration"),e;const i=n.json;return i!=null&&i.disabled?((o=window.SprigLoggerCallback)==null||o.call(window,"Sprig config fetch disabled"),rt(`Disabled: ${i.disabled}`),{disabled:i.disabled}):Object.assign({},i,e)}async function Ki(e,t,n={},i={}){const r=window.__cfg&&window.__cfg.mode,s=it(),o=window.UserLeap.envId,a=window.document.documentElement,d={mode:r,screenWidth:window.screen.width,screenHeight:window.screen.height,clientWidth:a.clientWidth,clientHeight:a.clientHeight,location:Se??window.location.href,language:window.navigator.language,...n},l={action:e,breadcrumbs:w.breadcrumbs,err:{message:`${t==null?void 0:t.name} - ${t==null?void 0:t.message}`,stack:t==null?void 0:t.stack},meta:d,vid:s,envId:o,...i};(await j(F("1",null,"errors"),{method:"POST",headers:{"x-ul-error":window.btoa(`userleap-${Date.now()}-error`)},body:JSON.stringify(l),shouldDropOnRateLimit:!0})).ok||console.warn("[Sprig] (ERR-444) Failed to report error to API",t)}async function Gi(e){var n;if(!e)return;const t=`${window.UserLeap._API_URL}/2/environments/integrations/upload`;try{const i=await fetch(t,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(i.ok){const r=await i.json();return(n=r==null?void 0:r.upload)==null?void 0:n.url}else return null}catch(i){console.warn("[Sprig] Error with generating video upload url"),i instanceof Error&&window.UserLeap.reportError("generateVideoUploadUrl",i)}}function Yi(e={}){var i;(i=window.SprigLoggerCallback)==null||i.call(window,"Initializing Sprig");const t=new URLSearchParams(window.location.search).get("sprigPreviewKey")??"";window.UserLeap.UPDATES=De,window.UserLeap("setPreviewKey",t);async function n(){var m,p,y,h,I;if(window.UserLeap.loaded)return;if((m=window.SprigLoggerCallback)==null||m.call(window,"Loading Sprig"),window.UserLeap.reportError=Ki,window.UserLeap.loaded=!0,window.UserLeap._config=Object.assign({},e,window.UserLeap.config),window.UserLeap.delayingSurvey=!1,window.UserLeap._config&&typeof window.UserLeap._config=="object")for(const k in window.UserLeap._config)window.UserLeap[k]=window.UserLeap._config[k];if(window.Sprig.outstandingTransactionLimit!==void 0&&(e.outstandingTransactionLimit=window.Sprig.outstandingTransactionLimit),!window.UserLeap.envId)if(window.UserLeap.appId)window.UserLeap.envId=window.UserLeap.appId;else throw new Error("Missing Environment id");window.UserLeap.debugMode&&console.info("[DEBUG] Sprig debug mode enabled");const r=Pn(),s=window.UserLeap.sampleRate;let o=r.sampled;if(s){if(o===null&&(o=Math.random()<s,x("sampled",o)),!o)return}else o!==null&&x("sampled",null);window.UserLeap._API_URL||(window.UserLeap._API_URL="https://api.sprig.com");const a=[...window.UserLeap._queue];window.UserLeap._queue=new yi(window.UserLeap,[]),window.UserLeap._queue.pause();for(let k=0;k<a.length;k++)window.UserLeap._queue.push(a[k]);const d=r.token;d?(window.UserLeap.token=d,window.UserLeap.visitorId=r.vid??null,window.UserLeap.userId=r.uid??null,window.UserLeap.partnerAnonymousId=r.aid??null):On();const l=N(window.UserLeap),u=ye(l);(p=window.SprigLoggerCallback)==null||p.call(window,"Sprig fetching config");const c=await zi(e);if((y=window.SprigLoggerCallback)==null||y.call(window,"Sprig fetched config"),xi({isWeb:!u,reportingIntervalSeconds:c.metricsReportingEnabled||c.mobileMetricsReportingEnabled?c.metricsReportingIntervalSeconds:0,thresholds:c.metricThresholds,postMetrics:async k=>{var R;await j(F("1",[ee],"metrics"),{body:k,method:"POST",headers:{"x-ul-replay-enabled":`${!!((R=L.replay)!=null&&R.isReplayRecording())}`},shouldDropOnRateLimit:!0})}}),!u){const k=c.alwaysOnReplay?{userAgent:window.navigator.userAgent,surveyId:c.alwaysOnReplay.surveyId,responseGroupUuid:c.alwaysOnReplay.responseGroupUuid,sdkVersion:"2.40.3",maxDurationSeconds:c.alwaysOnReplay.maxDurationSeconds}:void 0;await((h=L.replay)==null?void 0:h.initializeReplay({maxReplayDurationSeconds:c.maxReplayDurationSeconds,maxInflightRequests:window.UserLeap.maxInflightReplayRequests??2,replaySettings:c.replaySettings,apiUrl:window.UserLeap._API_URL,alwaysOnConfig:k})),ht=c.replaySettings}$i(c),await ji(c),window.UserLeap._queue.unpause(),(I=window.SprigLoggerCallback)==null||I.call(window,"SdkReady"),g.emit(f.SDKReady,{mobileMetricsReportingEnabled:!!c.mobileMetricsReportingEnabled,metricsReportingInterval:c.metricsReportingIntervalSeconds||0,metricsThresholds:c.metricThresholds||[],maxMobileReplayDurationSeconds:c.maxMobileReplayDurationSeconds,mobileReplaySettings:c.mobileReplaySettings}),g.emit(f.VisitorIDUpdated,{visitorId:window.UserLeap.visitorId}),g.on(f.VisitorIDUpdated,()=>{for(const k in je)delete je[k]})}document.readyState==="complete"?n():window.attachEvent?window.attachEvent("onload",n):window.addEventListener("load",()=>{n()},!1)}var ne=(e=>(e[e.DomContentLoaded=0]="DomContentLoaded",e[e.Load=1]="Load",e[e.FullSnapshot=2]="FullSnapshot",e[e.IncrementalSnapshot=3]="IncrementalSnapshot",e[e.Meta=4]="Meta",e[e.Custom=5]="Custom",e[e.Plugin=6]="Plugin",e))(ne||{}),J=(e=>(e[e.Mutation=0]="Mutation",e[e.MouseMove=1]="MouseMove",e[e.MouseInteraction=2]="MouseInteraction",e[e.Scroll=3]="Scroll",e[e.ViewportResize=4]="ViewportResize",e[e.Input=5]="Input",e[e.TouchMove=6]="TouchMove",e[e.MediaInteraction=7]="MediaInteraction",e[e.StyleSheetRule=8]="StyleSheetRule",e[e.CanvasMutation=9]="CanvasMutation",e[e.Font=10]="Font",e[e.Log=11]="Log",e[e.Drag=12]="Drag",e[e.StyleDeclaration=13]="StyleDeclaration",e[e.Selection=14]="Selection",e[e.AdoptedStyleSheet=15]="AdoptedStyleSheet",e[e.CustomElement=16]="CustomElement",e))(J||{});const Lt=(e,t)=>t.some(n=>e instanceof n);let Bn,Nn;function Ji(){return Bn||(Bn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Qi(){return Nn||(Nn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const St=new WeakMap,Ut=new WeakMap,qe=new WeakMap;function Xi(e){const t=new Promise((n,i)=>{const r=()=>{n(re(e.result))},s=()=>{i(e.error)};e.onsuccess=r,e.onerror=s});return qe.set(t,e),t}function Zi(e){if(St.has(e))return;const t=new Promise((n,i)=>{const r=()=>{n()},s=()=>{i(e.error||new DOMException("AbortError","AbortError"))};e.oncomplete=r,e.onerror=s,e.onabort=s});St.set(e,t)}let It={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return St.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return re(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function Fn(e){It=e(It)}function es(e){return Qi().includes(e)?function(...t){return e.apply(Et(this),t),re(this.request)}:function(...t){return re(e.apply(Et(this),t))}}function ts(e){return typeof e=="function"?es(e):(e instanceof IDBTransaction&&Zi(e),Lt(e,Ji())?new Proxy(e,It):e)}function re(e){if(e instanceof IDBRequest)return Xi(e);if(Ut.has(e))return Ut.get(e);const t=ts(e);return t!==e&&(Ut.set(e,t),qe.set(t,e)),t}const Et=e=>qe.get(e);function ns(e,t,{blocked:n,upgrade:i,blocking:r,terminated:s}={}){const o=indexedDB.open(e,t),a=re(o);return i&&(o.onupgradeneeded=d=>{i(re(o.result),d.oldVersion,d.newVersion,re(o.transaction),d)}),n&&(o.onblocked=d=>n(d.oldVersion,d.newVersion,d)),a.then(d=>{s&&(d.onclose=()=>s()),r&&(d.onversionchange=l=>r(l.oldVersion,l.newVersion,l))}).catch(()=>{}),a}function kt(e,{blocked:t}={}){const n=indexedDB.deleteDatabase(e);return t&&(n.onblocked=i=>t(i.oldVersion,i)),re(n).then(()=>{})}const rs=["get","getKey","getAll","getAllKeys","count"],is=["put","add","delete","clear"],_t=new Map;function Hn(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(_t.get(t))return _t.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,r=is.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(r||rs.includes(n)))return;const s=async function(o,...a){const d=this.transaction(o,r?"readwrite":"readonly");let l=d.store;return i&&(l=l.index(a.shift())),(await Promise.all([l[n](...a),r&&d.done]))[0]};return _t.set(t,s),s}Fn(e=>({...e,get:(t,n,i)=>Hn(t,n)||e.get(t,n,i),has:(t,n)=>!!Hn(t,n)||e.has(t,n)}));const ss=["continue","continuePrimaryKey","advance"],Vn={},Rt=new WeakMap,Wn=new WeakMap,os={get(e,t){if(!ss.includes(t))return e[t];let n=Vn[t];return n||(n=Vn[t]=function(...i){Rt.set(this,Wn.get(this)[t](...i))}),n}};async function*as(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,os);for(Wn.set(n,t),qe.set(n,Et(t));t;)yield n,t=await(Rt.get(n)||t.continue()),Rt.delete(n)}function jn(e,t){return t===Symbol.asyncIterator&&Lt(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&Lt(e,[IDBIndex,IDBObjectStore])}Fn(e=>({...e,get(t,n,i){return jn(t,n)?as:e.get(t,n,i)},has(t,n){return jn(t,n)||e.has(t,n)}}));const $e={Loaded:"sprigReplayIframeLoaded",Settings:"sprigReplayIframeSettings",Snapshot:"sprigReplayIframeTakeFullSnapshot",Teardown:"sprigReplayTeardown"},Dt=[],ds=(e,t)=>{window.addEventListener("message",n=>{var i;n.data.type===$e.Loaded&&(Dt.push({source:n.source,origin:n.origin}),(i=n.source)==null||i.postMessage({type:$e.Settings,settings:e,replayLibraryUrl:t},{targetOrigin:n.origin}))})},cs=()=>{Dt.forEach(e=>{var t;(t=e.source)==null||t.postMessage({type:$e.Snapshot},{targetOrigin:e.origin})})},ls=()=>{Dt.forEach(e=>{var t;(t=e.source)==null||t.postMessage({type:$e.Teardown},{targetOrigin:e.origin})})};class us{constructor(t){_(this,"awaitingResolvers",[]);_(this,"activeCount",0);this.capacity=t}async acquire(){if(this.activeCount<this.capacity){this.activeCount++;return}return new Promise(t=>{this.awaitingResolvers.push(t)})}release(){const t=this.awaitingResolvers.shift();t&&this.activeCount<=this.capacity?t():this.activeCount--}async execute(t){try{return await this.acquire(),await t()}finally{this.release()}}setLimit(t){this.capacity=t}}const qn=new us(2),ps=e=>qn.setLimit(e),ws=async e=>qn.execute(async()=>{var i;w.info("UploadChunkStart",{chunkIndex:e.chunkIndex,surveyId:e.surveyId});const t=await Y(e.uploadUrl,{body:e.data,method:"PUT"});w.http("UploadChunkEnd",{url:e.uploadUrl,method:"PUT",status_code:t.status,reason:t.statusText??"OK",chunkIndex:e.chunkIndex,surveyId:e.surveyId});const n=(i=t.headers)==null?void 0:i.get("ETag");if(!n)throw new Error(`Upload response did not include etag for upload ${e.uploadId}, part ${e.chunkIndex}`);return n}),$n=async({apiUrl:e,surveyId:t,uploadId:n,etags:i,headers:r,responseGroupUuid:s,replayDuration:o,eventDigest:a},d=!1)=>{var u;if(!d&&!n&&!i){w.error("UploadErr",{isMobile:d,uploadId:n,etags:i});return}w.info("MarkUploadComplete",{surveyId:t});const l=await Y(`${e}/sdk/1/completeSessionReplay`,{method:"POST",body:JSON.stringify({etags:i,uploadId:n,responseGroupUuid:s,surveyId:t,replayDuration:o,eventDigest:a,userAgent:(u=window==null?void 0:window.navigator)==null?void 0:u.userAgent}),headers:r,shouldRetryRequest:!0});return w.info("MarkUploadDone",{surveyId:t}),l},fs=e=>{if(e instanceof Attr)return null;let t=1;for(let n=e.previousSibling;n;n=n.previousSibling)n.nodeName===e.nodeName&&++t;return t},zn=e=>{if(e===null)return"";const t=[];if(e instanceof Document)return"/";for(let n=e;n&&!(n instanceof Document)&&n!==null;n=n instanceof Attr?n.ownerElement:n.parentElement){const i=t[t.length]={name:void 0,position:null};switch(n.nodeType){case Node.TEXT_NODE:i.name="text()";break;case Node.ATTRIBUTE_NODE:i.name="@"+n.nodeName;break;case Node.PROCESSING_INSTRUCTION_NODE:i.name="processing-instruction()";break;case Node.COMMENT_NODE:i.name="comment()";break;case Node.ELEMENT_NODE:i.name=n.nodeName;break}i.position=fs(n)}return"/"+t.reverse().map(n=>n.position!==null?`/${n.name}[${n.position}]`:`/${n.name}`).join("")},Ct=e=>e&&e.trim().substring(0,500).replace(/\s\s+/g," ").replace(/\r?\n|\r/g," ").substring(0,250),gs=(e,t)=>{let n;return i=>{clearTimeout(n),n=window.setTimeout(()=>e(i),t)}},z={capture:!0,passive:!0},ms=["a","button","input","option","li","link"],ys=["Escape","Enter","Backspace","F5","Tab"];let ze=!1,P=null,Ke=null;const hs=e=>{e.currentPageTitle&&(e.currentPageTitle=Ct(e.currentPageTitle)),P==null||P("Sprig_BackForward",e)},vs=e=>{var t;(t=e==null?void 0:e.elementAttributes)!=null&&t.text&&(e.elementAttributes.text=Ct(e.elementAttributes.text)),P==null||P("Sprig_Click",e)},bs=e=>{P==null||P("Sprig_Refresh",e)},Ls=e=>{P==null||P("Sprig_Keystroke",e)},Ss=e=>{if(!e.tagName)return"No tagName";const t=e.getAttribute("type");return t?`${t} ${e.tagName.toLowerCase()}`:e.tagName.toLowerCase()},Kn=e=>{var n;if(((n=e.tagName)==null?void 0:n.toLowerCase())==="html")return{element:"html"};const t={};return t.element=Ss(e),t},Us=e=>{var r;if(!e)return{};const n={...Kn(e)},i=e.parentElement;if(i&&ms.includes((r=i.tagName)==null?void 0:r.toLowerCase())){const s=Kn(i);Object.assign(n,s)}return n},Gn=(e,t)=>{var i;let n=t.target;t.target===((i=window.document)==null?void 0:i.body)&&window.Sprig.pointerDownTarget&&(n=window.Sprig.pointerDownTarget),vs({x:t.x,y:t.y,type:e,elementAttributes:Us(n),windowHeight:window.innerHeight,windowWidth:window.innerWidth,...n instanceof HTMLElement||n instanceof SVGElement||n instanceof MathMLElement?{rect:n==null?void 0:n.getBoundingClientRect(),xPath:zn(n)}:{}})},Is=e=>t=>Gn(e,t),Yn=e=>{ys.includes(e.key)&&Ls({key:e.key})},Es=()=>{window.performance.getEntriesByType("navigation").map(t=>t.type).includes("reload")&&bs({url:window.location.href,currentPageTitle:document.title})},ks=()=>{window.performance.getEntriesByType("navigation").map(t=>t.type).includes("back_forward")&&hs({curUrl:window.location.href,fromUrl:document.referrer,currentPageTitle:document.title})},Jn=gs(e=>{if(!(e.target instanceof HTMLElement||e.target instanceof Document))return;let t=e.target;"scrollTop"in t||(t=t.documentElement),Ke==null||Ke({xPath:zn(t),x:t.scrollLeft,y:t.scrollTop,elementAttributes:{targetScrollWidth:t.scrollWidth,targetClientWidth:t.clientWidth,targetScrollHeight:t.scrollHeight,targetClientHeight:t.clientHeight}})},750),Qn=Is("left_click"),Xn=e=>{e.button===2&&Gn("right_click",e)},Zn=e=>{window.Sprig&&(window.Sprig.pointerDownTarget=e.target)},_s=(e,t)=>{ze||(P=e,Ke=t,window.addEventListener("click",Qn,z),window.addEventListener("pointerdown",Zn,z),window.addEventListener("mousedown",Xn,z),window.addEventListener("keydown",Yn,z),window.addEventListener("scroll",Jn,z),ze=!0,Es(),ks())},Rs=()=>{ze&&(window.removeEventListener("click",Qn,z),window.removeEventListener("pointerdown",Zn,z),window.removeEventListener("mousedown",Xn,z),window.removeEventListener("keydown",Yn,z),window.removeEventListener("scroll",Jn,z),ze=!1)},Ds=3e4,U={isRecording:!1,scrollEventUuids:{},stopRecording:()=>{}},er=()=>window.indexedDB&&window.IDBKeyRange&&window.CompressionStream,Cs=.5,As=async()=>{var e;if(!er())return!0;if((e=window.navigator.storage)!=null&&e.estimate)try{const{quota:t=0,usage:n=0}=await window.navigator.storage.estimate(),i=(t-n)/1024**3;return w.info("Storage",{availableGb:i}),i<Cs}catch{return!0}return!1},C=(()=>{const e=S.getItem("sprig.sessionId");if(e)return w.info("SessionIDFound",{savedSessionId:e}),S.removeItem("sprig.sessionId"),e;const t=le();return w.info("GeneratedSessionID",{uuid:t}),t})(),At=()=>{S.setItem("sprig.disableReplayRecording","disabled")},K=()=>!!S.getItem("sprig.disableReplayRecording"),Ts=()=>{S.setItem("sprig.isReplayPaused","true")},xs=()=>{S.removeItem("sprig.isReplayPaused")},Ge=()=>!!S.getItem("sprig.isReplayPaused");window.addEventListener("beforeunload",()=>{w.info("BeforeUnload",{sessionId:C}),S.setItem("sprig.sessionId",C)});const Ps=()=>K()?w.debug("ReplayDisabled-PendingHeatmaps"):O(async()=>{const t=(await b.getPendingCaptures({isHeatmap:!0})).map(n=>({eventId:n.captureParams.eventId,uuid:n.uuid})).filter(({eventId:n})=>!wn(n)).map(({uuid:n})=>n);return w.info("PendingHeatmapsToComplete",{count:t.length}),t.length&&(await b.markPendingHeatmapsReady(t),w.info("MarkedPendingHeatmapsReady")),t.length},"Error marking pending heatmaps ready"),Os=e=>{Date.now()-e>=Ds&&O(()=>b.markPendingHeatmapsReady(),"Error in heatmap inactivity")},Q=(e,t)=>{var n,i;if(!(K()||!U.isRecording||Ge()))try{(i=(n=window.rrwebRecord)==null?void 0:n.addCustomEvent)==null||i.call(n,e,t)}catch(r){Ee("Error recording custom event",r)}},Ms=e=>{e.description&&(e.description=Ct(e.description)),Q("Sprig_PageView",e)},Bs=e=>{Q("Sprig_TrackEvent",e)},Ns=e=>{Q("Sprig_ShowSurvey",e)},Fs=e=>{Q("Sprig_SubmitSurvey",e)},Hs=async e=>{const{x:t,xPath:n,y:i}=e,r=U.scrollEventUuids[n];if(r)return O(async()=>{var a,d,l,u;const s=await b.openDB(),o=await s.get("events",r);if(o!=null&&o.event){const c=JSON.parse(o.event),m=t>((d=(a=c.data)==null?void 0:a.payload)==null?void 0:d.x),p=i>((u=(l=c.data)==null?void 0:l.payload)==null?void 0:u.y);if(!(m||p))return null;m&&(c.data.payload.x=t),p&&(c.data.payload.y=i),c.data.payload.elementAttributes=e.elementAttributes,o.event=JSON.stringify(c),await s.put("events",o)}else Q("Sprig_Scroll",e)},"Error updating scroll event");Q("Sprig_Scroll",e)},Vs=()=>{Q("Sprig_ReplayPaused",{timestamp:Date.now()}),Ts()},Ws=()=>{xs(),Q("Sprig_ReplayResumed",{timestamp:Date.now()})},js=()=>U.isRecording,tr=()=>{U.stopRecording&&(U.stopRecording(),U.stopRecording=void 0),U.isRecording=!1,["cleanupInterval","inactivityInterval","pendingCheckInterval"].forEach(e=>{U[e]&&(clearInterval(U[e]),U[e]=void 0)}),Rs(),ls()},qs=["did not allow mutations","called in an invalid security context"],$s=e=>{if(!e)return!0;for(const t of qs)if(e.toLowerCase().includes(t))return!1;return!0},zs=(e,t,{reportError:n=!0,extraInfo:i={}})=>{if(!(K()||!(t instanceof Error))){if(At(),t.name==="VersionError"){w.error("VersionErr",{message:e}),b.deleteDB();return}$s(t==null?void 0:t.message)&&(n&&window.UserLeap.reportError(e,t,i),b.clearAll())}},Ee=(e,t,{reportError:n}={reportError:!0})=>{tr(),w.error("ReplayErr",{code:t.code,name:t.name}),zs(e,t,{reportError:n})},O=async(e,t)=>{try{return await e()}catch(n){Ee(t,n)}},Tt=()=>{U.isRecording&&(O(()=>{var e,t;return(t=(e=window.rrwebRecord)==null?void 0:e.takeFullSnapshot)==null?void 0:t.call(e,!0)},"Error recording full snapshot"),cs())},Ks=async({surveyId:e,responseGroupUuid:t,eventDigest:n,headers:i})=>{if(!e||!t)return!1;const r=window.UserLeap._API_URL,s=await $n({surveyId:e,responseGroupUuid:t,eventDigest:n,apiUrl:r,headers:i},!0);return!(s!=null&&s.error)},nr=30,Gs=1;let xt=0;(async()=>{er()&&Promise.allSettled([kt("replayStorage"),kt("sprig.replay")])})();class Ys{constructor(){_(this,"wrapTransactionWithCounter",t=>{var r,s;const n=(s=(r=window.Sprig)==null?void 0:r._config)==null?void 0:s.outstandingTransactionLimit,i=n===void 0?100:n;if(i&&xt>i){const o="Too many outstanding transactions";Ee(o,new Error(o),{reportError:!1})}xt++,t.done.finally(()=>{xt--})});_(this,"getTransaction",async t=>{const i=(await this.openDB()).transaction(t,"readwrite");return this.wrapTransactionWithCounter(i),i})}openDB(){return ns("sprigReplay",Gs,{upgrade:(t,n,i)=>{if(i===0&&S.setItem("sprig.pendingCount","0"),!t.objectStoreNames.contains("events")){const r=t.createObjectStore("events",{keyPath:"uuid"});r.createIndex("sessionId","sessionId"),r.createIndex("timestamp","timestamp"),r.createIndex("[sessionId+timestamp]",["sessionId","timestamp"])}if(!t.objectStoreNames.contains("chunkUploads")){const r=t.createObjectStore("chunkUploads",{keyPath:"uuid"});r.createIndex("sessionId","sessionId"),r.createIndex("timestamp","timestamp"),r.createIndex("[sessionId+status]",["sessionId","status"]),r.createIndex("[uploadId+status]",["uploadId","status"]),r.createIndex("[sessionId+status+uploadId]",["sessionId","status","uploadId"])}if(!t.objectStoreNames.contains("pendingCaptures")){const r=t.createObjectStore("pendingCaptures",{keyPath:"uuid"});r.createIndex("sessionId","sessionId"),r.createIndex("timestamp","timestamp"),r.createIndex("[sessionId+targetTimestamp]",["sessionId","targetTimestamp"])}}})}async deleteDB(){try{await kt("sprigReplay")}catch{}}async bulkAdd(t,n){const i=await this.getTransaction(t);return Promise.all([...n.map(r=>i.store.add(r)),i.done])}async clearAll(){const t=(await this.openDB()).transaction(["events","chunkUploads","pendingCaptures"],"readwrite");return this.wrapTransactionWithCounter(t),Promise.all([t.objectStore("events").clear(),t.objectStore("chunkUploads").clear(),t.objectStore("pendingCaptures").clear()])}async deleteBySessionId(t,n){const i=IDBKeyRange.only(n),r=await this.getTransaction(t),s=r.store.index("sessionId");for await(const o of s.iterate(i))await o.delete();await r.done}async updatePartial(t,n,i){const r=await this.getTransaction(t),s=await r.store.get(n);s&&await r.store.put({...s,...i}),await r.done}async deleteRowsBefore(t,n,i=()=>!0){const r=IDBKeyRange.upperBound(n,!0),s=await this.getTransaction(t),o=s.store.index("timestamp");for await(const a of o.iterate(r))i(a.value)&&await a.delete();await s.done}async getEventsBetween(t,n=Date.now()){if(t>=n)return Promise.resolve([]);const i=IDBKeyRange.bound([C,t],[C,n],!1,!0);return(await this.openDB()).getAllFromIndex("events","[sessionId+timestamp]",i)}async updateEventsExpiredAt(t,n,i=nr){const r=new Date,s=r.setMinutes(r.getMinutes()+(i??nr)),o=await this.getTransaction("events"),a=o.store.index("[sessionId+timestamp]"),d=IDBKeyRange.bound([C,t],[C,n],!1,!0);for await(const l of a.iterate(d))await l.update({...l.value,expiredAt:s});await o.done}async deleteChunkUploads(t,n){const i=IDBKeyRange.only([n,t]),r=await this.getTransaction("chunkUploads");let o=await r.store.index("[uploadId+status]").openCursor(i);for(;o;)o.delete(),o=await o.continue();await r.done}async getChunkUploadsByStatus({sessionId:t,status:n,uploadId:i}){const s=(await this.openDB()).transaction("chunkUploads","readonly");this.wrapTransactionWithCounter(s);const o=i?s.store.index("[uploadId+status]"):s.store.index("[sessionId+status]"),a=i?IDBKeyRange.only([i,n]):IDBKeyRange.only([t,n]);return o.getAll(a)}async getPendingCaptures(t={}){return(await(await this.openDB()).getAllFromIndex("pendingCaptures","sessionId",C)).filter(r=>!t.beforePresent||r.targetTimestamp<Date.now()).filter(r=>!t.isBeforeType||r.captureParams.replayParams.replayDurationType==="before").filter(r=>!t.isHeatmap||(r.captureParams.isHeatmap??!1))}async markPendingCaptureToCanUpload(t){const n=await this.getTransaction("pendingCaptures"),i=n.store.index("sessionId");for await(const r of i.iterate(C)){const s=r.value;s.captureParams.responseGroupId===t&&await r.update({...s,canUpload:!0})}await n.done}async markPendingHeatmapsReady(t){if(parseInt(S.getItem("sprig.pendingCount")??"0")===0)return null;const i=Date.now(),r=await this.getTransaction("pendingCaptures"),s=r.store.index("sessionId");for await(const o of s.iterate(C)){const a=o.value;a.captureParams.isHeatmap&&(!t||t.includes(a.uuid))&&await o.update({...a,targetTimestamp:i,captureParams:{...a.captureParams,triggerTimestamp:i,replayParams:{...a.captureParams.replayParams,replayDurationSeconds:Math.floor((i-a.timestamp)/1e3)}}})}await r.done}}const b=new Ys,Js=35*1e3,X=[];let ae=[],pe=!1,ke,rr,we=0,Ye=!1,ir=!1;const Pt=[];let Ot=!1,Je,sr,Qe,or;const fe=()=>Ye&&!pe&&Date.now()<=Je,Qs=({apiUrl:e,config:t,triggerSnapshot:n,forceInit:i=!1})=>{if(!(Ye&&!i)){if(!S.isStorageAvailable){pe=!0;return}ae=[],Pt.splice(0),X.splice(0),we=0,Qe=n,rr=e,ke={responseGroupUuid:t.responseGroupUuid,surveyId:t.surveyId,userAgent:t.userAgent,sdkVersion:t.sdkVersion},sr=t.maxDurationSeconds,to(),Ye||(or=window.setInterval(eo,500)),Ye=!0}},Xs=[J.Drag,J.Input,J.MediaInteraction,J.MouseInteraction,J.MouseMove,J.Scroll,J.Selection,J.TouchMove],Zs=e=>e.type===ne.Custom||e.type===ne.IncrementalSnapshot&&Xs.includes(e.data.source),Mt=e=>e.some(Zs),eo=async()=>{if(!fe()){window.clearInterval(or);return}if(ar(),!Mt(X))return;const e=X[0].timestamp;Date.now()-e>Js&&(Qe==null||Qe())},ar=async()=>{if(ae.length||Ot)return;Ot=!0;const e=await so();if(!e){pe=!0;return}Pt.splice(0,e.length).forEach(n=>n(e.shift())),e.forEach(n=>ae.push(n)),Ot=!1},to=()=>{const e=S.getItem("sprig.alwayson.info");if(e){w.info("Read stored session state",e);const t=JSON.parse(e);pe=t.disabled,ke=t.metadata,ae=t.uploadUrls,we=t.currentIndex,Je=t.expirationTimestamp,t.pendingEventTimestamp&&(w.info(`Uploading with pending timestamp: ${t.pendingEventTimestamp}`),no(t.pendingEventTimestamp))}else Je=sr*1e3+Date.now()},no=async e=>{const t=Date.now(),i=(await b.getEventsBetween(e,t)).map(s=>JSON.parse(s.event));if(!Mt(i))return;ur(i);const r=await lr();r&&await cr(r,i)},ro=()=>{let e;X.length&&(e=X[0].timestamp);const t={disabled:pe,metadata:ke,uploadUrls:ae,currentIndex:we,pendingEventTimestamp:e,expirationTimestamp:Je};w.info("Storing session state on unload",t),S.setItem("sprig.alwayson.info",JSON.stringify(t))},io=async e=>{const t=new TextEncoder,n=new CompressionStream("gzip"),i=n.writable.getWriter(),r=t.encode(JSON.stringify(e));return i.write(r),i.close(),new Uint8Array(await new Response(n.readable).arrayBuffer())},dr=async(e,t)=>{try{const n=await e();if(!n.ok)throw new Error(`Error ${t}`);return n}catch{pe=!0}},cr=async(e,t)=>{if(!fe()||!e)return;const n=await io(t);w.info("Uploading always-on events with presigned url"),await dr(()=>Y(e,{body:n,method:"PUT"}),"uploading always-on with presigned url")},so=async()=>{if(!fe())return;const{surveyId:e,responseGroupUuid:t}=ke,n={responseGroupUuid:t,surveyId:e,index:we+1};w.info("Fetching always-on upload urls",n);const i=await dr(()=>Y(`${rr}/sdk/1/replayUrls`,{method:"POST",body:JSON.stringify(n),headers:N(window.UserLeap)}),"fetching always-on signed urls");if(!i)return;const r=i.json.signedUrls;return w.info("Fetched more always-on upload urls",{body:n,urls:r}),r},lr=async()=>{if(ae.length)return ae.shift();const e=new Promise(t=>{Pt.push(t)});return ar(),e},oo=async()=>{const e=X.splice(0);if(!Mt(e))return;w.info("Capturing always-on event array to upload"),ur(e);const t=await lr();t&&await cr(t,e)},ur=e=>{var r,s,o;const t=e.length?e[e.length-1].timestamp:Date.now(),n=we,i=((s=(r=window.UserLeap)==null?void 0:r.config)==null?void 0:s.customMetadata)??((o=window.__cfg)==null?void 0:o.customMetadata);we++,e.push({timestamp:t,type:ne.Custom,data:{tag:"Sprig_Meta",payload:{...ke,index:n,visitorId:window.UserLeap.visitorId??"",timestamp:t,customMetadata:i}}})},ao=async()=>{ir=!0,fe()&&(w.info("Always On handle page unload"),ro())},co=(e,t)=>{!fe()||ir||!e&&!X.length||(e&&X.length&&oo(),X.push(t))};window.addEventListener("beforeunload",ao);const pr=async(e,t)=>{const n=performance.now();let i;try{i=await e()}finally{const r=performance.now()-n;let s=Le[t];s||(s=$(t)),s.report(r/1e3)}return i},wr=(e,t)=>{const n=performance.now();try{e()}finally{const i=performance.now()-n;let r=Le[t];r||(r=$(t)),r.report(i/1e3)}};let fr=5e3,Bt=6e4,Nt=0;const lo=5,Ft=30,Xe=Ft+lo;let ie,Ht=!1,Vt=[];const uo=async({maxReplayDurationSeconds:e,maxInflightRequests:t=2,replaySettings:n,teardownAfter:i=!1,apiUrl:r,alwaysOnConfig:s})=>{if(s&&Qs({apiUrl:r,config:s,triggerSnapshot:()=>{Tt()}}),ie=S.getItem("sprig.pendingCount"),U.isRecording)return;if(i&&S.setItem("sprig.teardownAfterCapture","true"),K())return w.debug("ReplayDisabled");if(await As())return w.debug("IDBNotSupported"),At();try{const d=await b.openDB();w.info("DBVersion",{version:d.version})}catch(d){return w.error("ReplayOpenErr",{name:d.name}),d.name==="VersionError"&&b.deleteDB(),At()}O(async()=>{await jt(!0)},"Error uploading ready pending captures");const o=fe()?Ft:0,a=Math.max(e??0,o);if(!a)return w.debug("MissingDuration");w.debug("ReplayInit"),await O(async()=>{n!=null&&n.minDuration&&(fr=n.minDuration),n!=null&&n.batchDuration&&(Bt=n.batchDuration),ps(t),vo(),go(a+Xe,30*60,a+Xe),mo();const d=window.UserLeap.replayLibraryURL??"https://cdn.sprig.com/dependencies/record.min.js";if(!window.rrwebRecord){const{record:p}=await import(d);window.rrwebRecord=p}const l=window.rrwebRecord;if(!l)return w.error("RecordScriptFailed");let u=!0,c=0;const m={checkoutEveryNms:Ft*1e3,sampling:{input:"last",scroll:250,media:800},...n,mutationQueueEnabled:n==null?void 0:n.enableMutationQueue};U.stopRecording=l({emit:(p,y)=>{if(p.type===ne.Custom&&(Nt=Date.now()),K()||Ge())return;if(y&&p.type===ne.Meta)c=performance.now();else if(y&&c&&p.type===ne.FullSnapshot){const I=performance.now()-c;In("sdk_replay_snapshot_seconds",I/1e3)}const h=u||!!y&&p.type===ne.Meta;u=!1,co(h,p),po({uuid:le(),event:JSON.stringify(p),isValidStart:h,timestamp:Date.now()})},...m}),U.isRecording=!!U.stopRecording,U.isRecording&&(ds(m,d),g.on("survey.complete",p=>{Fs({id:p,userAgent:window.navigator.userAgent})}),_s(Q,Hs))},"Error initializing replay")},po=e=>{var t,n,i,r;if((t=e.event)!=null&&t.includes("Sprig_Scroll")){const s=(r=(i=(n=JSON.parse(e.event))==null?void 0:n.data)==null?void 0:i.payload)==null?void 0:r.xPath;if(!s)return;U.scrollEventUuids[s]=e.uuid}Vt.push(e),Ht||fo()},wo=async e=>{const t=e.map(n=>({...n,sessionId:n.sessionId??C}));if(t.length!==0)return O(()=>b.bulkAdd("events",t),"Error storing replay events")},fo=()=>{Ht=!0,setTimeout(async()=>{if(K()||Ge())return;const e=Vt;Vt=[],Ht=!1,wr(async()=>{await wo(e)},"sdk_replay_add_event_batch_seconds")},500)},go=(e,t,n)=>{U.cleanupInterval=window.setInterval(()=>{const i=Date.now();pr(()=>O(async()=>{K()||await Promise.all([b.deleteRowsBefore("events",i-e*1e3,r=>r.expiredAt===void 0||r.expiredAt<i-e*1e3),b.deleteRowsBefore("chunkUploads",i-t*1e3),b.deleteRowsBefore("pendingCaptures",i-n*1e3,r=>!r.canUpload)])},"Error deleting table rows"),"sdk_replay_cleanup_seconds"),w.debug("CleanupComplete")},3e4)},mo=()=>{U.pendingCheckInterval=window.setInterval(async()=>{O(async()=>{await jt()},"Error initiating pending captures")},5e3)};let Wt=!1;const jt=async(e=!1)=>{if(!Wt)try{Wt=!0;const t=parseInt(ie??"0");if(t===0)return;const n=await b.getPendingCaptures({beforePresent:!0,isBeforeType:e}),i=await b.openDB();await Promise.all(n.map(async r=>(await i.delete("pendingCaptures",r.uuid),hr(r.captureParams,r.canUpload)))),ie=(t-n.length).toString(),S.setItem("sprig.pendingCount",ie)}finally{Wt=!1}},yo=async(e,t,n,i,r)=>{const s=Math.min(e+r,n),o=await pr(()=>b.getEventsBetween(e,s),"sdk_replay_get_events_between_seconds");if(!(o!=null&&o.length))return w.debug("NoEventsFound"),{validStartFound:i,events:[]};if(!i){w.debug("ValidStartSearch");let a=-1;return o==null||o.forEach((d,l)=>{if(!d.isValidStart)return;const u=d.timestamp<=t;(a<0||u)&&(a=l)}),a<0?(w.debug("ValidStartNotFound"),{validStartFound:i,events:[]}):{validStartFound:!0,events:o==null?void 0:o.slice(a)}}return{validStartFound:i,events:o}},ho=(e,t,n)=>{const i=e.length,r=t*1024*1024,s=Math.ceil(i/n),o=Math.max(r,s),a=[];let d=0;for(;d<i;)a.push(e.slice(d,d+o)),d+=o;return a},gr=e=>Promise.all(e.map(async t=>{const n=await ws(t);return await b.updatePartial("chunkUploads",t.uuid,{data:null,etag:n,status:"UploadComplete"}),t.uploadId})),mr=async e=>{const t=await b.getChunkUploadsByStatus({status:"UploadComplete",uploadId:e});if(!(t!=null&&t.length)){w.info("NoChunksForUpload",{uploadId:e});return}const n=t.reduce((s,o)=>(s.find(a=>a.chunkIndex===o.chunkIndex)||s.push(o),s),[]);n.sort((s,o)=>s.chunkIndex-o.chunkIndex);const i=n.map(s=>({ETag:s.etag,PartNumber:s.chunkIndex})).filter(s=>s.ETag!==null),r=n[0];await $n({apiUrl:r.apiUrl,surveyId:r.surveyId,uploadId:e,responseGroupUuid:r.responseGroupId,etags:i,headers:r.completeUploadHeaders,replayDuration:r.replayDuration}),await b.deleteChunkUploads("UploadComplete",e)},vo=()=>{O(async()=>{const e=await b.getChunkUploadsByStatus({sessionId:C,status:"ReadyForUpload"});if(!(e!=null&&e.length))return;const t=await gr(e);t!=null&&t.length&&await Promise.all(t.map(n=>{if(n)return mr(n)}))},"Error uploading unfinished chunks")},bo=async(e,t)=>{await gr(t),await Promise.all(e.map(n=>mr(n)))},Lo=async(e,t)=>{const n=new TextEncoder;let i=null;const r=new CompressionStream("gzip"),s=r.writable.getWriter();let o=!1,a=!1,[d,l]=[0,0];const u=e-Xe*1e3;let c=[];for(let p=u;p<t;p+=Bt){if({validStartFound:a,events:c}=await yo(p,e,t,a,Bt),!(c!=null&&c.length)){w.debug("NoEventsFound");continue}d===0&&(d=c[0].timestamp),l=c[c.length-1].timestamp;const y=c.map(k=>k.event);y.push(`{"timestamp":${t}}`);const h=`${o?",":"["}${y}`,I=n.encode(h);wr(()=>{s.write(I)},"sdk_replay_compression_seconds"),o=!0}if(l-d<fr)return w.debug("ReplayTooShort"),null;const m=n.encode("]");return s.write(m),s.close(),i=new Uint8Array(await new Response(r.readable).arrayBuffer()),i},So=async(e,t)=>{const n=t??Date.now(),i=n-e;return Lo(i,n)},yr=async e=>{const{surveyId:t,responseGroupId:n,visitorId:i,apiUrl:r,completeUploadHeaders:s,replayParams:o,triggerTimestamp:a}=e,d=await So(o.replayDurationSeconds*1e3,a);if(!(d!=null&&d.length)){w.info("FileDataEmpty",{surveyId:t});return}const l=ho(d,o.minimumChunkSizeMb,o.signedUrls.length),u=await Promise.all(l.map(async(c,m)=>{const p=le(),y={apiUrl:r,chunkIndex:m+1,completeUploadHeaders:s,etag:null,responseGroupId:n,status:"ReadyForUpload",surveyId:t,timestamp:a,totalChunks:l.length,data:c,uploadId:o.uploadId,uploadUrl:o.signedUrls[m].url,uuid:p,visitorId:i};return await(await b.openDB()).add("chunkUploads",{...y,sessionId:y.sessionId??C}),y}));await bo([o.uploadId],u)},hr=async(e,t)=>{if(K())return w.debug("ReplayDisabled-ScheduleOrCapture");const{isHeatmap:n,isStandalone:i,replayParams:r,triggerTimestamp:s,responseGroupId:o}=e,a=async()=>{setTimeout(()=>g.removeListener(f.QuestionAnswered,a),0),O(async()=>{r.replayDurationType==="before"?await yr(e):await b.markPendingCaptureToCanUpload(o)},"Error in schedule/capture callback")};O(async()=>{if(r.replayDurationType==="after"||r.replayDurationType==="beforeAndAfter"){!i&&!n&&g.on(f.QuestionAnswered,a),await br(e);return}if(i||n||t)await yr(e),n&&Uo();else{const l=Xe+r.replayDurationSeconds,u=s-l*1e3,c=s;await b.updateEventsExpiredAt(u,c,r.expirationTimeLimitMinutes),g.on(f.QuestionAnswered,a)}},"Error in scheduling/capturing replay")},Uo=async()=>{parseInt(ie??"0")||S.removeItem("sprig.isCapturingHeatmap"),S.getItem("sprig.teardownAfterCapture")&&(tr(),vr(),S.removeItem("sprig.teardownAfterCapture"))},vr=async()=>K()?w.debug("ReplayDisabled-ClearData"):Promise.all([b.deleteBySessionId("events",C),b.deleteBySessionId("pendingCaptures",C)]).catch(e=>{Ee("Error clearing user replay data",e)}),br=async e=>{if(K())return;const{isHeatmap:t,surveyId:n}=e,i=await b.getPendingCaptures(),r=i==null?void 0:i.filter(d=>d.captureParams.surveyId===n);if(r!=null&&r.length){w.info("PendingCaptureExists",{surveyId:n});return}t&&(Tt(),S.setItem("sprig.isCapturingHeatmap","true"),Nt=Date.now(),U.inactivityInterval||(U.inactivityInterval=window.setInterval(()=>{Os(Nt)},1e3)));const s={...e,replayParams:{...e.replayParams}};e.replayParams.replayDurationType==="beforeAndAfter"&&(s.replayParams.replayDurationSeconds*=2),s.replayParams.replayDurationType="before";const o=e.triggerTimestamp+e.replayParams.replayDurationSeconds*1e3;s.triggerTimestamp=o,ie=(parseInt(ie??"0")+1).toString(),S.setItem("sprig.pendingCount",ie),await(await b.openDB()).add("pendingCaptures",{canUpload:!1,captureParams:s,sessionId:C,targetTimestamp:o,timestamp:Date.now(),uuid:le()})};Hr(Object.freeze(Object.defineProperty({__proto__:null,RecordEvent:Bs,RecordPageView:Ms,RecordSurveyShown:Ns,_completeSessionReplay:Ks,checkPendingHeatmapsUrl:Ps,clearUserReplayData:vr,disableRecording:Ee,initializeReplay:uo,isReplayPaused:Ge,isReplayRecording:js,recordFullSnapshot:Tt,recordReplayPaused:Vs,recordReplayResumed:Ws,scheduleCapture:br,scheduleOrCaptureReplay:hr,tryReplayAction:O,uploadReadyPendingCaptures:jt},Symbol.toStringTag,{value:"Module"})));const Io="sprig-web-view-sdk";let Lr;Lr={path:`https://cdn.sprig.com/${Io}-v2.40.3.js`},Yi(Lr)})();
