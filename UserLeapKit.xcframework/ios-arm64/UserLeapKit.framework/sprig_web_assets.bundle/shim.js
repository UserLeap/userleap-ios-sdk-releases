(function(){"use strict";var Ts=Object.defineProperty;var Ps=(N,j,Z)=>j in N?Ts(N,j,{enumerable:!0,configurable:!0,writable:!0,value:Z}):N[j]=Z;var R=(N,j,Z)=>(Ps(N,typeof j!="symbol"?j+"":j,Z),Z);let N;const j=new Uint8Array(16);function Z(){if(!N&&(N=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!N))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return N(j)}const E=[];for(let e=0;e<256;++e)E.push((e+256).toString(16).slice(1));function Qn(e,t=0){return E[e[t+0]]+E[e[t+1]]+E[e[t+2]]+E[e[t+3]]+"-"+E[e[t+4]]+E[e[t+5]]+"-"+E[e[t+6]]+E[e[t+7]]+"-"+E[e[t+8]]+E[e[t+9]]+"-"+E[e[t+10]]+E[e[t+11]]+E[e[t+12]]+E[e[t+13]]+E[e[t+14]]+E[e[t+15]]}const It={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function oe(e,t,n){if(It.randomUUID&&!t&&!e)return It.randomUUID();e=e||{};const i=e.random||(e.rng||Z)();return i[6]=i[6]&15|64,i[8]=i[8]&63|128,Qn(i)}const Xn='.ul-loading-spinner-container{font-size:1.8rem;flex-grow:1;width:100%;height:100%;display:flex;align-items:center;justify-content:center}.ul-loading-spinner{display:inline-block;position:relative;width:6rem;height:6rem}.ul-loading-spinner div{box-sizing:border-box;display:block;position:absolute;width:80%;height:80%;margin:5px;border:5px solid #152e3e;border-radius:50%;animation:lds-ring 1.2s cubic-bezier(.5,0,.5,1) infinite;border-color:#152e3e transparent transparent transparent}.ul-loading-spinner .first{animation-delay:-.45s}.ul-loading-spinner .second{animation-delay:-.3s}.ul-loading-spinner .third{animation-delay:-.15s}@keyframes lds-ring{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.fade-in-transition{animation:fadeIn .4s ease-in}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}#sprig-feedback-button{border-left:0;border-radius:0 8px 8px 0;display:grid;padding:8px;text-align:center;transition:all ease-in-out 1s;z-index:inherit}#sprig-feedback-button:hover{cursor:pointer}.sprig-feedback-button-label{writing-mode:vertical-lr;text-orientation:sideways}.sprig-feedback-button-right{transform:rotate(180deg)}.sprig-feedback-button-bottom{align-self:flex-end;margin-bottom:20px}.sprig-feedback-button-light{background:#efefee;color:#000;border:1px solid #e2e3e1}.sprig-feedback-button-dark{background:#000;color:#fff;border:1px solid #000000}#sprig-feedback-container{display:flex;align-items:center;position:fixed;transition:right .2s linear,left .2s linear;z-index:2147483646}.sprig-feedback-container-left{flex-flow:row-reverse}.sprig-feedback-container-center{top:50%;transform:translateY(-50%)}.sprig-feedback-container-bottom{bottom:0%;margin-bottom:15px}.sprig-feedback-loading-container{align-items:center;background-color:#fff;border:2px solid var(--feedback-border);display:flex;max-height:90vh;max-width:90vw;min-width:0px}.sprig-feedback-loading-container-left{border-left:none;border-radius:0 8px 8px 0}.sprig-feedback-loading-container-right{border-right:none;border-radius:8px 0 0 8px}#sprig-feedback-error-container{margin:auto;text-align:center;width:360px}.sprig-feedback-error-text{font-weight:400;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol}#sprig-feedback-loading-container .ul-container{position:relative;max-height:inherit}#sprig-feedback-loading-animation{position:absolute}.sprig-feedback-loading-container-previews iframe{max-height:inherit!important}',Zn="360px",er=500;var q=(e=>(e.Closed="close.click",e.Complete="survey.completed",e.FeedbackClosed="feedback.closed",e.PageChange="page.change",e.API="api",e.Override="override",e))(q||{}),f=(e=>(e.ReplayCapture="replay.capture",e.FeedbackButtonLoaded="feedback.button.loaded",e.SDKReady="sdk.ready",e.SurveyAppeared="survey.appeared",e.SurveyClosed="survey.closed",e.SurveyDimensions="survey.dimensions",e.SurveyFadingOut="survey.fadingOut",e.SurveyHeight="survey.height",e.SurveyPresented="survey.presented",e.SurveyLifeCycle="survey.lifeCycle",e.SurveyWidth="survey.width",e.SurveyWillClose="survey.willClose",e.SurveyWillPresent="survey.will.present",e.CloseSurveyOnOverlayClick="close.survey.overlayClick",e.VisitorIDUpdated="visitor.id.updated",e.QuestionAnswered="question.answered",e))(f||{});const be={FEEDBACK_BUTTON_LOADED:"feedback.button.loaded",SDK_READY:"sdk.ready",SURVEY_APPEARED:"survey.appeared",SURVEY_CLOSED:"survey.closed",SURVEY_DIMENSIONS:"survey.dimensions",SURVEY_FADING_OUT:"survey.fadingOut",SURVEY_HEIGHT:"survey.height",SURVEY_WIDTH:"survey.width",SURVEY_PRESENTED:"survey.presented",SURVEY_LIFE_CYCLE:"survey.lifeCycle",SURVEY_WILL_CLOSE:"survey.willClose",SURVEY_WILL_PRESENT:"survey.will.present",QUESTION_ANSWERED:"question.answered",REPLAY_CAPTURE:"replay.capture",CLOSE_SURVEY_ON_OVERLAY_CLICK:"close.survey.overlayClick",VISITOR_ID_UPDATED:"visitor.id.updated",DATA:{DISMISS_REASONS:{API:"api",CLOSED:"close.click",COMPLETE:"survey.completed",PAGE_CHANGE:"page.change",OVERRIDE:"override"},SURVEY_ID:"survey.id"}},Ut=()=>{try{return window.parent.Intercom}catch{return null}},Et=[Object.freeze(Object.defineProperty({__proto__:null,disable:()=>{const e=Ut();e&&(e.ul_wasVisible=!!document.querySelector("iframe.intercom-launcher-frame"),e.ul_wasVisible&&e("update",{hide_default_launcher:!0}))},enable:()=>{const e=Ut();e&&(e.ul_wasVisible&&e("update",{hide_default_launcher:!1}),delete e.ul_wasVisible)}},Symbol.toStringTag,{value:"Module"}))];class tr{static disable(){Et.forEach(t=>t.disable())}static enable(){Et.forEach(t=>t.enable())}}var nr=class extends Error{constructor(e,t,n){super(`Possible EventEmitter memory leak detected. ${n} ${t.toString()} listeners added. Use emitter.setMaxListeners() to increase limit`),this.emitter=e,this.type=t,this.count=n,this.name="MaxListenersExceededWarning"}},kt=class{static listenerCount(e,t){return e.listenerCount(t)}constructor(){this.events=new Map,this.maxListeners=kt.defaultMaxListeners,this.hasWarnedAboutPotentialMemoryLeak=!1}_emitInternalEvent(e,t,n){this.emit(e,t,n)}_getListeners(e){return Array.prototype.concat.apply([],this.events.get(e))||[]}_removeListener(e,t){const n=e.indexOf(t);return n>-1&&e.splice(n,1),[]}_wrapOnceListener(e,t){const n=(...i)=>(this.removeListener(e,n),t.apply(this,i));return Object.defineProperty(n,"name",{value:t.name}),n}setMaxListeners(e){return this.maxListeners=e,this}getMaxListeners(){return this.maxListeners}eventNames(){return Array.from(this.events.keys())}emit(e,...t){const n=this._getListeners(e);return n.forEach(i=>{i.apply(this,t)}),n.length>0}addListener(e,t){this._emitInternalEvent("newListener",e,t);const n=this._getListeners(e).concat(t);if(this.events.set(e,n),this.maxListeners>0&&this.listenerCount(e)>this.maxListeners&&!this.hasWarnedAboutPotentialMemoryLeak){this.hasWarnedAboutPotentialMemoryLeak=!0;const i=new nr(this,e,this.listenerCount(e));console.warn(i)}return this}on(e,t){return this.addListener(e,t)}once(e,t){return this.addListener(e,this._wrapOnceListener(e,t))}prependListener(e,t){const n=this._getListeners(e);if(n.length>0){const i=[t].concat(n);this.events.set(e,i)}else this.events.set(e,n.concat(t));return this}prependOnceListener(e,t){return this.prependListener(e,this._wrapOnceListener(e,t))}removeListener(e,t){const n=this._getListeners(e);return n.length>0&&(this._removeListener(n,t),this.events.set(e,n),this._emitInternalEvent("removeListener",e,t)),this}off(e,t){return this.removeListener(e,t)}removeAllListeners(e){return e?this.events.delete(e):this.events.clear(),this}listeners(e){return Array.from(this._getListeners(e))}listenerCount(e){return this._getListeners(e).length}rawListeners(e){return this.listeners(e)}},_t=kt;_t.defaultMaxListeners=10;const m=new _t,Le=async e=>{await new Promise(t=>{setTimeout(t,e)})},rr=({"userleap-platform":e})=>e!=="web";class Rt{constructor(t){R(this,"storage");R(this,"tempStorage",{});R(this,"isStorageAvailable");this.storage=window[t],this.isStorageAvailable=this.checkIfStorageAvailable()}checkIfStorageAvailable(){try{const t="__storage_test__";return this.storage.setItem(t,t),this.storage.removeItem(t),!0}catch{return!1}}setItem(t,n){this.isStorageAvailable?this.storage.setItem(t,n):this.tempStorage[t]=n}getItem(t){return this.isStorageAvailable?this.storage.getItem(t):this.tempStorage[t]}removeItem(t){this.isStorageAvailable?this.storage.removeItem(t):delete this.tempStorage[t]}clear(){this.isStorageAvailable?this.storage.clear():this.tempStorage={}}}const k=new Rt("sessionStorage"),A=new Rt("localStorage");class ir{constructor(t){R(this,"payload");R(this,"promise");R(this,"reject",()=>{});R(this,"resolve",()=>{});this.payload=t,this.promise=new Promise((n,i)=>{this.reject=i,this.resolve=n})}resolveRequest(t){this.resolve(t)}}const I={replay:null},sr=e=>{I.replay=e},or=()=>{const e=[];return I.replay&&e.push("replay"),e.join(",")},ar={RATELIMIT_RESET_DEFAULT:10};let Dt=!1,xt="",Se=!1,At=!1,Ie=[];const dr=e=>e._config&&e._config.installationMethod?e._config.installationMethod:e._gtm?"web-gtm":e._segment?"web-segment":"web-snippet",Ct=e=>{var t;(t=e==null?void 0:e.blockedURI)!=null&&t.includes(window.UserLeap._API_URL)&&(At=!0,console.warn(`[Sprig] ${e.blockedURI} is blocked by Content-Security-Policy`))},We=(e="")=>{Dt=!0,xt=e};function ee(e={}){const t={"Content-Type":"application/json","userleap-platform":"web","x-ul-sdk-version":"2.31.0","x-ul-installation-method":dr(e),"sprig-modules":or()};if(e.envId&&(t["x-ul-environment-id"]=e.envId),e.token&&(t.Authorization="Bearer "+e.token),e.userId&&(t["x-ul-user-id"]=e.userId),e.visitorId&&(t["x-ul-visitor-id"]=e.visitorId),e.partnerAnonymousId&&(t["x-ul-anonymous-id"]=e.partnerAnonymousId),e.mobileHeadersJSON){const n=JSON.parse(e.mobileHeadersJSON);Object.assign(t,n)}return e.locale&&(t["accept-language"]=e.locale),window.previewMode&&(t["x-ul-preview-mode"]="1"),t}const Tt=async({shouldDropOnRateLimit:e,...t})=>{if(e)return{status:429};{const n=new ir(t);return Ie.push(n),n.promise}},G=async(e,t)=>{const{retries:n=0,shouldDropOnRateLimit:i=!1,shouldRetryRequest:r=!1,...s}=t,o={url:e,options:s,retries:n,shouldDropOnRateLimit:i};if(Se&&!r)return Tt(o);const a={ok:!1,reportError:!1};if(Dt)return console.info(`UserLeap - ${xt}`),a;try{const d=await fetch(e,s);if(d.status===429)if(!Se&&!i||r){Se=!0;const l=d.headers.has("ratelimit-reset")?Number(d.headers.get("ratelimit-reset")):ar.RATELIMIT_RESET_DEFAULT;return await Le(l*1e3),G(e,{...s,shouldDropOnRateLimit:i,shouldRetryRequest:!0})}else return Tt(o);if(Se=!1,Ie.length&&(Ie.map(c=>{const l=c.payload;G(l.url,{...l.options,retries:l.retries,shouldDropOnRateLimit:l.shouldDropOnRateLimit}).then(u=>{c.resolveRequest(u)})}),Ie=[]),d.ok){if(d.status===249)return We(),a;const c=await d.text();try{return c&&c!=="OK"&&(d.json=JSON.parse(c)),d}catch{return{ok:!1,reportError:!1,error:new Error(`failed parsing response json for ${e} - ${c}`)}}}return d}catch(d){const c=n+1;return c>5||At?{ok:!1,reportError:!1,error:d}:(await Le(Math.pow(2,n)*1e3),G(e,{...s,retries:c}))}},ae={Error:1,Warn:2,Info:3,Debug:4};let je=1e3,Ue=ae.Debug,de=[];const cr=e=>{const t=Object.entries(ae).find(n=>n[1]===e);return(t==null?void 0:t[0])??""},lr=e=>e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3}),ur=(e,t)=>`${lr(t)}:${e}`,pr=()=>{de=de.filter(e=>e.level<=Ue)},wr=()=>{de.length>je&&de.shift()},Ee=(e,t)=>{e>Ue||(de.push({level:e,line:ur(t,new Date)}),wr())},ue=e=>{Ee(ae.Debug,e)},p=e=>{Ee(ae.Info,e)},ze=e=>{Ee(ae.Warn,e)},Pt=e=>{Ee(ae.Error,e)},fr=()=>de.map(e=>e.line),mr=()=>new TextEncoder().encode(fr().join(`
`)),gr=async e=>{if(!e)return;const t=mr();return G(e,{body:t,method:"PUT"})},yr=(e,t)=>{e!==void 0&&(je=e),t!==void 0&&(Ue=t),ue(`Initializing logger with limit of ${je} lines and ${cr(Ue)} level`),pr()},Ot="ul-view-sdk-script",hr=["ios","android"],K="visitors",J="environments";async function $(e,t){var s,o,a;const{shouldDropOnRateLimit:n,...i}=t;i.headers=Object.assign(ee(window.UserLeap),i.headers);const r=await G(e,{...i,shouldDropOnRateLimit:n});if(r.ok){const d=(s=r.headers)==null?void 0:s.get("Authorization"),c=d?d.split(" "):void 0,l=c&&c.length===2?c[1]:void 0,u=(o=r.headers)==null?void 0:o.get("x-ul-visitor-id");l&&u&&(u!==window.UserLeap.visitorId||window.UserLeap.token!==l)&&(C("token",l),C("vid",u),m.emit(f.VisitorIDUpdated,{visitorId:u}),window.UserLeap.token=l,window.UserLeap.visitorId=u)}return(a=r.json)!=null&&a.logMessage&&console.warn(`[Sprig] ${r.json.logMessage}`),r}function C(e,t){const n=A.getItem("userleap.ids");let i={};if(n)try{i=JSON.parse(n)}catch(s){s instanceof Error&&(s.stack=n,window.UserLeap.reportError("Failed to parse local storage credentials",s)),console.warn("[Sprig] (ERR-427) Failed to lookup saved ids",s)}let r=i[window.UserLeap.envId];r?r[e]=t:r={[e]:t},i[window.UserLeap.envId]=r;try{A.setItem("userleap.ids",JSON.stringify(i))}catch(s){s instanceof Error&&console.warn(`[Sprig] (ERR-426) Unable to write to Local Storage:: ${s.message}`)}}function qe(){return window.previewMode?"0":window.UserLeap.visitorId??""}function M(e,t,n){const i=[window.UserLeap._API_URL,"sdk",e];return t&&t.forEach(r=>{i.push(r),r===J?i.push(window.UserLeap.envId):r===K&&i.push(qe())}),n&&i.push(n),i.join("/")}const pe=async(e,t)=>{var Kn,Jn,Yn;const{context:n,delay:i,forceBrandedLogo:r,endCard:s,isFeedback:o=!1,heatmap:a,locale:d,previewMode:c,productConfig:l,questions:u,responseGroupUid:y,surveyId:w,uuid:g,vid:h,sessionReplay:x,studyType:H}=e,U=ee(window.UserLeap),z=Ke(U),se=Ge(U);if(p(`Attempting to display survey: ${w}`),x)if(p("Survey has replay attached"),z)m.emit(f.ReplayCapture,{responseGroupUid:y,hasQuestions:!!(u!=null&&u.length),surveyId:w,uploadId:x.uploadId,replayType:x.replayDurationType??"before",seconds:x.replayDurationSeconds,generateVideoUploadUrlPayload:{mediaRecordingUid:oe(),mediaType:"screen",questionId:1,responseGroupUid:y,surveyId:w,updatedAt:new Date().toISOString(),visitorId:window.UserLeap.visitorId,isReplay:!0}});else{if(!I.replay)return window.UserLeap.reportError("displayQuestions",new Error("Replay module not registered")),{success:!1,message:"Replay module not registered",surveyState:"no survey"};I.replay.scheduleOrCaptureReplay({responseGroupId:y,surveyId:w,visitorId:h,replayParams:x,completeUploadHeaders:U,apiUrl:window.UserLeap._API_URL,triggerTimestamp:Date.now(),isStandalone:u.length===0})}if(a){if(!I.replay)return window.UserLeap.reportError("displayQuestions",new Error("Replay module not registered")),{success:!1,message:"Replay module not registered",surveyState:"no survey"};const{eventId:S,replayParams:St,responseGroupUid:As,surveyId:Cs}=a;await I.replay.initializeReplay({viewDocument:window.document,maxReplayDurationSeconds:300,replayNonce:window.UserLeap.replayNonce,maxInflightRequests:window.UserLeap.maxInflightReplayRequests,teardownAfter:!0}),I.replay.scheduleCapture({apiUrl:window.UserLeap._API_URL,completeUploadHeaders:U,eventId:S,isHeatmap:!0,replayParams:St,responseGroupId:As,surveyId:Cs,triggerTimestamp:Date.now(),visitorId:h})}if(h==null||!(u!=null&&u.length))return p(`Not displaying survey: vid: ${h} / questions: ${u}`),{success:!1,message:"[Sprig] no survey found",surveyState:"no survey"};if(window.UserLeap.container){p("Already displaying a survey");const S="[Sprig] (ERR-409) Found an existing Survey container, aborting rendering of this survey";return console.warn(S),{success:!1,message:S,surveyState:"no survey"}}if(h!==window.UserLeap.visitorId&&g!==window.UserLeap.visitorId&&!window.previewMode){const S="Attempted to display survey to a different visitor";return p(S),window.UserLeap.reportError("DisplaySurvey",new Error(S)),{success:!1,message:S,surveyState:"no survey"}}p(`Showing survey: ${w}`),(Kn=I.replay)==null||Kn.RecordSurveyShown({id:w,userAgent:window.navigator.userAgent}),tr.disable(),m.emit(f.SurveyWillPresent,{name:f.SurveyWillPresent,"survey.id":w});let W,P=document.createElement("div"),_,O,He;const jn=S=>{const{"view.version":St}=S;St!==U["x-ul-sdk-version"]&&Bt(),m.removeListener("verify.view.version",jn)};m.on("verify.view.version",jn),window.UserLeap.useMobileStyling=se,rr(U)?(W="ul-direct-embeded-frame",_=document.head,O=window,He=!1,z&&(Mt(o),P.id=W,window.UserLeap.container.appendChild(P),Nt(),m.emit(f.SurveyLifeCycle,{state:"presented"}),m.emit(f.SurveyPresented,{name:f.SurveyPresented,"survey.id":w}))):{frameId:W,contentWinDocHead:_,contentWindow:O,hasOverlay:He,iframe:P}=Ir({productConfig:l,useMobileStyling:se,surveyId:w,isFeedback:o}),window.UserLeap.frameId=W;const Rs=S=>{m.once(f.CloseSurveyOnOverlayClick,S)},le={apiURL:window.UserLeap._API_URL,cards:u,configureExitOnOverlayClick:Rs,context:n,endCard:s,envId:window.UserLeap.envId,eventEmitFn:m.emit.bind(m),fontFamily:window.UserLeap.fontFamily,fontFamilyURL:window.UserLeap.fontFamilyURL,forceBrandedLogo:r,frame:P,headers:U,locale:d,mobileSDKVersion:window.UserLeap.mobileSDKVersion,previewKey:A.getItem("sprig.previewKey"),previewMode:c,productConfig:{framePosition:l==null?void 0:l.framePosition,desktopDisplay:l==null?void 0:l.desktopDisplay,placement:l==null?void 0:l.placement},responseGroupUid:y,startingQuestionIdx:(Jn=window.UserLeap.config)==null?void 0:Jn.startingQuestionIdx,studyType:H,styleNonce:window.UserLeap.styleNonce,surveyId:w,tabTitle:document.title,trackPageViewUrl:t,ulEvents:be,upchunkLibraryURL:window.UserLeap.upchunkLibraryURL,useMobileStyling:se,userId:g,viewDocument:O==null?void 0:O.document,viewWindow:O,visitorAttributes:{externalUserId:window.UserLeap.userId,email:window.UserLeap.email},...window.UserLeap._config};(Yn=window.UserLeap._config)!=null&&Yn.startingQuestionIdx&&(window.UserLeap._config={...window.UserLeap._config,startingQuestionIdx:null});const Ds=(o?window.UserLeap.feedbackCustomStyles:window.UserLeap.customStyles)??l.customStyles;le.customStyles=Ds,O&&(O.__cfg=le);function xs(){const S=document.createElement("script");return window.UserLeap.nonce&&S.setAttribute("nonce",window.UserLeap.nonce),S.id=Ot,S}const bt=window.UserLeap.viewSDKURL?window.UserLeap.viewSDKURL:le.path,zn=document.getElementById(Ot);zn&&zn.remove();const Lt=xs(),qn=()=>{window.UserLeap.container&&Object.assign(window.UserLeap.container.style,{display:"flex"})};if(le.installationMethod==="web-npm"||le.installationMethod==="web-npm-bundled"){const{default:S}=await import("../view/view.tsx");S.configure(le),He&&window.UserLeap.container&&qn()}else bt&&(Lt.src=bt,He&&Lt.addEventListener("load",()=>{window.UserLeap.container&&qn()}),O==null||O.addEventListener("error",S=>{S.target instanceof HTMLScriptElement&&S.target.src===bt&&window.UserLeap.reportError("loadFrameScript",new Error("Frame script failed to load"))},{capture:!0,once:!0}));_==null||_.appendChild(Lt);const Gn={success:!0,surveyState:"ready",surveyId:w,responseGroupUid:y};return window.UserLeap.isMobileSDK&&i&&(Gn.delay=i),Gn};function Ge(e){var n;if(window.UserLeap.useMobileStyling!==void 0)return window.UserLeap.useMobileStyling;const t=((n=window.UserLeap.windowDimensions)==null?void 0:n.width)??document.body.clientWidth;return Ke(e)||t>10&&t<er}function Ke(e){return hr.includes(e["userleap-platform"])}const Je="ul-frame";window.UserLeap&&window.Sprig&&(window.Sprig._gtm?window.Sprig=window.UserLeap:window.UserLeap=window.Sprig),window.UserLeap||(window.UserLeap=window.Sprig),window.Sprig||(window.Sprig=window.UserLeap);const vr="rgba(255,255,255, 0.95)",br="rgba(0,0,0,0.9)",Ye="0px",Mt=(e,t)=>{window.UserLeap.container=document.createElement("div"),window.UserLeap.container.className=`ul-container ${e&&"ul-container-feedback"}`;const n=Wt();t&&n&&!window.UserLeap.useMobileStyling?n.appendChild(window.UserLeap.container):document.body.appendChild(window.UserLeap.container)},Bt=(e,t)=>{var i;Er();const n=window.UserLeap.container;if(n)try{(i=n.parentNode)==null||i.removeChild(n),window.UserLeap.container=null,C("trackStartUrl",null),m.emit(f.SurveyLifeCycle,{state:"dismissed"}),m.emit(f.SurveyClosed,{name:f.SurveyClosed,initiator:e,studyType:t})}catch(r){console.warn(`[Sprig] (ERR-412) Error removing UserLeap container by ${e} `+n),r instanceof Error&&window.UserLeap.reportError("dismissActiveSurvey",r)}},Nt=()=>{m.once(f.SurveyWillClose,({initiator:e,studyType:t})=>{m.removeAllListeners(f.CloseSurveyOnOverlayClick),Bt(e,t)})},Lr=(e,t)=>{const i={...{position:"fixed",overflow:"auto",top:"0px",left:"0px",display:"none",height:"100%",width:"100%",transition:"background-color 0.3s ease-out",zIndex:2147483646}},r=t?e.overlayStyleMobile:e.overlayStyle;i["background-color"]=r==="light"?vr:br,t||(i.margin="auto"),window.UserLeap.container&&Object.assign(window.UserLeap.container.style,i)},Sr=(e,t,n,i)=>{var l,u;const r={position:"fixed",bottom:"0px",right:Ye,border:0,backgroundColor:"rgba(0,0,0,0)",zIndex:2147483646,transition:"width 0.2s ease-in-out, height 0.2s ease-in-out",maxWidth:"100%"},s=Object.assign({},t,window.UserLeap),{desktopDisplay:o}=t||{},a=o==="center-modal";a&&(s.framePosition="center");let d,c=!1;if(n)(l=window.UserLeap.windowDimensions)!=null&&l.width?r.width=`${window.UserLeap.windowDimensions.width}px`:r.width="100%",(u=window.UserLeap.windowDimensions)!=null&&u.height?r.maxHeight=`${window.UserLeap.windowDimensions.height-20}px`:window.UserLeap.maxHeight?r.maxHeight=window.UserLeap.maxHeight:r.maxHeight=`${document.body.clientHeight-20}px`,["light","dark"].includes(s.overlayStyleMobile)&&(c=!0);else{r.width=Zn,r.maxHeight=window.UserLeap.maxHeight||"66vh";const y=()=>{c=!0,d={margin:"auto",position:"static"}};if(i)a?y():d={position:"relative",height:"300px"};else switch(s.framePosition){case"bottomLeft":d={left:Ye};break;case"topLeft":d={left:Ye,top:0};break;case"topRight":d={top:0};break;case"center":y();break}}return c&&Lr(s,n),Object.assign(e.style,r,d),c},Ir=({productConfig:e,useMobileStyling:t,surveyId:n,isFeedback:i})=>{var y,w;const r=Je,s=i&&e.desktopDisplay==="slider";Mt(i,s),Ur();const o=document.createElement("iframe");o.id=r,o.setAttribute("title","Sprig User Feedback Dialog");const a=Sr(o,e,t,i);Nt();let d=!1;o.setHeight=g=>{(parseInt(o.style.height)!=g||!d)&&(d=!0,o.style.height=`${g}px`,m.emit(f.SurveyHeight,{name:f.SurveyHeight,contentFrameHeight:g}))};let c=!1;o.setWidth=g=>{(parseInt(o.style.width)!=g||!c)&&(c=!0,o.style.width=`${g}px`,m.emit(f.SurveyWidth,{name:f.SurveyWidth,contentFrameWidth:g}))},(y=window.UserLeap.container)==null||y.appendChild(o),e&&(t?e.exitOnOverlayClickMobile:e.exitOnOverlayClick)&&window.UserLeap.container&&(window.UserLeap.container.onclick=()=>{m.emit(f.CloseSurveyOnOverlayClick)}),m.emit(f.SurveyLifeCycle,{state:"presented"}),m.emit(f.SurveyPresented,{name:f.SurveyPresented,"survey.id":n});const l=(w=o.contentWindow)==null?void 0:w.document;if(l&&(l.open("text/html","replace"),l.write("<!doctype html><head></head><body></body></html>"),l.close(),!t)){const g=l.body;g.style.display="flex",g.style.alignItems="center"}const u=l==null?void 0:l.head;return{frameId:r,contentWinDocHead:u,contentWindow:o.contentWindow,hasOverlay:a,iframe:o}},$t={[f.SurveyFadingOut]:()=>{window.UserLeap.container&&Object.assign(window.UserLeap.container.style,{"background-color":"rgba(0,0,0,0)"})}},Ur=()=>{Object.entries($t).forEach(([e,t])=>{m.on(e,t)})},Er=()=>{Object.entries($t).forEach(([e,t])=>{m.off(e,t)})},Ft=Object.freeze({contains:(e,t)=>t.includes(e),notContains:(e,t)=>!t.includes(e),exactly:(e,t)=>t===e,notExactly:(e,t)=>t!==e,startsWith:(e,t)=>t.startsWith(e),endsWith:(e,t)=>t.endsWith(e),regex:(e,t)=>new RegExp(e).test(t),legacy:(e,t)=>new RegExp(e,"i").test(t)});function ke(e,t){const{matchType:n,pattern:i}=e,r=n?Ft[n]:Ft.legacy;let s=!1;try{s=r(i,t)}catch(o){const a=`[Sprig] (ERR-445) Failed to check url match with pattern ${i}`;o instanceof Error&&(console.warn(a,o),o.stack=JSON.stringify(e),window.UserLeap.reportError(a,o))}return s}const Vt=e=>{const{pageUrlEvents:t}=window.UserLeap._config,n=t==null?void 0:t.find(i=>i.id===e);return n?ke(n,window.location.href):!1},kr=1,Ht=e=>e instanceof HTMLElement||e instanceof SVGElement,_e=({document:e,elementId:t,styleString:n,nonce:i})=>{const r=e.getElementById(t);if(r){r.textContent=n;return}const s=e.createElement("style");i&&(s.nonce=i),s.textContent=n,s.id=t,e.head.appendChild(s)},_r=e=>{const t=e.querySelector(".ul-card__container");let n=600,i=360;if(t){n=t.scrollHeight;const r=getComputedStyle(t),s=parseFloat(r.marginTop)+parseFloat(r.marginBottom),o=parseFloat(r.borderTopWidth)+parseFloat(r.borderBottomWidth),a=parseFloat(r.paddingTop)+parseFloat(r.paddingBottom);n+=s+o+a;const d=t.querySelector(".ul-card--matrix_grid");i=d?d.scrollWidth:t.scrollWidth;const c=parseFloat(r.paddingLeft)+parseFloat(r.paddingRight),l=parseFloat(r.marginLeft)+parseFloat(r.marginRight),u=parseFloat(r.borderLeftWidth)+parseFloat(r.borderRightWidth);i+=l+u+c}return[n+kr,i]},Wt=()=>v,ce=()=>document.getElementById("sprig-feedback-container"),Qe=()=>document.getElementById("sprig-feedback-loading-animation"),Rr=()=>{if(Qe())return;const e=document.createElement("div");return e.className="ul-loading-spinner-container",e.id="sprig-feedback-loading-animation",e.role="progressbar",e.setAttribute("aria-live","polite"),e.setAttribute("aria-busy","true"),e.setAttribute("aria-label","Processing..."),e.innerHTML=`
    <div class="ul-loading-spinner">
      <div class="first"></div>
      <div class="second"></div>
      <div class="third"></div>
      <div class="fourth"></div>
    </div>
  `,e},jt=()=>!!document.getElementById(Je);let zt=!1,v=null,F=null,Xe=!1,we=null,te=null;const Dr=["bottom-left","bottom-right","center-left","center-right"],xr=e=>{if(ce()||!Dr.includes(e))return;const[t,n]=e.split("-"),i=document.createElement("div");i.id="sprig-feedback-container",i.classList.add(`sprig-feedback-container-${n}`,`sprig-feedback-container-${t}`),document.body.appendChild(i)},Re=()=>{var t;const e=window.UserLeap.container;return((t=e==null?void 0:e.parentElement)==null?void 0:t.id)==="sprig-feedback-loading-container"},qt=()=>document.getElementById("sprig-feedback-error-container"),Gt=()=>{if(!v)return 0;const e=v==null?void 0:v.clientWidth,t=window.getComputedStyle(v),n=parseInt(t.borderRightWidth||"0"),i=parseInt(t.borderLeftWidth||"0");return e+n+i},De=e=>{const t=ce();t&&(te!=null&&te.endsWith("right")?t.style.right=`${e}px`:te!=null&&te.endsWith("left")&&(t.style.left=`${e}px`))},Ze=()=>{if(v&&(Re()||qt())){m.off(f.SurveyAppeared,fe),et();const e=Gt();return De(-e),!0}return!1},fe=()=>{if(!v||!F)return;const e=Qe();e&&e.remove(),v.style.height="auto",v.style.width="auto",F.disabled=!1,Xe=!1},et=()=>{if(!v)return;if(!Qe()){const t=Rr();t&&(v.style.height="300px",v.style.width="360px",v.appendChild(t))}},Kt=()=>{!v||!F||(De(0),F.disabled=!0,Xe=!0)},Ar=async e=>{const t=await $(M("1",[K],"startFeedbackStudy"),{body:JSON.stringify({surveyUuid:e}),method:"POST"});return t.ok?t.json:null},Jt=async(e,t,n)=>{const{buttonTheme:i,customStyles:r,eventId:s,placement:o,desktopDisplay:a,feedbackLabel:d,surveyUuid:c,surveyId:l}=e;window.UserLeap.feedbackCustomStyles=void 0;let u=ce();if(u){if(!t&&s===we)return;u.remove(),m.off(be.SURVEY_FADING_OUT,Ze)}we=s,_e({document,elementId:"sprig-feedback-style",styleString:Xn,nonce:window.UserLeap.styleNonce}),_e({document,elementId:"ul-custom-style",styleString:r??"",nonce:window.UserLeap.styleNonce}),zt=a==="center-modal",te=o;const[w,g]=o.split("-");xr(o),u=ce(),F=document.createElement("button");const h=document.createElement("div");h.className="sprig-feedback-button-label",h.innerText=d,F.appendChild(h),F.id="sprig-feedback-button",F.classList.add(`sprig-feedback-button-${g}`,`sprig-feedback-button-${w}`,`sprig-feedback-button-${i}`,"fade-in-transition"),m.on(be.SURVEY_FADING_OUT,Ze),F.addEventListener("click",async()=>{const U=document.getElementById("sprig-feedback-error-container");if(jt()||qt()){if(Ze()){m.emit(f.SurveyWillClose,{name:f.SurveyWillClose,initiator:q.FeedbackClosed,studyType:"feedbackButton"});const P=ce();U&&P&&(P.remove(),we=null,v=null)}return}const z=ee(window.UserLeap);if(!Ge(z)&&!Xe&&Kt(),t){v&&v.classList.add("sprig-feedback-loading-container-previews"),await pe(t),fe();return}const W=await Ar(c);if(W)m.once(f.SurveyAppeared,fe),pe({...W,studyType:"feedbackButton"},n);else if(v){const P=Tr();v.appendChild(P),fe(),v.style.height="300px",v.style.width="360px"}}),u==null||u.appendChild(F),m.emit(f.FeedbackButtonLoaded,{name:f.FeedbackButtonLoaded,"survey.id":l});const{useMobileStyling:x,_config:{border:H}}=window.UserLeap;if(!zt&&!x){const U=document.createElement("div");U.id="sprig-feedback-loading-container",U.className=`sprig-feedback-loading-container sprig-feedback-loading-container-${g}`,U.style.setProperty("--feedback-border",H),v=U,et(),u==null||u.appendChild(U);const z=Gt();De(-z)}else De(0);window.UserLeap._config.isOnQuestionsTab&&t&&!Re()&&v&&(Kt(),et(),v&&v.classList.add("sprig-feedback-loading-container-previews"),pe(t),fe())},Cr=()=>{if(Re())return;const e=ce();if(!e)return;Vt(we)||(e.remove(),we=null,v=null)},Tr=()=>{const e=document.createElement("div");e.id="sprig-feedback-error-container",e.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40" fill="none">
  <circle cx="20" cy="20" r="14.5" stroke="#B0B5B7" stroke-width="3"/>
  <path d="M20 12L20 21.6" stroke="#B0B5B7" stroke-width="3" stroke-linecap="round"/>
  <circle cx="19.9984" cy="27.6" r="1.6" fill="#B0B5B7"/>
  </svg>`;const t=document.createElement("h3");return t.className="sprig-feedback-error-text",t.innerText="There was an error while loading the survey",e.appendChild(t),e},Pr="!launch_darkly_";class Or{constructor(){R(this,"_ldData",{})}getAllLaunchDarklyVariations(){return this._ldData}setLDFlagsVariations(t){try{return!t||typeof t!="object"||Array.isArray(t)?!1:(Object.keys(this._ldData).forEach(n=>{delete this._ldData[n]}),Object.keys(t).forEach(n=>this._ldData[`${Pr}${n}`]=(t[n]??0)+1),!0)}catch(n){return n instanceof Error&&window.UserLeap.reportError("setAllLDFlagsVariations",n),console.warn("[Sprig] An issue had occured when setting LaunchDarkly flags and variations."),!1}}}const tt=new Or;Object.freeze(tt);const Mr="!optimizely_experiments_";class Br{constructor(){R(this,"_optimizelyData",{})}setOptimizelyExperiment(t,n=!0){if(!t||typeof t!="object")return!1;const{experiments:i}=t;try{return n&&Object.keys(this._optimizelyData).map(r=>{delete this._optimizelyData[r]}),i&&i.map(r=>{const{id:s,variation:o}=r,a=this.transformExperimentId(s);o&&typeof o=="string"&&(this._optimizelyData[a]=o)}),!0}catch(r){return r instanceof Error&&window.UserLeap.reportError("setOptimizelyExperiment",r),!1}}getAllOptimizelyExperiments(){return this._optimizelyData}getOptimizelyVariationName(t){return this._optimizelyData[this.transformExperimentId(t)]}transformExperimentId(t){return Mr+t}getAndSetWebOptimizelyExperiments(){var t;try{if(window&&window.optimizely&&typeof window.optimizely.get=="function"){const n=(t=window.optimizely.get("state"))==null?void 0:t.getExperimentStates({isActive:!0});if(n){const i=Object.keys(n).map(r=>{var s,o;return(s=n[r].variation)!=null&&s.name?{id:r,variation:(o=n[r].variation)==null?void 0:o.name}:{id:r,variation:"Original"}});return this.setOptimizelyExperiment({experiments:i},!1),!0}return!1}return!1}catch(n){return n instanceof Error&&window.UserLeap.reportError("getAndSetWebOptimizely",n),!1}}}const xe=new Br;Object.freeze(xe);class Nr{constructor(t,n){R(this,"paused");R(this,"queue");R(this,"ul");this.ul=t,this.paused=!1,this.queue=[],this.flush(n)}flush(t){const n=t.length;if(n)for(let i=0;i<n;i++)this.push(t[i])}isPaused(){return this.paused}pause(){this.paused=!0}unpause(){this.paused=!1;const t=this.queue.slice();this.empty(),this.flush(t)}push(t){if(this.paused)this.queue.push(t);else if(t instanceof Function)t();else{const n=Array.prototype.slice.call(t,1),i=t[0],r=this.ul[i];r instanceof Function?r.apply(this.ul,n):i&&console.warn("[Sprig] (ERR-100) No valid UserLeap action called",i)}}perform(t){if(this.paused){let n=()=>{};const i=new Promise(function(r){n=function(){r(t())}});return this.queue.push(n),i}else return t()}empty(){this.queue.length=0}}let Yt=!0,nt=!1;const $r=()=>Yt=!1,Fr=()=>nt=!0,Vr=["sdk_event_queue_latency_seconds","sdk_replay_add_event_batch_seconds","sdk_replay_cleanup_seconds","sdk_replay_compression_seconds","sdk_replay_get_events_between_seconds","sdk_replay_snapshot_seconds","sdk_mutations_nodes_added","sdk_mutations_nodes_removed","sdk_mutations_attributes_changed","sdk_mutations_character_data","sdk_dom_nodes_count","sdk_page_html_characters"];let me={},rt;class Hr{constructor(t){R(this,"_values",[]);R(this,"_isWebMetric");this.name=t,this._isWebMetric=Vr.includes(this.name)}report(t){if(Yt&&this._values.push({time:Date.now(),value:t}),nt||!this._isWebMetric)return;const n=this.findExceededThreshold(t);n&&rt&&rt(t,n)}collect(){const t=this._values;return this._values=[],t}findExceededThreshold(t){const n=me[this.name];if(n)return n.find(i=>this.valueExceedsThreshold(t,i))}valueExceedsThreshold(t,n){return n.type==="max"?t>n.value:n.type==="min"?t<n.value:!1}}const Wr=(e,t)=>{me={},nt=!1,e==null||e.forEach(n=>{var i;n.metric in me||(me[n.metric]=[]),(i=me[n.metric])==null||i.push(n)}),rt=t},ge={},V=e=>{const t=new Hr(e);return ge[e]=t,t},Qt=(e,t)=>{let n=ge[e];return n||(n=V(e)),n.report(t)},jr=async e=>{const t=Object.values(ge).map(n=>({name:n.name,values:n.collect()}));if(t.some(n=>n.values.length))try{await e(JSON.stringify(t))}catch(n){ze(`Error posting metrics: ${n}`)}},zr=({reportingIntervalSeconds:e,postMetrics:t})=>{e?setInterval(()=>{jr(t)},e*1e3):$r()};let Xt,Zt;const it=e=>{let t=0,n=e.firstElementChild;for(;n;)t+=it(n),n.shadowRoot&&(t+=it(n.shadowRoot)),n=n.nextElementSibling,t++;return t},qr=()=>document.documentElement.innerHTML.length,en=()=>{Xt.report(it(document.body)),Zt.report(qr())},Gr=(e=10*1e3)=>{Xt=V("sdk_dom_nodes_count"),Zt=V("sdk_page_html_characters"),en(),setInterval(en,e)},st=(e,t)=>{const n=performance.now();document.hidden?setTimeout(()=>st(e,t),e):setTimeout(()=>{const i=performance.now()-n;t.report(i/1e3),setTimeout(()=>st(e,t),e)},0)},Kr=(e=1e3)=>{const t=V("sdk_event_queue_latency_seconds");st(e,t)};let Ae,Ce,Te,Pe,ne={},tn;const Oe=(e,t=1)=>{const{name:n}=e;ne[n]=(ne[n]||0)+t},nn=e=>{let t=1;return e.childNodes.forEach(n=>{t+=nn(n)}),t},rn=e=>{let t=0;return e.forEach(n=>{t+=nn(n)}),t},Jr=e=>{switch(e.type){case"childList":Oe(Ae,rn(e.addedNodes)),Oe(Ce,rn(e.removedNodes));return;case"attributes":Oe(Te);return;case"characterData":Oe(Pe);return}},Yr=e=>e.forEach(Jr),Qr=()=>{tn=new MutationObserver(Yr),tn.observe(document,{attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0})},Xr=()=>{Ae.report(ne[Ae.name]||0),Ce.report(ne[Ce.name]||0),Te.report(ne[Te.name]||0),Pe.report(ne[Pe.name]||0),ne={}},Zr=(e=1*1e3)=>{Ae=V("sdk_mutations_nodes_added"),Ce=V("sdk_mutations_nodes_removed"),Te=V("sdk_mutations_attributes_changed"),Pe=V("sdk_mutations_character_data"),Qr(),setInterval(Xr,e)},ei=({webMetricsEnabled:e,reportingIntervalSeconds:t,thresholds:n,postMetrics:i})=>{Wr(n,(r,s)=>{var o,a;if((o=I.replay)!=null&&o.isReplayRecording()){const d=`Value: ${r} on ${s.metric} violated threshold of ${s.type} ${s.value}`;(a=I.replay)==null||a.disableRecording("Threshold violated",new Error(d),{reportError:!1}),window.UserLeap.reportError("Sdk Performance Metric threshold violated",new Error("Sdk Performance Metric threshold violated"),{metricName:s.metric,type:s.type,value:s.value},{metricName:s.metric}),Fr()}}),zr({reportingIntervalSeconds:t,postMetrics:i}),e&&(Kr(),Gr(),Zr())},ti={test:"test"},ni=["popState","pushState","replaceState"],ye="!email",ot="pageUrl";function ri(e,t){const{pageUrlEvents:n,interactiveEvents:i,dismissOnPageChange:r}=window.UserLeap._config;if(!r)return!0;const s=[];n&&n.length&&s.push(...n),i&&i.length&&s.push(...i);const o=e&&s.find(a=>a.id===e);return o?ke(o,window.location.href):t===window.location.href}function he(e){var a;const{pageUrlEvents:t,interactiveEvents:n,dismissOnPageChange:i,platform:r}=window.UserLeap._config;if(r&&r!=="web")return;const s=re("trackStartUrl"),o=s?String(s):null;t&&dn(window.location.href),n&&(on(),ii()),Wt()&&Cr(),k.getItem("sprig.isCapturingHeatmap")&&((a=I.replay)==null||a.checkPendingHeatmapsUrl()),!Re()&&i&&o&&o!==window.location.href&&e&&ni.includes(e.type)&&window.UserLeap("dismissActiveSurvey",q.PageChange)}const sn={capture:!0},ii=()=>{const t=window.UserLeap._config.interactiveEvents.filter(i=>ke(i,window.location.href)).map(i=>{const{name:r,properties:s}=i,{selector:o,innerText:a}=s;return o?d=>{if(Ht(d.target))try{d.target.closest(o)&&window.UserLeap("track",r)}catch{}return!1}:d=>(Ht(d.target)&&d.target.innerText===a&&window.UserLeap("track",r),!1)}),n=i=>t.forEach(r=>r(i));window.UserLeap._config.interactiveEventsHandler=n,window.addEventListener("click",n,sn)},on=()=>{window.UserLeap._config.interactiveEventsHandler&&window.removeEventListener("click",window.UserLeap._config.interactiveEventsHandler,sn),delete window.UserLeap._config.interactiveEventsHandler};function si(){["hashchange","popstate"].forEach(e=>window.addEventListener(e,he,!0))}function oi(){["hashchange","popstate"].forEach(e=>window.removeEventListener(e,he,!0)),window.UserLeap._config.interactiveEvents&&on()}function ai(e){const t=new URL(M("1",[J],"questions"));return Object.entries(e||{}).forEach(([n,i])=>{i&&t.searchParams.append(n,String(i))}),t.toString()}function re(e){const t=A.getItem("userleap.ids");if(t)try{const i=JSON.parse(t)[window.UserLeap.envId];return i&&i[e]||null}catch(n){n instanceof Error&&(n.stack=t,window.UserLeap.reportError("Failed to parse local storage credentials",n)),console.warn("[Sprig] (ERR-427) Failed to lookup saved ids",n)}return null}function an(){window.previewMode||(window.UserLeap.visitorId=oe(),p(`Generating new vid: ${window.UserLeap.visitorId}`),C("vid",window.UserLeap.visitorId),m.emit(f.VisitorIDUpdated,{visitorId:window.UserLeap.visitorId}))}function dn(e,t,n,i){var y,w,g;if(e.endsWith("mock_snippet.html"))return;p(`Tracking page view: ${e}`);const r=window.UserLeap._config.pageUrlEvents;let s=!1;if(r&&r.length)for(let h=0;h<r.length&&(s=ke(r[h],e),!s);h++);if(!s)return;window.UserLeap.debugMode&&console.info("[DEBUG] Sprig trackPageView",e);const o=10,a=1;let d=[];const c={viewedAt:Date.now(),location:e},l={url:e};i&&(l.trackPageView=!0);const u=A.getItem("userleap.pageviews");try{if(d=u?JSON.parse(u):[],Array.isArray(d)||(d=[]),d.length>0){const h=d[d.length-1],x=(Date.now()-h.viewedAt)/1e3;if(h.location!=e&&x>a){const H=(y=document==null?void 0:document.querySelector('meta[name="description"]'))==null?void 0:y.getAttribute("content");(w=I.replay)==null||w.RecordPageView({...H&&{description:H},url:e,referrer:document.referrer,pageTitle:document.title})}(h.location!=e&&x>a||x>o)&&(window.UserLeap._queue.push(["track",ot,t,l,n]),d.push(c))}else window.UserLeap._queue.push(["track",ot,t,l,n]),d.push(c),(g=I.replay)==null||g.RecordPageView({url:e});d.length>5&&d.splice(0,d.length-5),A.setItem("userleap.pageviews",JSON.stringify(d))}catch(h){h instanceof Error&&window.UserLeap.reportError("trackPageView",h,{pageViewsStorage:u}),console.warn("[Sprig] (ERR-425) Failed to update page views in local storage")}}function di(){const e="Backbone"in window&&window.Backbone&&window.Backbone.history?window.Backbone.history:window.history;"pushState"in e&&(e.pushState=(t=>function(...i){const r=t.apply(this,i),s=new Event("pushState");return window.dispatchEvent(s),he(s),r})(e.pushState)),"replaceState"in e&&(e.replaceState=(t=>function(...i){const r=t.apply(this,i),s=new Event("replaceState");return window.dispatchEvent(s),he(s),r})(e.replaceState)),si()}async function at(e,t){const n=qe();e&&!t&&(window.UserLeap._config.mode=ti.test);const i=ee(window.UserLeap),r=Ge(i),s=await $(ai({desktopDisplay:window.UserLeap._config.desktopDisplay,isMobile:r,previewLanguage:window.UserLeap._config.previewLanguage,surveyid:e==null?void 0:e.surveyId,surveytemplateid:e==null?void 0:e.surveyTemplateId,vid:n}),{shouldDropOnRateLimit:!0});if(!s.ok)return s.reportError&&s.error&&(console.warn("[Sprig] (ERR-414) Failed to request questions from the server",s.error),window.UserLeap.reportError("getQuestions",s.error)),{success:!1,surveyState:"no survey"};if(s.json.delay&&await Le(s.json.delay),s.json.isFeedback){const{feedbackLabel:o,productConfig:a,surveyUuid:d,feedbackCustomStyles:c}=s.json,{buttonTheme:l,placement:u,desktopDisplay:y}=a,w={customStyles:c,buttonTheme:l,desktopDisplay:y,eventId:0,feedbackLabel:o,placement:u,surveyUuid:d,surveyId:e==null?void 0:e.surveyId};Jt(w,s.json)}else return pe(s.json)}function ci(e){let t=e.length;for(;t;){const n=Math.floor(Math.random()*t);t-=1;const i=e[t];e[t]=e[n],e[n]=i}}function li(e){if(!e)return;window.UserLeap._config=e,e.mute&&window.UserLeap._queue.pause();const{interactiveEvents:t,pageUrlEvents:n,dismissOnPageChange:i}=e;t&&ci(t),(t||n||i)&&(di(),he())}async function ui(e,t){var i,r;let n=!0;return t&&((i=e==null?void 0:e.json)!=null&&i.surveyId)&&(window.UserLeap.delayingSurvey=!0,n=await t(e.json.surveyId),window.UserLeap.delayingSurvey=!1,!n)?!1:((r=e==null?void 0:e.json)!=null&&r.delay&&!window.UserLeap.isMobileSDK&&(window.UserLeap.delayingSurvey=!0,await Le(e.json.delay),window.UserLeap.delayingSurvey=!1),n)}const pi=function(e){if(!window.UserLeap)return;const t=async(r={})=>{var U,z,se,W,P;const{userId:s,anonymousId:o,metadata:a={},properties:d,showSurveyCallback:c}=r;let{eventName:l}=r;if(window.UserLeap.debugMode&&l!==ot&&console.info("[DEBUG] Sprig track",r),e.mode==="test")return;const u=A.getItem("sprig.previewKey")??void 0;if(e.requireUserIdForTracking&&!window.UserLeap.userId&&!s){const _="[Sprig] - Skipping tracking without userId";return console.warn(_),{success:!1,message:_,surveyState:"no survey"}}if(!l||l.trim().length===0){l=l?String(l):"";const _="[Sprig] - Invalid event name "+l;return console.warn(_),{success:!1,message:_,surveyState:"no survey"}}const y=window.location.href;if(a.url||(a.url=y),C("trackStartUrl",y),(z=(U=window.UserLeap)==null?void 0:U._config)!=null&&z.optimizelyEnabled){const _=ee(window.UserLeap);Ke(_)||xe.getAndSetWebOptimizelyExperiments(),a.optimizelyExperiments=Object.assign({},xe.getAllOptimizelyExperiments())}(W=(se=window.UserLeap)==null?void 0:se._config)!=null&&W.launchDarklyEnabled&&(a.launchDarklyFlags=tt.getAllLaunchDarklyVariations()),s&&(window.UserLeap.userId=s),o&&(window.UserLeap.partnerAnonymousId=o),d&&(a.eventProperties=d),(P=I.replay)==null||P.RecordEvent({name:l,url:a.url}),p(`Tracking event: ${l}`);const w=window.UserLeap.delayingSurvey||jt()?await $(M("1",[K],"events/batch"),{body:JSON.stringify({events:[{event:l,metadata:a}],previewKey:u}),method:"POST",shouldDropOnRateLimit:!0}):await $(M("1",[K],"events"),{body:JSON.stringify({event:l,metadata:a,previewKey:u}),method:"POST",shouldDropOnRateLimit:!0});if(!w.ok){const _="[Sprig] (ERR-421) Failed to track event";return w.reportError&&(console.warn(_,w.error),w.error&&window.UserLeap.reportError("track",w.error)),{success:!1,message:_,error:w.error,surveyState:"no survey"}}s&&C("uid",s),o&&C("aid",o);const g=w.json;g.invalidPreviewKey&&A.removeItem("sprig.previewKey");const h=a.trackPageView?a.url:void 0;return!!(g!=null&&g.feedbackButton)&&Jt(g.feedbackButton,void 0,h),await ui(w,c)?ri(g.eventId,y)?pe(g,h):{success:!1,message:"Study should not be displayed after page navigation",surveyState:"no survey"}:{success:!1,message:"[Sprig] Callback returned false, aborting rendering of survey",surveyState:"no survey"}},n=(r,s)=>{var a;const o=(a=r==null?void 0:r.querySelector(`[id="${Je}"]`))==null?void 0:a.contentDocument;o&&_e({document:o,elementId:"ul-custom-style",styleString:s})},i={async displaySurvey(r){return console.warn("[Sprig] displaySurvey should only be used to debug your studies; not intended for production usage."),window.UserLeap("dismissActiveSurvey",q.Override),at({surveyId:r},!0)},_previewSurvey(r){window.UserLeap("dismissActiveSurvey",q.Override),at({surveyTemplateId:r},!1)},_reviewSurvey(r){window.UserLeap("dismissActiveSurvey",q.Override),at({surveyId:r},!1)},previewSurvey(r){i._previewSurvey(r)},reviewSurvey(r){i._reviewSurvey(r)},mute(){window.UserLeap._queue.pause()},unmute(){window.UserLeap._queue.unpause()},setVisitorToken(){console.warn("[Sprig] setVisitorToken is deprecated.")},dismissActiveSurvey(r=q.API){m.emit(f.SurveyWillClose,{name:f.SurveyWillClose,initiator:r})},async setAttribute(r,s){if(!r||!s&&s!==0&&s!==!1){const o="[Sprig] - Disregarding empty attribute / value provided";return console.warn(o),{success:!1,message:o}}return this.setAttributes({[r]:s})},async setAttributes(r){if(r==null||Object.keys(r).length===0){const s="[Sprig] - Disregarding empty attributes provided";return console.warn(s),{success:!1,message:s}}return this.identifyAndSetAttributes({attributes:r})},async identifyAndSetAttributes(r){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig identifyAndSetAttributes",r),e.mode==="test")return;if(r===null||typeof r!="object"||!(r.userId||r.anonymousId||r.attributes)){const l="[Sprig] - Disregarding empty payload provided";return console.warn(l),{success:!1,message:l}}const{userId:s,anonymousId:o,attributes:a}=r;if(e.requireUserIdForTracking&&!window.UserLeap.userId&&!s){const l="[Sprig] - Skipping tracking without userId";return console.warn(l),{success:!1,message:l}}if(!a&&(!s||window.UserLeap.userId===s)&&(!o||window.UserLeap.partnerAnonymousId===o))return{success:!0};const d={};s&&(d.userId=window.UserLeap.userId=s),o&&(d.partnerAnonymousId=window.UserLeap.partnerAnonymousId=o);let c;return a?(a.email&&!Object.prototype.hasOwnProperty.call(a,ye)&&(a[ye]=a.email,delete a.email),p(`Setting attributes: ${JSON.stringify(a)}`),c=await $(M("1",[J,K],"attributes"),{body:JSON.stringify(a),method:"PUT"}),!c.ok&&c.reportError&&(console.warn("[Sprig] (ERR-432) identifyAndSetAttributes failed",c.error),c.error&&window.UserLeap.reportError("identifyAndSetAttributes",c.error))):c=await $(M("1",[J,K]),{body:JSON.stringify(d),method:"PUT"}),a&&a[ye]&&(window.UserLeap.email=a[ye]),c.ok&&(s&&C("uid",s),o&&C("aid",o)),{success:!!c.ok}},async removeAttributes(r){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig removeAttributes",r),e.mode==="test")return;if(r==null||r.length===0){const o="[Sprig] - Disregarding empty attributes provided";return console.warn(o),{success:!1,message:o}}if(e.requireUserIdForTracking&&!window.UserLeap.userId){const o="[Sprig] - Skipping tracking without userId";return console.warn(o),{success:!1,message:o}}const s=await $(M("1",[J,K],"attributes"),{body:JSON.stringify({delete:r}),method:"DELETE"});return!s.ok&&s.reportError&&(console.warn("[Sprig] (ERR-433) Remove attributes failed",s.error),s.error&&window.UserLeap.reportError("removeAttributes",s.error)),{success:!!s.ok}},async addSurveyListener(r){m.on(f.SurveyLifeCycle,r)},async removeSurveyListener(r){m.removeListener(f.SurveyLifeCycle,r)},async addListener(r,s){m.on(r,s)},async removeListener(r,s){m.removeListener(r,s)},async removeAllListeners(){m.removeAllListeners()},setPreviewKey(r){!r||typeof r!="string"||A.isStorageAvailable&&r&&A.setItem("sprig.previewKey",r)},async setUserId(r){var a;if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig setUserId",r),r==null){const d=`[Sprig] - Invalid userId ${r}`;return console.warn(d),{success:!1,message:d}}if(e.mode==="test"||r===window.UserLeap.userId)return;window.UserLeap.userId=r;const s=window.UserLeap.visitorId,o=await $(M("1",[J,K]),{body:JSON.stringify({userId:r}),method:"PUT"});if(!o.ok){o.reportError&&(console.warn("[Sprig] (ERR-420) Failed to set user id",o.error),o.error&&window.UserLeap.reportError("setUserId",o.error));return}s!==window.UserLeap.visitorId&&((a=I.replay)==null||a.clearUserReplayData()),C("uid",r)},async setPartnerAnonymousId(r){if(window.UserLeap.debugMode&&console.info("[DEBUG] Sprig setPartnerAnonymousId",r),r==null){const s=`[Sprig] - Invalid partnerAnonymousId ${r}`;return console.warn(s),{success:!1,message:s}}return window.UserLeap.partnerAnonymousId=r,C("aid",r),{success:!0}},async track(r,s,o={},a=void 0){return t({eventName:r,properties:s,metadata:o,showSurveyCallback:a})},async identifyAndTrack(r){return await t(r)},trackPageView(r,s=void 0,o=void 0,a=!0){dn(r,s,o,a)},applyFeedbackStyles({button:r="",view:s=""}){window.UserLeap.feedbackCustomStyles=s,document.getElementById("sprig-feedback-style")&&_e({document,elementId:"ul-custom-style",styleString:r,nonce:window.UserLeap.styleNonce}),n(document.querySelector(".ul-container-feedback"),s)},applyStyles(r){window.UserLeap.customStyles=r,n(window.UserLeap.container,r)},setWindowDimensions(r,s){var c,l;const o=typeof r=="string"?parseInt(r,10):r,a=typeof s=="string"?parseInt(s,10):s;if(!isNaN(o)&&!isNaN(a)&&(window.UserLeap.windowDimensions={width:o,height:a}),!window.UserLeap.frameId)return;const d=document.getElementById(window.UserLeap.frameId);d&&(window.UserLeap.useMobileStyling&&((c=window.UserLeap.windowDimensions)!=null&&c.width&&(d.style.width=`${window.UserLeap.windowDimensions.width}px`),(l=window.UserLeap.windowDimensions)!=null&&l.height&&(d.style.maxHeight=`${window.UserLeap.windowDimensions.height-20}px`),d.contentDocument&&(d.style.height=String(_r(d.contentDocument)[0])+"px")),m.emit(f.SurveyDimensions,{name:f.SurveyDimensions,contentFrameWidth:d.clientWidth,contentFrameHeight:d.clientHeight}))},logoutUser(){var r;window.UserLeap.debugMode&&console.info("[DEBUG] Sprig logout"),p(`Logging out user: ${window.UserLeap.userId} / vid: ${window.UserLeap.visitorId}`),window.UserLeap.visitorId=null,window.UserLeap.userId=null,window.UserLeap.partnerAnonymousId=null,window.UserLeap.token=null,window.UserLeap.email=null,A.removeItem("userleap.ids"),A.removeItem("userleap.pageviews"),window.UserLeap._queue.isPaused()&&window.UserLeap._queue.empty(),an(),(r=I.replay)==null||r.clearUserReplayData(),window.UserLeap._queue.unpause()},teardown(){oi(),window.UserLeap("dismissActiveSurvey",q.API),delete window.UserLeap,delete window.Sprig,delete window._Sprig},integrateOptimizely(r,s=!0){var o,a;if(!((a=(o=window.UserLeap)==null?void 0:o._config)!=null&&a.optimizelyEnabled)){console.warn("[SPRIG] Optimizely integration is currently not enabled for your product.");return}try{const d=typeof r=="string"?JSON.parse(r):r;xe.setOptimizelyExperiment(d,s)}catch(d){console.warn("[Sprig] Error with integrating Optimizely data"),d instanceof Error&&window.UserLeap.reportError("integrateOptimizely",d)}},integrateOptimizelyClient(r){var o,a;if(!((a=(o=window.UserLeap)==null?void 0:o._config)!=null&&a.optimizelyEnabled)){console.warn("[SPRIG] Optimizely integration is currently not enabled for your product.");return}const s=({experiment:d,variation:c})=>{const l={experiments:[{id:d.id,variation:c.key}]};window.UserLeap("integrateOptimizely",l,!1)};r.notificationCenter.addNotificationListener("ACTIVATE:experiment, user_id,attributes, variation, event",s)},importLaunchDarklyData(r){var s,o;if(!((o=(s=window.UserLeap)==null?void 0:s._config)!=null&&o.launchDarklyEnabled)){console.warn("[SPRIG] LaunchDarkly integration is currently not enabled for your product.");return}tt.setLDFlagsVariations(r)},setVisitorAttribute(r,s){return console.warn("[Sprig] setVisitorAttribute is deprecated. Please use setAttribute"),i.setAttribute(r,s)},async setEmail(r){return i.setAttribute(ye,r)},async setVisitorEmail(r){return console.warn("[Sprig] setVisitorEmail is deprecated. Please use setEmail"),i.setEmail(r)},async _generateVideoUploadUrl(r){return gi(r)},_reportMetric(r,s){Qt(r,s)},async _completeSessionReplay({surveyId:r,responseGroupUuid:s,eventDigest:o}){var a;return I.replay?(a=I.replay)==null?void 0:a._completeSessionReplay({surveyId:r,responseGroupUuid:s,eventDigest:o,headers:ee(window.UserLeap)}):(window.UserLeap.reportError("_completeSessionReplay",new Error("Replay module not registered")),!1)}};Object.assign(window.UserLeap,i)};async function wi(e){const t=ee(window.UserLeap);document.addEventListener("securitypolicyviolation",Ct);const n=await G(M("1",[J],"config"),{headers:t});if(document.removeEventListener("securitypolicyviolation",Ct),!n.ok)return n.reportError&&(console.warn("[Sprig] (ERR-422) Failed to load configuration",n.error),n.error&&window.UserLeap.reportError("applyRemoteConfig",n.error)),We("Disabled: failed to fetch configuration"),e;const i=n.json;return i!=null&&i.disabled?(We(`Disabled: ${i.disabled}`),{disabled:i.disabled}):Object.assign({},i,e)}const fi=e=>typeof e=="object"&&e&&"inner"in e&&!!e.inner&&typeof e.inner=="object";async function mi(e,t,n={},i={}){var y,w;const r=window.__cfg&&window.__cfg.mode,s=qe(),o=window.UserLeap.envId,a=window.document.documentElement,d=fi(t)?{inner:{message:(y=t.inner)==null?void 0:y.message,stack:(w=t.inner)==null?void 0:w.stack}}:{},c={mode:r,screenWidth:window.screen.width,screenHeight:window.screen.height,clientWidth:a.clientWidth,clientHeight:a.clientHeight,location:window.location.href,language:window.navigator.language,...n,...d},l={action:e,err:{message:t.message,stack:t.stack},meta:c,vid:s,envId:o,...i},u=await $(M("1",null,"errors"),{method:"POST",headers:{"x-ul-error":window.btoa(`userleap-${Date.now()}-error`)},body:JSON.stringify(l),shouldDropOnRateLimit:!0});if(!u.ok)console.warn("[Sprig] (ERR-444) Failed to report error to API",t);else{const{presignedUrl:g}=u.json;gr(g)}}async function gi(e){var n;if(!e)return;const t=`${window.UserLeap._API_URL}/2/environments/integrations/upload`;try{const i=await fetch(t,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(i.ok){const r=await i.json();return(n=r==null?void 0:r.upload)==null?void 0:n.url}else return null}catch(i){console.warn("[Sprig] Error with generating video upload url"),i instanceof Error&&window.UserLeap.reportError("generateVideoUploadUrl",i)}}function yi(e={}){const t=new URLSearchParams(window.location.search).get("sprigPreviewKey")??"";window.UserLeap.UPDATES=be,window.UserLeap("setPreviewKey",t);async function n(){var a;if(window.UserLeap.loaded)return;if(p("Loading sprig on page load"),window.UserLeap.reportError=mi,window.UserLeap.loaded=!0,window.UserLeap._config=Object.assign({},e,window.UserLeap.config),window.UserLeap.delayingSurvey=!1,window.UserLeap._config&&typeof window.UserLeap._config=="object")for(const d in window.UserLeap._config)window.UserLeap[d]=window.UserLeap._config[d];if(!window.UserLeap.envId)if(window.UserLeap.appId)window.UserLeap.envId=window.UserLeap.appId;else throw new Error("Missing Environment id");window.UserLeap.debugMode&&console.info("[DEBUG] Sprig debug mode enabled");const i=window.UserLeap.sampleRate;if(i){let d=re("sampled");if(d===null&&(d=Math.random()<i,C("sampled",d)),!d)return}else re("sampled")!==null&&C("sampled",null);window.UserLeap._API_URL||(window.UserLeap._API_URL="https://api.sprig.com");const r=[...window.UserLeap._queue];window.UserLeap._queue=new Nr(window.UserLeap,[]),window.UserLeap._queue.pause();for(let d=0;d<r.length;d++)window.UserLeap._queue.push(r[d]);const s=re("token");s?(window.UserLeap.token=s,window.UserLeap.visitorId=re("vid"),window.UserLeap.userId=re("uid"),window.UserLeap.partnerAnonymousId=re("aid")):(A.removeItem("userleap.ids"),an());const o=await wi(e);ei({webMetricsEnabled:o.metricsReportingEnabled,reportingIntervalSeconds:o.metricsReportingEnabled||o.mobileMetricsReportingEnabled?o.metricsReportingIntervalSeconds:0,thresholds:o.metricThresholds,postMetrics:async d=>{var c;await $(M("1",[J],"metrics"),{body:d,method:"POST",headers:{"x-ul-replay-enabled":`${!!((c=I.replay)!=null&&c.isReplayRecording())}`},shouldDropOnRateLimit:!0})}}),(a=I.replay)==null||a.initializeReplay({viewDocument:window.document,maxReplayDurationSeconds:o.maxReplayDurationSeconds,replayNonce:window.UserLeap.replayNonce,maxInflightRequests:window.UserLeap.maxInflightReplayRequests??2,replaySettings:o.replaySettings}),yr(o.logBufferLimit,o.logLevel),pi(o),await li(o),window.UserLeap._queue.unpause(),m.emit(f.SDKReady,{mobileMetricsReportingEnabled:!!o.mobileMetricsReportingEnabled,metricsReportingInterval:o.metricsReportingIntervalSeconds||0,metricsThresholds:o.metricThresholds||[],maxMobileReplayDurationSeconds:o.maxMobileReplayDurationSeconds,mobileReplaySettings:o.mobileReplaySettings}),m.emit(f.VisitorIDUpdated,{visitorId:window.UserLeap.visitorId})}document.readyState==="complete"?n():window.attachEvent?window.attachEvent("onload",n):window.addEventListener("load",()=>{n()},!1)}var Me=(e=>(e[e.DomContentLoaded=0]="DomContentLoaded",e[e.Load=1]="Load",e[e.FullSnapshot=2]="FullSnapshot",e[e.IncrementalSnapshot=3]="IncrementalSnapshot",e[e.Meta=4]="Meta",e[e.Custom=5]="Custom",e[e.Plugin=6]="Plugin",e))(Me||{});class hi{constructor(t){R(this,"awaitingResolvers",[]);R(this,"activeCount",0);this.capacity=t}async acquire(){if(this.activeCount<this.capacity){this.activeCount++;return}return new Promise(t=>{this.awaitingResolvers.push(t)})}release(){const t=this.awaitingResolvers.shift();t&&this.activeCount<=this.capacity?t():this.activeCount--}async execute(t){try{return await this.acquire(),await t()}finally{this.release()}}setLimit(t){this.capacity=t}}const cn=new hi(2),vi=e=>cn.setLimit(e),bi=async e=>cn.execute(async()=>{var i;p(`Beginning upload of chunk ${e.chunkIndex} for survey: ${e.surveyId}`);const t=await G(e.uploadUrl,{body:e.data,method:"PUT"});p(`Completed upload of chunk ${e.chunkIndex} for survey: ${e.surveyId}`);const n=(i=t.headers)==null?void 0:i.get("ETag");if(!n)throw new Error(`Upload response did not include etag for upload ${e.uploadId}, part ${e.chunkIndex}`);return n}),ln=async({apiUrl:e,surveyId:t,uploadId:n,etags:i,headers:r,responseGroupUuid:s,replayDuration:o,eventDigest:a},d=!1)=>{var l;if(!d&&!n&&!i){p(`Cannot mark upload complete: isMobile: ${d} / uploadId: ${n} / etags: ${i}`);return}p(`Marking upload complete for survey: ${t}`);const c=await G(`${e}/sdk/1/completeSessionReplay`,{method:"POST",body:JSON.stringify({etags:i,uploadId:n,responseGroupUuid:s,surveyId:t,replayDuration:o,eventDigest:a,userAgent:(l=window==null?void 0:window.navigator)==null?void 0:l.userAgent}),headers:r,shouldRetryRequest:!0});return p(`Done marking upload complete for survey: ${t}`),c},dt=(e,t)=>t.some(n=>e instanceof n);let un,pn;function Li(){return un||(un=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Si(){return pn||(pn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ct=new WeakMap,lt=new WeakMap,Be=new WeakMap;function Ii(e){const t=new Promise((n,i)=>{const r=()=>{n(Y(e.result))},s=()=>{i(e.error)};e.onsuccess=r,e.onerror=s});return Be.set(t,e),t}function Ui(e){if(ct.has(e))return;const t=new Promise((n,i)=>{const r=()=>{n()},s=()=>{i(e.error||new DOMException("AbortError","AbortError"))};e.oncomplete=r,e.onerror=s,e.onabort=s});ct.set(e,t)}let ut={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return ct.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Y(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function wn(e){ut=e(ut)}function Ei(e){return Si().includes(e)?function(...t){return e.apply(pt(this),t),Y(this.request)}:function(...t){return Y(e.apply(pt(this),t))}}function ki(e){return typeof e=="function"?Ei(e):(e instanceof IDBTransaction&&Ui(e),dt(e,Li())?new Proxy(e,ut):e)}function Y(e){if(e instanceof IDBRequest)return Ii(e);if(lt.has(e))return lt.get(e);const t=ki(e);return t!==e&&(lt.set(e,t),Be.set(t,e)),t}const pt=e=>Be.get(e);function _i(e,t,{blocked:n,upgrade:i,blocking:r,terminated:s}={}){const o=indexedDB.open(e,t),a=Y(o);return i&&(o.onupgradeneeded=d=>{i(Y(o.result),d.oldVersion,d.newVersion,Y(o.transaction),d)}),n&&(o.onblocked=d=>n(d.oldVersion,d.newVersion,d)),a.then(d=>{s&&(d.onclose=()=>s()),r&&(d.onversionchange=c=>r(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}function fn(e,{blocked:t}={}){const n=indexedDB.deleteDatabase(e);return t&&(n.onblocked=i=>t(i.oldVersion,i)),Y(n).then(()=>{})}const Ri=["get","getKey","getAll","getAllKeys","count"],Di=["put","add","delete","clear"],wt=new Map;function mn(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(wt.get(t))return wt.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,r=Di.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(r||Ri.includes(n)))return;const s=async function(o,...a){const d=this.transaction(o,r?"readwrite":"readonly");let c=d.store;return i&&(c=c.index(a.shift())),(await Promise.all([c[n](...a),r&&d.done]))[0]};return wt.set(t,s),s}wn(e=>({...e,get:(t,n,i)=>mn(t,n)||e.get(t,n,i),has:(t,n)=>!!mn(t,n)||e.has(t,n)}));const xi=["continue","continuePrimaryKey","advance"],gn={},ft=new WeakMap,yn=new WeakMap,Ai={get(e,t){if(!xi.includes(t))return e[t];let n=gn[t];return n||(n=gn[t]=function(...i){ft.set(this,yn.get(this)[t](...i))}),n}};async function*Ci(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,Ai);for(yn.set(n,t),Be.set(n,pt(t));t;)yield n,t=await(ft.get(n)||t.continue()),ft.delete(n)}function hn(e,t){return t===Symbol.asyncIterator&&dt(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&dt(e,[IDBIndex,IDBObjectStore])}wn(e=>({...e,get(t,n,i){return hn(t,n)?Ci:e.get(t,n,i)},has(t,n){return hn(t,n)||e.has(t,n)}}));const Ti=e=>{if(e instanceof Attr)return null;let t=1;for(let n=e.previousSibling;n;n=n.previousSibling)n.nodeName===e.nodeName&&++t;return t},vn=e=>{if(e===null)return"";const t=[];if(e instanceof Document)return"/";for(let n=e;n&&!(n instanceof Document)&&n!==null;n=n instanceof Attr?n.ownerElement:n.parentElement){const i=t[t.length]={name:void 0,position:null};switch(n.nodeType){case Node.TEXT_NODE:i.name="text()";break;case Node.ATTRIBUTE_NODE:i.name="@"+n.nodeName;break;case Node.PROCESSING_INSTRUCTION_NODE:i.name="processing-instruction()";break;case Node.COMMENT_NODE:i.name="comment()";break;case Node.ELEMENT_NODE:i.name=n.nodeName;break}i.position=Ti(n)}return"/"+t.reverse().map(n=>n.position!==null?`/${n.name}[${n.position}]`:`/${n.name}`).join("")},Q={capture:!0,passive:!0},Pi=["a","button","input","option","li","link"],Oi=["Escape","Enter","Backspace","F5","Tab"];let Ne=!1;const Mi=["label","type","role","title","placeholder","errormessage","valuetext","href"],bn="aria-",Bi=e=>{if(!e.tagName)return"No tagName";const t=e.getAttribute("type");return t?`${t} ${e.tagName.toLowerCase()}`:e.tagName.toLowerCase()},Ln=e=>{var i;if(((i=e.tagName)==null?void 0:i.toLowerCase())==="html")return{element:"html"};const t=e.textContent,n=t?{text:t}:{};n.element=Bi(e);for(const r of e.attributes){let s=r.name;const o=r.value;s.startsWith(bn)&&(s=s.substring(bn.length)),Mi.includes(s)&&(n[s]=o)}return n},Ni=e=>{var r;if(!e)return{};const n={...Ln(e)},i=e.parentElement;if(i&&Pi.includes((r=i.tagName)==null?void 0:r.toLowerCase())){const s=Ln(i);Object.assign(n,s)}return n},Sn=(e,t)=>{var n;Ji({x:t.x,y:t.y,type:e,elementAttributes:Ni(t.target),windowHeight:window.innerHeight,windowWidth:window.innerWidth,...t.target instanceof HTMLElement?{rect:(n=t.target)==null?void 0:n.getBoundingClientRect(),xPath:vn(t.target)}:{}})},$i=e=>t=>Sn(e,t),In=e=>{Oi.includes(e.key)&&ts({key:e.key})},Fi=()=>{window.performance.getEntriesByType("navigation").map(t=>t.type).includes("reload")&&Zi({url:window.location.href,currentPageTitle:document.title})},Vi=()=>{window.performance.getEntriesByType("navigation").map(t=>t.type).includes("back_forward")&&es({curUrl:window.location.href,fromUrl:document.referrer,currentPageTitle:document.title})},Un=((e,t)=>{let n;return i=>{clearTimeout(n),n=window.setTimeout(()=>e(i),t)}})(e=>{if(!(e.target instanceof HTMLElement||e.target instanceof Document))return;let t=e.target;"scrollTop"in t||(t=t.documentElement),ns({xPath:vn(t),x:t.scrollLeft,y:t.scrollTop,elementAttributes:{targetScrollWidth:t.scrollWidth,targetClientWidth:t.clientWidth,targetScrollHeight:t.scrollHeight,targetClientHeight:t.clientHeight}})},750),En=$i("left_click"),kn=e=>{e.button===2&&Sn("right_click",e)},Hi=()=>{Ne||(window.addEventListener("click",En,Q),window.addEventListener("mousedown",kn,Q),window.addEventListener("keydown",In,Q),window.addEventListener("scroll",Un,Q),Ne=!0,Fi(),Vi())},Wi=()=>{Ne&&(window.removeEventListener("click",En,Q),window.removeEventListener("mousedown",kn,Q),window.removeEventListener("keydown",In,Q),window.removeEventListener("scroll",Un,Q),Ne=!1)},ji=3e4;let ve=0;const L={isRecording:!1,scrollEventUuids:{},stopRecording:()=>{}},D=(()=>{const e=k.getItem("sprig.sessionId");if(e)return p(`Found saved session id: ${e}`),k.removeItem("sprig.sessionId"),e;const t=oe();return p(`Generating new uuid: ${t}`),t})(),zi=async e=>{var t;if((t=window.navigator.storage)!=null&&t.estimate){const{quota:n=0,usage:i=0}=await window.navigator.storage.estimate();return(n-i)/1024**3>=e}return!0},_n=()=>{k.setItem("sprig.disableReplayRecording","disabled")},ie=()=>!!k.getItem("sprig.disableReplayRecording");window.addEventListener("beforeunload",()=>{p(`Before page unload saving session id: ${D}`),k.setItem("sprig.sessionId",D)});const qi=async()=>{const t=(await b.getPendingCaptures({isHeatmap:!0})).map(i=>({eventId:i.captureParams.eventId,uuid:i.uuid})),n=[];t.forEach(({eventId:i,uuid:r})=>{Vt(i)||n.push(r)}),n.length&&T(()=>b.markPendingHeatmapsReady(n),"Error marking pending heatmaps ready")},Gi=e=>{if(e>1){ve=0;return}const t=Date.now();if(!ve){ve=t;return}t-ve>=ji&&(ve=0,T(()=>b.markPendingHeatmapsReady(),"Error marking pending heatmaps ready"))},mt=e=>e&&e.trim().substring(0,500).replace(/\s\s+/g," ").replace(/\r?\n|\r/g," ").substring(0,250),B=(e,t)=>{var n,i;if(L.isRecording)try{(i=(n=window.rrwebRecord)==null?void 0:n.addCustomEvent)==null||i.call(n,e,t)}catch(r){$e("Error recording custom event",r)}},Ki=e=>{e.description&&(e.description=mt(e.description)),B("Sprig_PageView",e)},Ji=e=>{var t;(t=e==null?void 0:e.elementAttributes)!=null&&t.text&&(e.elementAttributes.text=mt(e.elementAttributes.text)),B("Sprig_Click",e)},Yi=e=>{B("Sprig_TrackEvent",e)},Qi=e=>{B("Sprig_ShowSurvey",e)},Xi=e=>{B("Sprig_SubmitSurvey",e)},Zi=e=>{B("Sprig_Refresh",e)},es=e=>{e.currentPageTitle&&(e.currentPageTitle=mt(e.currentPageTitle)),B("Sprig_BackForward",e)},ts=e=>{B("Sprig_Keystroke",e)},ns=async e=>{const{x:t,xPath:n,y:i}=e,r=L.scrollEventUuids[n];if(r)return T(async()=>{var a,d,c,l;const s=await b.openDB(),o=await s.get("events",r);if(o!=null&&o.event){const u=JSON.parse(o.event),y=t>((d=(a=u.data)==null?void 0:a.payload)==null?void 0:d.x),w=i>((l=(c=u.data)==null?void 0:c.payload)==null?void 0:l.y);if(!(y||w))return null;y&&(u.data.payload.x=t),w&&(u.data.payload.y=i),u.data.payload.elementAttributes=e.elementAttributes,o.event=JSON.stringify(u),await s.put("events",o)}else B("Sprig_Scroll",e)},"Error updating scroll event");B("Sprig_Scroll",e)},rs=()=>L.isRecording,Rn=()=>{L.stopRecording&&(L.stopRecording(),L.stopRecording=void 0),L.isRecording=!1,["cleanupInterval","noopInterval","pendingCheckInterval"].forEach(e=>{L[e]&&(clearInterval(L[e]),L[e]=void 0)}),Wi()},is=["did not allow mutations","called in an invalid security context"],ss=e=>{if(!e)return!0;for(const t of is)if(e.toLowerCase().includes(t))return!1;return!0},os=(e,t,{reportError:n=!0,extraInfo:i})=>{ie()||t instanceof Error&&(_n(),ss(t==null?void 0:t.message)&&(n&&window.UserLeap.reportError(e,t,i),b.clearAll()))},as=async(e,t,{reportError:n}={reportError:!0})=>{var r;let i;try{if(n&&((r=window.navigator.storage)!=null&&r.estimate)){const{quota:s=0,usage:o=0}=await window.navigator.storage.estimate();i={availableSpaceInMB:(s-o)/2**20,quota:s,usage:o}}}catch(s){window.UserLeap.reportError("Error getting storage estimate",s,{originalMessage:e,originalError:t})}os(e,t,{reportError:n,extraInfo:i})},$e=(e,t,{reportError:n}={reportError:!0})=>(Rn(),Pt(`${e} - ${JSON.stringify(t)}`),as(e,t,{reportError:n})),T=async(e,t)=>{try{await e()}catch(n){$e(t,n)}},ds=()=>{L.isRecording&&T(()=>{var e,t;return(t=(e=window.rrwebRecord)==null?void 0:e.takeFullSnapshot)==null?void 0:t.call(e,!0)},"Error recording full snapshot")},cs=async({surveyId:e,responseGroupUuid:t,eventDigest:n,headers:i})=>{if(!e||!t)return!1;const r=window.UserLeap._API_URL,s=await ln({surveyId:e,responseGroupUuid:t,eventDigest:n,apiUrl:r,headers:i},!0);return!(s!=null&&s.error)},Dn=30,ls=1;fn("replayStorage").catch(console.error),fn("sprig.replay").catch(console.error);class us{openDB(){return _i("sprigReplay",ls,{upgrade:(t,n,i)=>{if(i===0&&k.setItem("sprig.pendingCount","0"),!t.objectStoreNames.contains("events")){const r=t.createObjectStore("events",{keyPath:"uuid"});r.createIndex("sessionId","sessionId"),r.createIndex("timestamp","timestamp"),r.createIndex("[sessionId+timestamp]",["sessionId","timestamp"])}if(!t.objectStoreNames.contains("chunkUploads")){const r=t.createObjectStore("chunkUploads",{keyPath:"uuid"});r.createIndex("sessionId","sessionId"),r.createIndex("timestamp","timestamp"),r.createIndex("[sessionId+status]",["sessionId","status"]),r.createIndex("[uploadId+status]",["uploadId","status"]),r.createIndex("[sessionId+status+uploadId]",["sessionId","status","uploadId"])}if(!t.objectStoreNames.contains("pendingCaptures")){const r=t.createObjectStore("pendingCaptures",{keyPath:"uuid"});r.createIndex("sessionId","sessionId"),r.createIndex("timestamp","timestamp"),r.createIndex("[sessionId+targetTimestamp]",["sessionId","targetTimestamp"])}}}).catch(t=>(Pt(`Error opening replay storage: ${t.message}`),_n(),Promise.reject(t)))}constructor(){this.openDB()}async bulkAdd(t,n){const i=(await this.openDB()).transaction(t,"readwrite");return Promise.all([...n.map(r=>i.store.add(r)),i.done])}async clearAll(){const t=(await this.openDB()).transaction(["events","chunkUploads","pendingCaptures"],"readwrite");return Promise.all([t.objectStore("events").clear(),t.objectStore("chunkUploads").clear(),t.objectStore("pendingCaptures").clear()])}async deleteBySessionId(t,n){const i=IDBKeyRange.only(n),r=(await this.openDB()).transaction(t,"readwrite");let o=await r.store.index("sessionId").openCursor(i);for(;o;)o.delete(),o=await o.continue();await r.done}async updatePartial(t,n,i){const s=(await this.openDB()).transaction(t,"readwrite"),o=await s.store.get(n);o&&await s.store.put({...o,...i}),await s.done}async deleteRowsBefore(t,n,i=()=>!0){const r=IDBKeyRange.upperBound(n,!0),s=(await this.openDB()).transaction(t,"readwrite");let a=await s.store.index("timestamp").openCursor(r);for(;a;)i(a.value)&&a.delete(),a=await a.continue();await s.done}async getEventsBetween(t,n=Date.now()){if(t>=n)return Promise.resolve([]);const i=IDBKeyRange.bound([D,t],[D,n],!1,!0);return(await this.openDB()).getAllFromIndex("events","[sessionId+timestamp]",i)}async updateEventsExpiredAt(t,n,i=Dn){const r=new Date,s=r.setMinutes(r.getMinutes()+(i??Dn)),o=(await this.openDB()).transaction("events","readwrite"),a=o.store.index("[sessionId+timestamp]"),d=IDBKeyRange.bound([D,t],[D,n],!1,!0);let c=await a.openCursor(d);for(;c;)c.update({...c.value,expiredAt:s}),c=await c.continue();await o.done}async deleteChunkUploads(t,n){const i=IDBKeyRange.only([n,t]),r=(await this.openDB()).transaction("chunkUploads","readwrite");let o=await r.store.index("[uploadId+status]").openCursor(i);for(;o;)o.delete(),o=await o.continue();await r.done}async getChunkUploadsByStatus({sessionId:t,status:n,uploadId:i}){const s=(await this.openDB()).transaction("chunkUploads","readonly"),o=i?s.store.index("[uploadId+status]"):s.store.index("[sessionId+status]"),a=i?IDBKeyRange.only([i,n]):IDBKeyRange.only([t,n]);return o.getAll(a)}async getPendingCaptures(t={}){return(await(await this.openDB()).getAllFromIndex("pendingCaptures","sessionId",D)).filter(r=>!t.beforePresent||r.targetTimestamp<Date.now()).filter(r=>!t.isHeatmap||(r.captureParams.isHeatmap??!1))}async markPendingCaptureToCanUpload(t){const n=(await this.openDB()).transaction("pendingCaptures","readwrite");let r=await n.store.index("sessionId").openCursor(D);for(;r;){const s=r.value;s.captureParams.responseGroupId===t&&r.update({...s,canUpload:!0}),r=await r.continue()}await n.done}async markPendingHeatmapsReady(t){if(parseInt(k.getItem("sprig.pendingCount")??"0")===0)return null;const i=Date.now(),r=(await this.openDB()).transaction("pendingCaptures","readwrite");let o=await r.store.index("sessionId").openCursor(D);for(;o;){const a=o.value;a.captureParams.isHeatmap&&(!t||t.includes(a.uuid))&&o.update({...a,targetTimestamp:i,captureParams:{...a.captureParams,triggerTimestamp:i,replayParams:{...a.captureParams.replayParams,replayDurationSeconds:Math.floor((i-a.timestamp)/1e3)}}}),o=await o.continue()}await r.done}}const b=new us,ps=async(e,t,n)=>new Promise((i,r)=>{const s=e.createElement("script");s.src=t,s.onload=i,s.onerror=r,n&&(s.nonce=n),e.head.appendChild(s)}),xn=async(e,t)=>{const n=performance.now();let i;try{i=await e()}finally{const r=performance.now()-n;let s=ge[t];s||(s=V(t)),s.report(r/1e3)}return i},An=(e,t)=>{const n=performance.now();try{e()}finally{const i=performance.now()-n;let r=ge[t];r||(r=V(t)),r.report(i/1e3)}};let Cn=1,gt=5e3,Fe=6e4;const Tn=1e3,ws=5,Pn=30,Ve=Pn+ws;let On=Date.now(),X,yt=!!k.getItem("sprig.isCapturingHeatmap"),ht=!1,vt=[];const fs=async({viewDocument:e,maxReplayDurationSeconds:t,replayNonce:n,maxInflightRequests:i=2,replaySettings:r,teardownAfter:s=!1})=>{X=k.getItem("sprig.pendingCount"),!L.isRecording&&(s&&k.setItem("sprig.teardownAfterCapture","true"),await T(async()=>{if(ie()){p("Not initializing replay because recording is disabled");return}if(!t){p("Not initializing replay because config didn't specify maxReplayDurationSeconds");return}if(r!=null&&r.minAvailableGb&&(Cn=r.minAvailableGb),!await zi(Cn)){ze("Minimum storage not available");return}if(p("Initializing replay"),r!=null&&r.minDuration&&(gt=r.minDuration),r!=null&&r.batchDuration&&(Fe=r.batchDuration),vi(i),Ss(),hs(t+Ve,30*60,t+Ve),vs(),!window.rrwebRecord){p("Loading recording script");const c=window.UserLeap.replayLibraryURL??"https://cdn.sprig.com/dependencies/record-2.0.0-alpha.6.min.js";await ps(e,c,n),p("Recording script finished loading")}const o=window.rrwebRecord;if(!o){ze("Record script failed to set global function");return}let a=!0,d=0;L.stopRecording=o({checkoutEveryNms:Pn*1e3,sampling:{input:"last",scroll:250,media:800},emit:(c,l)=>{if(ie())return;if(On=Date.now(),l&&c.type===Me.Meta)d=performance.now();else if(l&&d&&c.type===Me.FullSnapshot){const y=performance.now()-d;Qt("sdk_replay_snapshot_seconds",y/1e3)}const u=a||!!l&&c.type===Me.Meta;a=!1,ms({uuid:oe(),event:JSON.stringify(c),isValidStart:u,timestamp:Date.now()})},...r}),L.isRecording=!!L.stopRecording,L.isRecording&&(L.noopInterval||(L.noopInterval=window.setInterval(()=>{Date.now()-On>Tn&&B("Sprig_Noop",{})},Tn)),m.on("survey.complete",c=>{Xi({id:c,userAgent:window.navigator.userAgent})}),Hi())},"Error initializing replay"))},ms=e=>{var t,n,i,r;if((t=e.event)!=null&&t.includes("Sprig_Scroll")){const s=(r=(i=(n=JSON.parse(e.event))==null?void 0:n.data)==null?void 0:i.payload)==null?void 0:r.xPath;if(!s)return;L.scrollEventUuids[s]=e.uuid}vt.push(e),ht||ys()},gs=async e=>{const t=e.map(n=>({...n,sessionId:n.sessionId??D}));if(yt&&Gi(t.length),t.length!==0)return T(()=>b.bulkAdd("events",t),"Error storing replay events")},ys=()=>{ht=!0,setTimeout(async()=>{if(ie())return;const e=vt;vt=[],ht=!1,An(async()=>{await gs(e)},"sdk_replay_add_event_batch_seconds")},500)},hs=(e,t,n)=>{L.cleanupInterval=window.setInterval(()=>{const i=Date.now();ie()||(ue(`Performing periodic replay data cleanup / Event Seconds ${e} / Chunk Seconds ${t} / Pending Capture Seconds ${n}`),xn(()=>T(async()=>{await Promise.all([b.deleteRowsBefore("events",i-e*1e3,r=>r.expiredAt===void 0||r.expiredAt<i-e*1e3),b.deleteRowsBefore("chunkUploads",i-t*1e3),b.deleteRowsBefore("pendingCaptures",i-n*1e3,r=>!r.canUpload)])},"Error deleting table rows"),"sdk_replay_cleanup_seconds"),p("Cleanup complete"))},3e4)},vs=()=>{L.pendingCheckInterval=window.setInterval(async()=>{T(async()=>{const e=parseInt(X??"0");if(e===0)return;const t=await b.getPendingCaptures({beforePresent:!0}),n=await b.openDB();await Promise.all(t.map(async i=>(await n.delete("pendingCaptures",i.uuid),Fn(i.captureParams,i.canUpload)))),X=(e-t.length).toString(),k.setItem("sprig.pendingCount",X)},"Error initiating pending captures")},5e3)},bs=async(e,t,n,i,r)=>{const s=Math.min(e+r,n),o=`from: ${new Date(e).toLocaleTimeString()} to ${new Date(s).toLocaleTimeString()}`;p(`Getting event batch ${o}`);const a=await xn(()=>b.getEventsBetween(e,s),"sdk_replay_get_events_between_seconds");if(!(a!=null&&a.length))return p(`No events found ${o}`),{validStartFound:i,events:[]};if(!i){p(`Searching for valid start in ${a.length} events ${o}`);let d=-1;if(a==null||a.forEach((l,u)=>{if(!l.isValidStart)return;const y=l.timestamp<=t;(d<0||y)&&(d=u)}),d<0)return p(`No valid start found in ${a.length} events ${o}`),{validStartFound:i,events:[]};const c=a[d].timestamp;return p(`Found valid start at: ${new Date(c).toLocaleTimeString()} in events ${o}`),{validStartFound:!0,events:a==null?void 0:a.slice(d)}}return{validStartFound:i,events:a}},Ls=(e,t,n)=>{const i=e.length,r=t*1024*1024,s=Math.ceil(i/n),o=Math.max(r,s);p(`Total file bytes: ${i} / target chunk size: ${o}`);const a=[];let d=0;for(;d<i;)a.push(e.slice(d,d+o)),d+=o;return a},Mn=e=>Promise.all(e.map(async t=>{const n=await bi(t);return await b.updatePartial("chunkUploads",t.uuid,{data:null,etag:n,status:"UploadComplete"}),t.uploadId})),Bn=async e=>{p(`Marking upload complete if finished: ${e}`);const t=await b.getChunkUploadsByStatus({status:"UploadComplete",uploadId:e});if(!(t!=null&&t.length)){p(`No finished chunks found for upload: ${e}`);return}const n=t.reduce((s,o)=>(s.find(a=>a.chunkIndex===o.chunkIndex)||s.push(o),s),[]);n.sort((s,o)=>s.chunkIndex-o.chunkIndex);const i=n.map(s=>({ETag:s.etag,PartNumber:s.chunkIndex})).filter(s=>s.ETag!==null),r=n[0];await ln({apiUrl:r.apiUrl,surveyId:r.surveyId,uploadId:e,responseGroupUuid:r.responseGroupId,etags:i,headers:r.completeUploadHeaders,replayDuration:r.replayDuration}),p(`Cleaning up chunks for ${e}`),await b.deleteChunkUploads("UploadComplete",e),p(`Done cleaning up chunks for ${e}`)},Ss=async()=>{T(async()=>{const e=await b.getChunkUploadsByStatus({sessionId:D,status:"ReadyForUpload"});if(!(e!=null&&e.length))return;const t=await Mn(e);p(`Finished uploading unfinished chunks for ${t}`),t!=null&&t.length&&await Promise.all(t.map(n=>{if(n)return Bn(n)}))},"Error uploading unfinished chunks")},Is=async(e,t)=>{await Mn(t),p(`Done uploading chunks for uploads: ${e.join(",")}`),await Promise.all(e.map(n=>Bn(n)))},Us=e=>{let t=0;e.forEach(r=>{t+=r.length});const n=new Uint8Array(t);let i=0;return e.forEach(r=>{n.set(r,i),i+=r.length}),n},Nn=async(e,t,n)=>{const i=new TextEncoder;let r=null,s=null,o=null,a=!1,d=!1,[c,l]=[0,0];const u=e-Ve*1e3,y=[];let w=[];p(`Getting events between ${new Date(e).toLocaleTimeString()} and ${new Date(t).toLocaleTimeString()}`),p(`Using batch duration: ${Fe}ms`);for(let h=u;h<t;h+=Fe){if({validStartFound:d,events:w}=await bs(h,e,t,d,Fe),!(w!=null&&w.length)){p("No events found");continue}c===0&&(c=w[0].timestamp),l=w[w.length-1].timestamp,p(`Last event time in batch: ${new Date(l).toLocaleTimeString()}`);const x=`${a?",":"["}${w.map(U=>U.event).join(",")}`,H=i.encode(x);n&&s===null&&(ue("Attempting compression"),o=new window.CompressionStream("gzip"),s=o.writable.getWriter()),An(()=>{n&&s?s.write(H):y.push(H)},"sdk_replay_compression_seconds"),a=!0}if(l-c<gt)return p(`Replay duration is shorter than minimum of ${gt}ms / Start:${c} / End:${l}`),null;const g=i.encode("]");return ue("Writing final close brace"),s&&o?(s.write(g),s.close(),r=new Uint8Array(await new Response(o.readable).arrayBuffer())):(y.push(g),r=Us(y)),p("Finished generating file data"),r},Es=async(e,t)=>{const n=window.CompressionStream!==void 0;let i=null;const r=t??Date.now(),s=r-e;try{i=await Nn(s,r,n)}catch(o){o instanceof Error&&window.UserLeap.reportError("Error compressing replay",o),n&&T(async()=>{await Nn(s,r,!1)},"fileData fallback failed")}return i},$n=async e=>{const{surveyId:t,responseGroupId:n,visitorId:i,apiUrl:r,completeUploadHeaders:s,replayParams:o,triggerTimestamp:a}=e,d=await Es(o.replayDurationSeconds*1e3,a);if(d!=null&&d.length)p(`Found file data for survey: ${t}`);else{p(`File data is empty for survey: ${t}`);return}const c=Ls(d,o.minimumChunkSizeMb,o.signedUrls.length);p(`Got ${c.length} chunks for survey: ${t}`);const l=await Promise.all(c.map(async(u,y)=>{const w=oe(),g={apiUrl:r,chunkIndex:y+1,completeUploadHeaders:s,etag:null,responseGroupId:n,status:"ReadyForUpload",surveyId:t,timestamp:a,totalChunks:c.length,data:u,uploadId:o.uploadId,uploadUrl:o.signedUrls[y].url,uuid:w,visitorId:i};return p(`Recording chunk upload: ${JSON.stringify({index:g.chunkIndex,surveyId:g.surveyId,uploadId:g.uploadId,size:u.length,id:w},null,2)}`),await(await b.openDB()).add("chunkUploads",{...g,sessionId:g.sessionId??D}),p(`Done creating chunk upload: ${w}`),g}));p(`All chunk records created. Beginning upload for survey: ${t}`),await Is([o.uploadId],l)},Fn=async(e,t)=>{if(p(`Attempting replay capture: ${JSON.stringify({isStandalone:e.isStandalone,duration:e.replayParams.replayDurationSeconds,type:e.replayParams.replayDurationType,responseGroupId:e.responseGroupId,surveyId:e.surveyId,triggerTimestamp:e.triggerTimestamp,visitorId:e.visitorId},null,2)}`),ie())return p(`Replay recording is disabled: ${e.surveyId}`);p(`Replay recording enabled: ${e.surveyId}`);const{isHeatmap:n,isStandalone:i,replayParams:r,triggerTimestamp:s,responseGroupId:o}=e,a=async()=>{setTimeout(()=>m.removeListener(f.QuestionAnswered,a),0),T(async()=>{r.replayDurationType==="before"?await $n(e):await b.markPendingCaptureToCanUpload(o)},"Error in schedule/capture callback")};T(async()=>{if(r.replayDurationType==="after"||r.replayDurationType==="beforeAndAfter"){!i&&!n&&(p("Attaching QuestionAnswered listener for non-standalone replay"),m.on(f.QuestionAnswered,a)),p(`Scheduling capture for replay of type: ${r.replayDurationType}`),await Hn(e);return}if(i||n||t)p(`Proceeding to capture replay for survey: ${e.surveyId} / standalone? ${i} / canUpload? ${t}`),await $n(e),n&&ks();else{const c=Ve+r.replayDurationSeconds,l=s-c*1e3,u=s;p(`Setting expiry minutes to ${r.expirationTimeLimitMinutes} for events from ${new Date(l).toLocaleTimeString()} to ${new Date(u).toLocaleTimeString()}`),await b.updateEventsExpiredAt(l,u,r.expirationTimeLimitMinutes),p("Attaching QuestionAnswered listener"),m.on(f.QuestionAnswered,a)}},"Error in scheduling/capturing replay")},ks=async()=>{parseInt(X??"0")||(k.removeItem("sprig.isCapturingHeatmap"),yt=!1),k.getItem("sprig.teardownAfterCapture")&&(Rn(),Vn(),k.removeItem("sprig.teardownAfterCapture"))},Vn=()=>{if(ie()){ue("Not clearing user data, replay is disabled");return}return Promise.all([b.deleteBySessionId("events",D),b.deleteBySessionId("pendingCaptures",D)]).catch(e=>{$e("Error clearing user replay data",e)})},Hn=async e=>{p(`Scheduling replay capture: ${JSON.stringify(e)}`);const{isHeatmap:t,surveyId:n}=e,i=await b.getPendingCaptures(),r=i==null?void 0:i.filter(d=>d.captureParams.surveyId===n);if(r!=null&&r.length){p(`Pending capture exists for survey: ${n}`);return}t&&(ds(),yt=!0,k.setItem("sprig.isCapturingHeatmap","true"));const s={...e,replayParams:{...e.replayParams}};e.replayParams.replayDurationType==="beforeAndAfter"&&(s.replayParams.replayDurationSeconds*=2),s.replayParams.replayDurationType="before";const o=e.triggerTimestamp+e.replayParams.replayDurationSeconds*1e3;s.triggerTimestamp=o,X=(parseInt(X??"0")+1).toString(),k.setItem("sprig.pendingCount",X),await(await b.openDB()).add("pendingCaptures",{canUpload:!1,captureParams:s,sessionId:D,targetTimestamp:o,timestamp:Date.now(),uuid:oe()})};sr(Object.freeze(Object.defineProperty({__proto__:null,RecordEvent:Yi,RecordPageView:Ki,RecordSurveyShown:Qi,_completeSessionReplay:cs,checkPendingHeatmapsUrl:qi,clearUserReplayData:Vn,disableRecording:$e,initializeReplay:fs,isReplayRecording:rs,scheduleCapture:Hn,scheduleOrCaptureReplay:Fn},Symbol.toStringTag,{value:"Module"})));const _s="sprig-web-view-sdk";let Wn;Wn={path:`https://cdn.sprig.com/${_s}-v2.31.0.js`},yi(Wn)})();
